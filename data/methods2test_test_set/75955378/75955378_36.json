{"test_class": {"identifier": "ArraySplitOperationTest", "superclass": "extends OperationTest", "interfaces": "", "fields": [], "file": "operations/src/test/java/com/nextdoor/bender/operation/json/array/ArraySplitOperationTest.java"}, "test_case": {"identifier": "testArraySplitWithFieldsToKeep", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n  public void testArraySplitWithFieldsToKeep() throws IOException {\n    TestContext t = new TestContext();\n    t.setFunctionName(\"foo\");\n    LambdaContext lctx = new LambdaContext(t);\n\n    JsonElement input = JsonParser.parseString(getResourceString(\"array_input_kinesis_format.json\"));\n    GenericJsonEvent devent = new GenericJsonEvent(input.getAsJsonObject());\n    List<String> fieldsToKeep = Arrays.asList(\"owner\", \"logGroup\", \"logStream\");\n    ArraySplitOperation operation = new ArraySplitOperation(\"$.logEvents\", fieldsToKeep);\n\n    InternalEvent ievent = new InternalEvent(\"\", lctx, 123);\n    ievent.setEventObj(devent);\n    ievent.setEventTime(124);\n    List<InternalEvent> events = operation.perform(ievent);\n\n    assertEquals(4, events.size());\n    JsonElement actual = JsonParser.parseString(events.get(0).getEventString());\n    assertTrue(actual.getAsJsonObject().has(\"owner\"));\n    assertTrue(actual.getAsJsonObject().has(\"logGroup\"));\n    assertTrue(actual.getAsJsonObject().has(\"logStream\"));\n    assertTrue(actual.getAsJsonObject().has(\"id\"));\n    assertTrue(actual.getAsJsonObject().has(\"message\"));\n    assertTrue(actual.getAsJsonObject().has(\"timestamp\"));\n\n    actual = JsonParser.parseString(events.get(1).getEventString());\n    assertTrue(actual.getAsJsonObject().has(\"owner\"));\n    assertTrue(actual.getAsJsonObject().has(\"logGroup\"));\n    assertTrue(actual.getAsJsonObject().has(\"logStream\"));\n    assertTrue(actual.getAsJsonObject().has(\"id\"));\n    assertTrue(actual.getAsJsonObject().has(\"message\"));\n    assertTrue(actual.getAsJsonObject().has(\"timestamp\"));\n\n    actual = JsonParser.parseString(events.get(2).getEventString());\n    assertTrue(actual.getAsJsonObject().has(\"owner\"));\n    assertTrue(actual.getAsJsonObject().has(\"logGroup\"));\n    assertTrue(actual.getAsJsonObject().has(\"logStream\"));\n    assertTrue(actual.getAsJsonObject().has(\"id\"));\n    assertTrue(actual.getAsJsonObject().has(\"message\"));\n    assertTrue(actual.getAsJsonObject().has(\"timestamp\"));\n\n    actual = JsonParser.parseString(events.get(3).getEventString());\n    assertTrue(actual.getAsJsonObject().has(\"owner\"));\n    assertTrue(actual.getAsJsonObject().has(\"logGroup\"));\n    assertTrue(actual.getAsJsonObject().has(\"logStream\"));\n    assertTrue(actual.getAsJsonObject().has(\"id\"));\n    assertTrue(actual.getAsJsonObject().has(\"message\"));\n    assertTrue(actual.getAsJsonObject().has(\"timestamp\"));\n  }", "signature": "void testArraySplitWithFieldsToKeep()", "full_signature": "@Test public void testArraySplitWithFieldsToKeep()", "class_method_signature": "ArraySplitOperationTest.testArraySplitWithFieldsToKeep()", "testcase": true, "constructor": false, "invocations": ["setFunctionName", "parseString", "getResourceString", "getAsJsonObject", "asList", "setEventObj", "setEventTime", "perform", "assertEquals", "size", "parseString", "getEventString", "get", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "parseString", "getEventString", "get", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "parseString", "getEventString", "get", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "parseString", "getEventString", "get", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject", "assertTrue", "has", "getAsJsonObject"]}, "focal_class": {"identifier": "ArraySplitOperation", "superclass": "", "interfaces": "implements MultiplexOperation", "fields": [{"original_string": "private final String path;", "modifier": "private final", "type": "String", "declarator": "path", "var_name": "path"}, {"original_string": "private final List<String> fieldsToKeep;", "modifier": "private final", "type": "List<String>", "declarator": "fieldsToKeep", "var_name": "fieldsToKeep"}], "methods": [{"identifier": "ArraySplitOperation", "parameters": "(String path)", "modifiers": "public", "return": "", "signature": " ArraySplitOperation(String path)", "full_signature": "public  ArraySplitOperation(String path)", "class_method_signature": "ArraySplitOperation.ArraySplitOperation(String path)", "testcase": false, "constructor": true}, {"identifier": "ArraySplitOperation", "parameters": "(String path,\n                             List<String> fieldsToKeep)", "modifiers": "public", "return": "", "signature": " ArraySplitOperation(String path,\n                             List<String> fieldsToKeep)", "full_signature": "public  ArraySplitOperation(String path,\n                             List<String> fieldsToKeep)", "class_method_signature": "ArraySplitOperation.ArraySplitOperation(String path,\n                             List<String> fieldsToKeep)", "testcase": false, "constructor": true}, {"identifier": "perform", "parameters": "(InternalEvent ievent)", "modifiers": "@Override public", "return": "List<InternalEvent>", "signature": "List<InternalEvent> perform(InternalEvent ievent)", "full_signature": "@Override public List<InternalEvent> perform(InternalEvent ievent)", "class_method_signature": "ArraySplitOperation.perform(InternalEvent ievent)", "testcase": false, "constructor": false}], "file": "operations/src/main/java/com/nextdoor/bender/operation/json/array/ArraySplitOperation.java"}, "focal_method": {"identifier": "perform", "parameters": "(InternalEvent ievent)", "modifiers": "@Override public", "return": "List<InternalEvent>", "body": "@Override\n  public List<InternalEvent> perform(InternalEvent ievent) throws OperationException {\n    {\n      if (ievent.getEventObj() == null) {\n        throw new OperationException(\"Deserialized object is null\");\n      }\n\n      Object payload;\n      try {\n        payload = ievent.getEventObj().getField(this.path);\n      } catch (FieldNotFoundException e) {\n        throw new OperationException(e);\n      }\n\n      if (!(payload instanceof JsonArray)) {\n        throw new OperationException(\"Payload data is not a JsonArray\");\n      }\n\n      LinkedHashMap<String, String> partitions = ievent.getPartitions();\n\n      JsonArray arr = (JsonArray) payload;\n\n      ArrayList<InternalEvent> output = new ArrayList<InternalEvent>();\n      for (JsonElement elm : arr) {\n        try {\n          JsonObject newObject = elm.getAsJsonObject();\n          for (String field : this.fieldsToKeep) {\n            JsonObject jsonObject = (JsonObject) ievent.getEventObj().getPayload();\n            newObject.add(field, jsonObject.get(field));\n          }\n\n          InternalEvent newEvent = new InternalEvent(newObject.toString(), ievent.getCtx(), ievent.getArrivalTime());\n          DeserializedEvent newDeserEvent = new GenericJsonEvent(newObject);\n          newEvent.setEventObj(newDeserEvent);\n          newEvent.setEventTime(ievent.getEventTime());\n\n          /*\n           * Deep clone the partitions\n           */\n          if (partitions != null) {\n            LinkedHashMap<String, String> newPartitions =\n                new LinkedHashMap<String, String>(partitions.size());\n\n            partitions.entrySet().forEach(kv -> {\n              newPartitions.put(new String(kv.getKey()), new String(kv.getValue()));\n            });\n\n            newEvent.setPartitions(newPartitions);\n          }\n\n          output.add(newEvent);\n        } catch (Exception e) {\n          throw new OperationException(e);\n        }\n      }\n\n      return output;\n    }\n  }", "signature": "List<InternalEvent> perform(InternalEvent ievent)", "full_signature": "@Override public List<InternalEvent> perform(InternalEvent ievent)", "class_method_signature": "ArraySplitOperation.perform(InternalEvent ievent)", "testcase": false, "constructor": false, "invocations": ["getEventObj", "getField", "getEventObj", "getPartitions", "getAsJsonObject", "getPayload", "getEventObj", "add", "get", "toString", "getCtx", "getArrivalTime", "setEventObj", "setEventTime", "getEventTime", "size", "forEach", "entrySet", "put", "getKey", "getValue", "setPartitions", "add"]}, "repository": {"repo_id": 75955378, "url": "https://github.com/Nextdoor/bender", "language": "Java", "is_fork": false, "fork_count": 15, "stargazer_count": 163, "size": 1503, "license": "licensed"}}