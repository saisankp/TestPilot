{"test_class": {"identifier": "ComparisonExecutorTest", "superclass": "", "interfaces": "", "fields": [], "file": "spark-job/src/test/java/org/apache/cassandra/diff/ComparisonExecutorTest.java"}, "test_case": {"identifier": "handleRejectedExecutionException", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void handleRejectedExecutionException() {\n        // In the case that the underlying ExecutorService rejects a task submission, a permit\n        // should be returned and the phaser notified\n        int maxTasks = 5;\n        final AtomicInteger successful = new AtomicInteger(0);\n        final AtomicInteger failures = new AtomicInteger(0);\n        final AtomicInteger rejections = new AtomicInteger(0);\n        final Consumer<Integer> onSuccess = (i) ->  successful.incrementAndGet();\n        final Consumer<Throwable> onError =  (t) -> failures.incrementAndGet();\n\n        MetricRegistry metrics = metrics();\n        ExecutorService rejectingExecutor = new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS,\n                                                                   new LinkedBlockingQueue<>(1),\n                                                                   (r, executor) -> { rejections.incrementAndGet();\n                                                                                      throw new RejectedExecutionException(\"REJECTED\");});\n\n        ComparisonExecutor executor = new ComparisonExecutor(MoreExecutors.listeningDecorator(rejectingExecutor), maxTasks, metrics);\n        Gauge availableSlots = metrics.getGauges().get(\"AvailableSlots\");\n        final Phaser phaser = new Phaser(1);\n\n        // Submit an initial pair of tasks to ensure that the underlying work queue is full\n        BlockingTask t0 = new BlockingTask(0);\n        BlockingTask t1 = new BlockingTask(1);\n        executor.submit(t0, onSuccess, onError, phaser);\n        executor.submit(t1, onSuccess, onError, phaser);\n        assertEquals(3, phaser.getUnarrivedParties());\n        assertEquals(maxTasks - 2, availableSlots.getValue());\n\n        // Submit a third task which will be rejected by the executor service\n        executor.submit(new BlockingTask(2), onSuccess, onError, phaser);\n        t0.latch.countDown();\n        t1.latch.countDown();\n\n        phaser.arriveAndAwaitAdvance();\n        assertEquals(maxTasks, availableSlots.getValue());\n        assertEquals(2, successful.get());\n        assertEquals(1, failures.get());\n        assertEquals(1, rejections.get());\n    }", "signature": "void handleRejectedExecutionException()", "full_signature": "@Test public void handleRejectedExecutionException()", "class_method_signature": "ComparisonExecutorTest.handleRejectedExecutionException()", "testcase": true, "constructor": false, "invocations": ["incrementAndGet", "incrementAndGet", "metrics", "incrementAndGet", "listeningDecorator", "get", "getGauges", "submit", "submit", "assertEquals", "getUnarrivedParties", "assertEquals", "getValue", "submit", "countDown", "countDown", "arriveAndAwaitAdvance", "assertEquals", "getValue", "assertEquals", "get", "assertEquals", "get", "assertEquals", "get"]}, "focal_class": {"identifier": "ComparisonExecutor", "superclass": "", "interfaces": "", "fields": [{"original_string": "private final ListeningExecutorService executor;", "modifier": "private final", "type": "ListeningExecutorService", "declarator": "executor", "var_name": "executor"}, {"original_string": "private final Semaphore semaphore;", "modifier": "private final", "type": "Semaphore", "declarator": "semaphore", "var_name": "semaphore"}], "methods": [{"identifier": "newExecutor", "parameters": "(int maxConcurrentTasks, MetricRegistry metricRegistry)", "modifiers": "static", "return": "ComparisonExecutor", "signature": "ComparisonExecutor newExecutor(int maxConcurrentTasks, MetricRegistry metricRegistry)", "full_signature": "static ComparisonExecutor newExecutor(int maxConcurrentTasks, MetricRegistry metricRegistry)", "class_method_signature": "ComparisonExecutor.newExecutor(int maxConcurrentTasks, MetricRegistry metricRegistry)", "testcase": false, "constructor": false}, {"identifier": "ComparisonExecutor", "parameters": "(ListeningExecutorService executor, int maxTasks, MetricRegistry metrics)", "modifiers": "@VisibleForTesting", "return": "", "signature": " ComparisonExecutor(ListeningExecutorService executor, int maxTasks, MetricRegistry metrics)", "full_signature": "@VisibleForTesting  ComparisonExecutor(ListeningExecutorService executor, int maxTasks, MetricRegistry metrics)", "class_method_signature": "ComparisonExecutor.ComparisonExecutor(ListeningExecutorService executor, int maxTasks, MetricRegistry metrics)", "testcase": false, "constructor": true}, {"identifier": "submit", "parameters": "(final Callable<T> callable,\n                           final Consumer<T> onSuccess,\n                           final Consumer<Throwable> onError,\n                           final Phaser phaser)", "modifiers": "public", "return": "void", "signature": "void submit(final Callable<T> callable,\n                           final Consumer<T> onSuccess,\n                           final Consumer<Throwable> onError,\n                           final Phaser phaser)", "full_signature": "public void submit(final Callable<T> callable,\n                           final Consumer<T> onSuccess,\n                           final Consumer<Throwable> onError,\n                           final Phaser phaser)", "class_method_signature": "ComparisonExecutor.submit(final Callable<T> callable,\n                           final Consumer<T> onSuccess,\n                           final Consumer<Throwable> onError,\n                           final Phaser phaser)", "testcase": false, "constructor": false}, {"identifier": "fireThenReleaseAndArrive", "parameters": "(Consumer<T> callback, T argument, Phaser phaser)", "modifiers": "private", "return": "void", "signature": "void fireThenReleaseAndArrive(Consumer<T> callback, T argument, Phaser phaser)", "full_signature": "private void fireThenReleaseAndArrive(Consumer<T> callback, T argument, Phaser phaser)", "class_method_signature": "ComparisonExecutor.fireThenReleaseAndArrive(Consumer<T> callback, T argument, Phaser phaser)", "testcase": false, "constructor": false}, {"identifier": "shutdown", "parameters": "()", "modifiers": "public", "return": "void", "signature": "void shutdown()", "full_signature": "public void shutdown()", "class_method_signature": "ComparisonExecutor.shutdown()", "testcase": false, "constructor": false}], "file": "spark-job/src/main/java/org/apache/cassandra/diff/ComparisonExecutor.java"}, "focal_method": {"identifier": "submit", "parameters": "(final Callable<T> callable,\n                           final Consumer<T> onSuccess,\n                           final Consumer<Throwable> onError,\n                           final Phaser phaser)", "modifiers": "public", "return": "void", "body": "public <T> void submit(final Callable<T> callable,\n                           final Consumer<T> onSuccess,\n                           final Consumer<Throwable> onError,\n                           final Phaser phaser) {\n\n        phaser.register();\n        semaphore.acquireUninterruptibly();\n        try {\n            Futures.addCallback(executor.submit(callable), new FutureCallback<T>() {\n                public void onSuccess(T result) {\n                    fireThenReleaseAndArrive(onSuccess, result, phaser);\n                }\n\n                public void onFailure(Throwable t) {\n                    fireThenReleaseAndArrive(onError, t, phaser);\n                }\n            }, MoreExecutors.directExecutor());\n\n        } catch (RejectedExecutionException e) {\n            fireThenReleaseAndArrive(onError, e, phaser);\n        }\n\n    }", "signature": "void submit(final Callable<T> callable,\n                           final Consumer<T> onSuccess,\n                           final Consumer<Throwable> onError,\n                           final Phaser phaser)", "full_signature": "public void submit(final Callable<T> callable,\n                           final Consumer<T> onSuccess,\n                           final Consumer<Throwable> onError,\n                           final Phaser phaser)", "class_method_signature": "ComparisonExecutor.submit(final Callable<T> callable,\n                           final Consumer<T> onSuccess,\n                           final Consumer<Throwable> onError,\n                           final Phaser phaser)", "testcase": false, "constructor": false, "invocations": ["register", "acquireUninterruptibly", "addCallback", "submit", "fireThenReleaseAndArrive", "fireThenReleaseAndArrive", "directExecutor", "fireThenReleaseAndArrive"]}, "repository": {"repo_id": 204657216, "url": "https://github.com/apache/cassandra-diff", "language": "Java", "is_fork": false, "fork_count": 9, "stargazer_count": 5, "size": 112, "license": "licensed"}}