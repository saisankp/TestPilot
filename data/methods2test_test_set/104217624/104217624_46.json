{"test_class": {"identifier": "XodusIxMapTest", "superclass": "extends IxMapTest", "interfaces": "", "fields": [{"original_string": "@Rule\n    public final TemporaryFolder tmp = new TemporaryFolder();", "modifier": "@Rule\n    public final", "type": "TemporaryFolder", "declarator": "tmp = new TemporaryFolder()", "var_name": "tmp"}, {"original_string": "private Xodus xodus;", "modifier": "private", "type": "Xodus", "declarator": "xodus", "var_name": "xodus"}], "file": "rpki-validator/src/test/java/net/ripe/rpki/validator3/storage/xodus/XodusIxMapTest.java"}, "test_case": {"identifier": "testKeySize", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void testKeySize() {\n        final String s = randomString(new Random(), 2000);\n        wtx0(tx -> ixMap.put(tx, Key.of(s), s));\n    }", "signature": "void testKeySize()", "full_signature": "@Test public void testKeySize()", "class_method_signature": "XodusIxMapTest.testKeySize()", "testcase": true, "constructor": false, "invocations": ["randomString", "wtx0", "put", "of"]}, "focal_class": {"identifier": "XodusIxMap", "superclass": "extends XodusIxBase<T>", "interfaces": "implements IxMap<T>", "fields": [{"original_string": "private final Map<String, Store> indexes;", "modifier": "private final", "type": "Map<String, Store>", "declarator": "indexes", "var_name": "indexes"}, {"original_string": "private final Map<String, Function<T, Set<Key>>> indexFunctions;", "modifier": "private final", "type": "Map<String, Function<T, Set<Key>>>", "declarator": "indexFunctions", "var_name": "indexFunctions"}, {"original_string": "private final List<BiConsumer<Tx.Write, Key>> onDeleteTriggers = new ArrayList<>();", "modifier": "private final", "type": "List<BiConsumer<Tx.Write, Key>>", "declarator": "onDeleteTriggers = new ArrayList<>()", "var_name": "onDeleteTriggers"}], "methods": [{"identifier": "XodusIxMap", "parameters": "(final Xodus xodus,\n                      final String name,\n                      final Coder<T> coder,\n                      final Map<String, Function<T, Set<Key>>> indexFunctions)", "modifiers": "public", "return": "", "signature": " XodusIxMap(final Xodus xodus,\n                      final String name,\n                      final Coder<T> coder,\n                      final Map<String, Function<T, Set<Key>>> indexFunctions)", "full_signature": "public  XodusIxMap(final Xodus xodus,\n                      final String name,\n                      final Coder<T> coder,\n                      final Map<String, Function<T, Set<Key>>> indexFunctions)", "class_method_signature": "XodusIxMap.XodusIxMap(final Xodus xodus,\n                      final String name,\n                      final Coder<T> coder,\n                      final Map<String, Function<T, Set<Key>>> indexFunctions)", "testcase": false, "constructor": true}, {"identifier": "reindex", "parameters": "()", "modifiers": "private", "return": "void", "signature": "void reindex()", "full_signature": "private void reindex()", "class_method_signature": "XodusIxMap.reindex()", "testcase": false, "constructor": false}, {"identifier": "getIdx", "parameters": "(String name)", "modifiers": "private", "return": "Store", "signature": "Store getIdx(String name)", "full_signature": "private Store getIdx(String name)", "class_method_signature": "XodusIxMap.getIdx(String name)", "testcase": false, "constructor": false}, {"identifier": "dropIndexes", "parameters": "(Tx.Write tx)", "modifiers": "private", "return": "void", "signature": "void dropIndexes(Tx.Write tx)", "full_signature": "private void dropIndexes(Tx.Write tx)", "class_method_signature": "XodusIxMap.dropIndexes(Tx.Write tx)", "testcase": false, "constructor": false}, {"identifier": "getStoreConfig", "parameters": "()", "modifiers": "protected", "return": "StoreConfig", "signature": "StoreConfig getStoreConfig()", "full_signature": "protected StoreConfig getStoreConfig()", "class_method_signature": "XodusIxMap.getStoreConfig()", "testcase": false, "constructor": false}, {"identifier": "get", "parameters": "(Key primaryKey)", "modifiers": "public", "return": "Optional<T>", "signature": "Optional<T> get(Key primaryKey)", "full_signature": "public Optional<T> get(Key primaryKey)", "class_method_signature": "XodusIxMap.get(Key primaryKey)", "testcase": false, "constructor": false}, {"identifier": "get", "parameters": "(Tx.Read tx, Key primaryKey)", "modifiers": "public", "return": "Optional<T>", "signature": "Optional<T> get(Tx.Read tx, Key primaryKey)", "full_signature": "public Optional<T> get(Tx.Read tx, Key primaryKey)", "class_method_signature": "XodusIxMap.get(Tx.Read tx, Key primaryKey)", "testcase": false, "constructor": false}, {"identifier": "get", "parameters": "(Tx.Read txn, Set<Key> primaryKeys)", "modifiers": "public", "return": "List<T>", "signature": "List<T> get(Tx.Read txn, Set<Key> primaryKeys)", "full_signature": "public List<T> get(Tx.Read txn, Set<Key> primaryKeys)", "class_method_signature": "XodusIxMap.get(Tx.Read txn, Set<Key> primaryKeys)", "testcase": false, "constructor": false}, {"identifier": "put", "parameters": "(Tx.Write tx, Key primaryKey, T value)", "modifiers": "public", "return": "Optional<T>", "signature": "Optional<T> put(Tx.Write tx, Key primaryKey, T value)", "full_signature": "public Optional<T> put(Tx.Write tx, Key primaryKey, T value)", "class_method_signature": "XodusIxMap.put(Tx.Write tx, Key primaryKey, T value)", "testcase": false, "constructor": false}, {"identifier": "modify", "parameters": "(Tx.Write tx, Key primaryKey, Consumer<T> modifyValue)", "modifiers": "public", "return": "boolean", "signature": "boolean modify(Tx.Write tx, Key primaryKey, Consumer<T> modifyValue)", "full_signature": "public boolean modify(Tx.Write tx, Key primaryKey, Consumer<T> modifyValue)", "class_method_signature": "XodusIxMap.modify(Tx.Write tx, Key primaryKey, Consumer<T> modifyValue)", "testcase": false, "constructor": false}, {"identifier": "delete", "parameters": "(Tx.Write tx, Key primaryKey)", "modifiers": "public", "return": "void", "signature": "void delete(Tx.Write tx, Key primaryKey)", "full_signature": "public void delete(Tx.Write tx, Key primaryKey)", "class_method_signature": "XodusIxMap.delete(Tx.Write tx, Key primaryKey)", "testcase": false, "constructor": false}, {"identifier": "getByIndex", "parameters": "(String indexName, Tx.Read tx, Key indexKey)", "modifiers": "public", "return": "Map<Key, T>", "signature": "Map<Key, T> getByIndex(String indexName, Tx.Read tx, Key indexKey)", "full_signature": "public Map<Key, T> getByIndex(String indexName, Tx.Read tx, Key indexKey)", "class_method_signature": "XodusIxMap.getByIndex(String indexName, Tx.Read tx, Key indexKey)", "testcase": false, "constructor": false}, {"identifier": "values", "parameters": "(Tx.Read tx, Set<Key> pks)", "modifiers": "public", "return": "Map<Key, T>", "signature": "Map<Key, T> values(Tx.Read tx, Set<Key> pks)", "full_signature": "public Map<Key, T> values(Tx.Read tx, Set<Key> pks)", "class_method_signature": "XodusIxMap.values(Tx.Read tx, Set<Key> pks)", "testcase": false, "constructor": false}, {"identifier": "getPkByIndex", "parameters": "(String indexName, Tx.Read tx, Key indexKey)", "modifiers": "public", "return": "Set<Key>", "signature": "Set<Key> getPkByIndex(String indexName, Tx.Read tx, Key indexKey)", "full_signature": "public Set<Key> getPkByIndex(String indexName, Tx.Read tx, Key indexKey)", "class_method_signature": "XodusIxMap.getPkByIndex(String indexName, Tx.Read tx, Key indexKey)", "testcase": false, "constructor": false}, {"identifier": "getByIndexLessThan", "parameters": "(String indexName, Tx.Read tx, Key indexKey)", "modifiers": "public", "return": "Map<Key, T>", "signature": "Map<Key, T> getByIndexLessThan(String indexName, Tx.Read tx, Key indexKey)", "full_signature": "public Map<Key, T> getByIndexLessThan(String indexName, Tx.Read tx, Key indexKey)", "class_method_signature": "XodusIxMap.getByIndexLessThan(String indexName, Tx.Read tx, Key indexKey)", "testcase": false, "constructor": false}, {"identifier": "getByIndexNotLessThan", "parameters": "(String indexName, Tx.Read tx, Key indexKey)", "modifiers": "public", "return": "Map<Key, T>", "signature": "Map<Key, T> getByIndexNotLessThan(String indexName, Tx.Read tx, Key indexKey)", "full_signature": "public Map<Key, T> getByIndexNotLessThan(String indexName, Tx.Read tx, Key indexKey)", "class_method_signature": "XodusIxMap.getByIndexNotLessThan(String indexName, Tx.Read tx, Key indexKey)", "testcase": false, "constructor": false}, {"identifier": "getPkByIndexLessThan", "parameters": "(String indexName, Tx.Read tx, Key indexKey)", "modifiers": "public", "return": "Set<Key>", "signature": "Set<Key> getPkByIndexLessThan(String indexName, Tx.Read tx, Key indexKey)", "full_signature": "public Set<Key> getPkByIndexLessThan(String indexName, Tx.Read tx, Key indexKey)", "class_method_signature": "XodusIxMap.getPkByIndexLessThan(String indexName, Tx.Read tx, Key indexKey)", "testcase": false, "constructor": false}, {"identifier": "getPkByIndexGreaterThan", "parameters": "(String indexName, Tx.Read tx, Key indexKey)", "modifiers": "public", "return": "Set<Key>", "signature": "Set<Key> getPkByIndexGreaterThan(String indexName, Tx.Read tx, Key indexKey)", "full_signature": "public Set<Key> getPkByIndexGreaterThan(String indexName, Tx.Read tx, Key indexKey)", "class_method_signature": "XodusIxMap.getPkByIndexGreaterThan(String indexName, Tx.Read tx, Key indexKey)", "testcase": false, "constructor": false}, {"identifier": "getByIdxDescendingWhere", "parameters": "(String indexName, Tx.Read tx, Predicate<T> p)", "modifiers": "public", "return": "Map<Key, T>", "signature": "Map<Key, T> getByIdxDescendingWhere(String indexName, Tx.Read tx, Predicate<T> p)", "full_signature": "public Map<Key, T> getByIdxDescendingWhere(String indexName, Tx.Read tx, Predicate<T> p)", "class_method_signature": "XodusIxMap.getByIdxDescendingWhere(String indexName, Tx.Read tx, Predicate<T> p)", "testcase": false, "constructor": false}, {"identifier": "getByIdxAscendingWhere", "parameters": "(String indexName, Tx.Read tx, Predicate<T> p)", "modifiers": "public", "return": "Map<Key, T>", "signature": "Map<Key, T> getByIdxAscendingWhere(String indexName, Tx.Read tx, Predicate<T> p)", "full_signature": "public Map<Key, T> getByIdxAscendingWhere(String indexName, Tx.Read tx, Predicate<T> p)", "class_method_signature": "XodusIxMap.getByIdxAscendingWhere(String indexName, Tx.Read tx, Predicate<T> p)", "testcase": false, "constructor": false}, {"identifier": "getOrderedMapWhere", "parameters": "(String indexName, Tx.Read tx,\n                                           boolean ascending,\n                                           Predicate<T> predicate)", "modifiers": "private", "return": "Map<Key, T>", "signature": "Map<Key, T> getOrderedMapWhere(String indexName, Tx.Read tx,\n                                           boolean ascending,\n                                           Predicate<T> predicate)", "full_signature": "private Map<Key, T> getOrderedMapWhere(String indexName, Tx.Read tx,\n                                           boolean ascending,\n                                           Predicate<T> predicate)", "class_method_signature": "XodusIxMap.getOrderedMapWhere(String indexName, Tx.Read tx,\n                                           boolean ascending,\n                                           Predicate<T> predicate)", "testcase": false, "constructor": false}, {"identifier": "onDelete", "parameters": "(BiConsumer<Tx.Write, Key> bf)", "modifiers": "public", "return": "void", "signature": "void onDelete(BiConsumer<Tx.Write, Key> bf)", "full_signature": "public void onDelete(BiConsumer<Tx.Write, Key> bf)", "class_method_signature": "XodusIxMap.onDelete(BiConsumer<Tx.Write, Key> bf)", "testcase": false, "constructor": false}, {"identifier": "clear", "parameters": "(Tx.Write tx)", "modifiers": "@Override public", "return": "void", "signature": "void clear(Tx.Write tx)", "full_signature": "@Override public void clear(Tx.Write tx)", "class_method_signature": "XodusIxMap.clear(Tx.Write tx)", "testcase": false, "constructor": false}, {"identifier": "toValue", "parameters": "(byte[] bb)", "modifiers": "@Override public", "return": "T", "signature": "T toValue(byte[] bb)", "full_signature": "@Override public T toValue(byte[] bb)", "class_method_signature": "XodusIxMap.toValue(byte[] bb)", "testcase": false, "constructor": false}, {"identifier": "getPkByIndexKeyRange", "parameters": "(String indexName, Tx.Read tx, ByteIterable start, ByteIterable stop)", "modifiers": "private", "return": "Set<Key>", "signature": "Set<Key> getPkByIndexKeyRange(String indexName, Tx.Read tx, ByteIterable start, ByteIterable stop)", "full_signature": "private Set<Key> getPkByIndexKeyRange(String indexName, Tx.Read tx, ByteIterable start, ByteIterable stop)", "class_method_signature": "XodusIxMap.getPkByIndexKeyRange(String indexName, Tx.Read tx, ByteIterable start, ByteIterable stop)", "testcase": false, "constructor": false}, {"identifier": "sizeInfo", "parameters": "(Tx.Read tx)", "modifiers": "@Override public", "return": "XodusIxBase.Sizes", "signature": "XodusIxBase.Sizes sizeInfo(Tx.Read tx)", "full_signature": "@Override public XodusIxBase.Sizes sizeInfo(Tx.Read tx)", "class_method_signature": "XodusIxMap.sizeInfo(Tx.Read tx)", "testcase": false, "constructor": false}], "file": "rpki-validator/src/main/java/net/ripe/rpki/validator3/storage/xodus/XodusIxMap.java"}, "focal_method": {"identifier": "put", "parameters": "(Tx.Write tx, Key primaryKey, T value)", "modifiers": "public", "return": "Optional<T>", "body": "public Optional<T> put(Tx.Write tx, Key primaryKey, T value) {\n        checkKeyAndValue(primaryKey, value);\n        final Transaction txn = castTxn(tx);\n        final ByteIterable pkBuf = primaryKey.toByteIterable();\n        final ByteIterable newVal = valueWithChecksum(value);\n\n        final ByteIterable oldVal = getMainDb().get(txn, pkBuf);\n        if (newVal.equals(oldVal)) {\n            // Exact same value already exists in the database, no need to store it again\n            // or to update indexes.\n            return Optional.of(value);\n        }\n\n        getMainDb().put(txn, pkBuf, newVal);\n        if (oldVal != null) {\n            final T oldValue = getValue(primaryKey, Bytes.toBytes(oldVal));\n            indexFunctions.forEach((idxName, idxFun) -> {\n                final Set<Key> oldIndexKeys = idxFun.apply(oldValue);\n                final Set<Key> indexKeys = idxFun.apply(value).stream()\n                        .filter(Objects::nonNull)\n                        .collect(Collectors.toSet());\n                final Store index = getIdx(idxName);\n                oldIndexKeys.stream()\n                        .filter(oik -> !indexKeys.contains(oik))\n                        .forEach(oik -> {\n                            try (Cursor c = index.openCursor(txn)) {\n                                if (c.getSearchBoth(oik.toByteIterable(), pkBuf)) {\n                                    c.deleteCurrent();\n                                }\n                            }\n                        });\n\n                indexKeys.stream()\n                        .filter(ik -> !oldIndexKeys.contains(ik))\n                        .forEach(ik -> index.put(txn, ik.toByteIterable(), pkBuf));\n            });\n            return Optional.of(oldValue);\n        }\n        indexFunctions.forEach((idxName, idxFun) -> {\n            final Set<Key> indexKeys = idxFun.apply(value).stream()\n                    .filter(Objects::nonNull)\n                    .collect(Collectors.toSet());\n\n            indexKeys.forEach(ik -> getIdx(idxName).put(txn, ik.toByteIterable(), pkBuf));\n        });\n\n        return Optional.empty();\n    }", "signature": "Optional<T> put(Tx.Write tx, Key primaryKey, T value)", "full_signature": "public Optional<T> put(Tx.Write tx, Key primaryKey, T value)", "class_method_signature": "XodusIxMap.put(Tx.Write tx, Key primaryKey, T value)", "testcase": false, "constructor": false, "invocations": ["checkKeyAndValue", "castTxn", "toByteIterable", "valueWithChecksum", "get", "getMainDb", "equals", "of", "put", "getMainDb", "getValue", "toBytes", "forEach", "apply", "collect", "filter", "stream", "apply", "toSet", "getIdx", "forEach", "filter", "stream", "contains", "openCursor", "getSearchBoth", "toByteIterable", "deleteCurrent", "forEach", "filter", "stream", "contains", "put", "toByteIterable", "of", "forEach", "collect", "filter", "stream", "apply", "toSet", "forEach", "put", "getIdx", "toByteIterable", "empty"]}, "repository": {"repo_id": 104217624, "url": "https://github.com/RIPE-NCC/rpki-validator-3", "stars": 32, "created": "9/20/2017 1:15:05 PM +00:00", "updates": "2020-01-27T10:48:38+00:00", "fork": "False", "license": "licensed"}}