{"test_class": {"identifier": "GoogleCloudStorageGrpcReadChannelTest", "superclass": "", "interfaces": "", "fields": [{"original_string": "private static final String BUCKET_NAME = \"bucket-name\";", "modifier": "private static final", "type": "String", "declarator": "BUCKET_NAME = \"bucket-name\"", "var_name": "BUCKET_NAME"}, {"original_string": "private static final String OBJECT_NAME = \"object-name\";", "modifier": "private static final", "type": "String", "declarator": "OBJECT_NAME = \"object-name\"", "var_name": "OBJECT_NAME"}, {"original_string": "private static final long OBJECT_GENERATION = 7;", "modifier": "private static final", "type": "long", "declarator": "OBJECT_GENERATION = 7", "var_name": "OBJECT_GENERATION"}, {"original_string": "private static final int OBJECT_SIZE =\n      GoogleCloudStorageReadOptions.DEFAULT_MIN_RANGE_REQUEST_SIZE + 10;", "modifier": "private static final", "type": "int", "declarator": "OBJECT_SIZE =\n      GoogleCloudStorageReadOptions.DEFAULT_MIN_RANGE_REQUEST_SIZE + 10", "var_name": "OBJECT_SIZE"}, {"original_string": "private static final int DEFAULT_OBJECT_CRC32C = 185327488;", "modifier": "private static final", "type": "int", "declarator": "DEFAULT_OBJECT_CRC32C = 185327488", "var_name": "DEFAULT_OBJECT_CRC32C"}, {"original_string": "private static Object DEFAULT_OBJECT =\n      Object.newBuilder()\n          .setBucket(BUCKET_NAME)\n          .setName(OBJECT_NAME)\n          .setSize(OBJECT_SIZE)\n          .setCrc32C(UInt32Value.newBuilder().setValue(DEFAULT_OBJECT_CRC32C))\n          .setGeneration(OBJECT_GENERATION)\n          .build();", "modifier": "private static", "type": "Object", "declarator": "DEFAULT_OBJECT =\n      Object.newBuilder()\n          .setBucket(BUCKET_NAME)\n          .setName(OBJECT_NAME)\n          .setSize(OBJECT_SIZE)\n          .setCrc32C(UInt32Value.newBuilder().setValue(DEFAULT_OBJECT_CRC32C))\n          .setGeneration(OBJECT_GENERATION)\n          .build()", "var_name": "DEFAULT_OBJECT"}, {"original_string": "private static GetObjectRequest GET_OBJECT_REQUEST =\n      GetObjectRequest.newBuilder().setBucket(BUCKET_NAME).setObject(OBJECT_NAME).build();", "modifier": "private static", "type": "GetObjectRequest", "declarator": "GET_OBJECT_REQUEST =\n      GetObjectRequest.newBuilder().setBucket(BUCKET_NAME).setObject(OBJECT_NAME).build()", "var_name": "GET_OBJECT_REQUEST"}, {"original_string": "private static GetObjectMediaRequest GET_OBJECT_MEDIA_REQUEST =\n      GetObjectMediaRequest.newBuilder()\n          .setBucket(BUCKET_NAME)\n          .setObject(OBJECT_NAME)\n          .setGeneration(OBJECT_GENERATION)\n          .build();", "modifier": "private static", "type": "GetObjectMediaRequest", "declarator": "GET_OBJECT_MEDIA_REQUEST =\n      GetObjectMediaRequest.newBuilder()\n          .setBucket(BUCKET_NAME)\n          .setObject(OBJECT_NAME)\n          .setGeneration(OBJECT_GENERATION)\n          .build()", "var_name": "GET_OBJECT_MEDIA_REQUEST"}, {"original_string": "@Rule public final GrpcCleanupRule grpcCleanup = new GrpcCleanupRule();", "modifier": "@Rule public final", "type": "GrpcCleanupRule", "declarator": "grpcCleanup = new GrpcCleanupRule()", "var_name": "grpcCleanup"}, {"original_string": "private StorageBlockingStub stub;", "modifier": "private", "type": "StorageBlockingStub", "declarator": "stub", "var_name": "stub"}, {"original_string": "private FakeService fakeService;", "modifier": "private", "type": "FakeService", "declarator": "fakeService", "var_name": "fakeService"}, {"original_string": "private ExecutorService executor = Executors.newCachedThreadPool();", "modifier": "private", "type": "ExecutorService", "declarator": "executor = Executors.newCachedThreadPool()", "var_name": "executor"}], "file": "gcsio/src/test/java/com/google/cloud/hadoop/gcsio/GoogleCloudStorageGrpcReadChannelTest.java"}, "test_case": {"identifier": "readSingleChunkSucceeds", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n  public void readSingleChunkSucceeds() throws Exception {\n    fakeService.setObject(DEFAULT_OBJECT.toBuilder().setSize(100).build());\n    GoogleCloudStorageGrpcReadChannel readChannel = newReadChannel();\n\n    ByteBuffer buffer = ByteBuffer.allocate(100);\n    readChannel.read(buffer);\n\n    verify(fakeService, times(1)).getObject(eq(GET_OBJECT_REQUEST), any());\n    verify(fakeService, times(1)).getObjectMedia(eq(GET_OBJECT_MEDIA_REQUEST), any());\n    assertArrayEquals(fakeService.data.substring(0, 100).toByteArray(), buffer.array());\n  }", "signature": "void readSingleChunkSucceeds()", "full_signature": "@Test public void readSingleChunkSucceeds()", "class_method_signature": "GoogleCloudStorageGrpcReadChannelTest.readSingleChunkSucceeds()", "testcase": true, "constructor": false, "invocations": ["setObject", "build", "setSize", "toBuilder", "newReadChannel", "allocate", "read", "getObject", "verify", "times", "eq", "any", "getObjectMedia", "verify", "times", "eq", "any", "assertArrayEquals", "toByteArray", "substring", "array"]}, "focal_class": {"identifier": "GoogleCloudStorageGrpcReadChannel", "superclass": "", "interfaces": "implements SeekableByteChannel", "fields": [{"original_string": "private static final GoogleLogger logger = GoogleLogger.forEnclosingClass();", "modifier": "private static final", "type": "GoogleLogger", "declarator": "logger = GoogleLogger.forEnclosingClass()", "var_name": "logger"}, {"original_string": "private static final Duration READ_STREAM_TIMEOUT = Duration.ofMinutes(20);", "modifier": "private static final", "type": "Duration", "declarator": "READ_STREAM_TIMEOUT = Duration.ofMinutes(20)", "var_name": "READ_STREAM_TIMEOUT"}, {"original_string": "@Nullable CancellableContext requestContext;", "modifier": "@Nullable", "type": "CancellableContext", "declarator": "requestContext", "var_name": "requestContext"}, {"original_string": "Fadvise readStrategy;", "modifier": "", "type": "Fadvise", "declarator": "readStrategy", "var_name": "readStrategy"}, {"original_string": "private StorageBlockingStub stub;", "modifier": "private", "type": "StorageBlockingStub", "declarator": "stub", "var_name": "stub"}, {"original_string": "private String bucketName;", "modifier": "private", "type": "String", "declarator": "bucketName", "var_name": "bucketName"}, {"original_string": "private String objectName;", "modifier": "private", "type": "String", "declarator": "objectName", "var_name": "objectName"}, {"original_string": "private long objectGeneration;", "modifier": "private", "type": "long", "declarator": "objectGeneration", "var_name": "objectGeneration"}, {"original_string": "private long objectSize;", "modifier": "private", "type": "long", "declarator": "objectSize", "var_name": "objectSize"}, {"original_string": "private boolean channelIsOpen = true;", "modifier": "private", "type": "boolean", "declarator": "channelIsOpen = true", "var_name": "channelIsOpen"}, {"original_string": "private long position = 0;", "modifier": "private", "type": "long", "declarator": "position = 0", "var_name": "position"}, {"original_string": "private long bytesToSkipBeforeReading = 0;", "modifier": "private", "type": "long", "declarator": "bytesToSkipBeforeReading = 0", "var_name": "bytesToSkipBeforeReading"}, {"original_string": "@Nullable private ByteString bufferedContent = null;", "modifier": "@Nullable private", "type": "ByteString", "declarator": "bufferedContent = null", "var_name": "bufferedContent"}, {"original_string": "private int bufferedContentReadOffset = 0;", "modifier": "private", "type": "int", "declarator": "bufferedContentReadOffset = 0", "var_name": "bufferedContentReadOffset"}, {"original_string": "@Nullable private Iterator<GetObjectMediaResponse> resIterator = null;", "modifier": "@Nullable private", "type": "Iterator<GetObjectMediaResponse>", "declarator": "resIterator = null", "var_name": "resIterator"}, {"original_string": "private GoogleCloudStorageReadOptions readOptions;", "modifier": "private", "type": "GoogleCloudStorageReadOptions", "declarator": "readOptions", "var_name": "readOptions"}], "methods": [{"identifier": "GoogleCloudStorageGrpcReadChannel", "parameters": "(\n      StorageBlockingStub gcsGrpcBlockingStub,\n      String bucketName,\n      String objectName,\n      long objectGeneration,\n      long objectSize,\n      GoogleCloudStorageReadOptions readOptions)", "modifiers": "private", "return": "", "signature": " GoogleCloudStorageGrpcReadChannel(\n      StorageBlockingStub gcsGrpcBlockingStub,\n      String bucketName,\n      String objectName,\n      long objectGeneration,\n      long objectSize,\n      GoogleCloudStorageReadOptions readOptions)", "full_signature": "private  GoogleCloudStorageGrpcReadChannel(\n      StorageBlockingStub gcsGrpcBlockingStub,\n      String bucketName,\n      String objectName,\n      long objectGeneration,\n      long objectSize,\n      GoogleCloudStorageReadOptions readOptions)", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.GoogleCloudStorageGrpcReadChannel(\n      StorageBlockingStub gcsGrpcBlockingStub,\n      String bucketName,\n      String objectName,\n      long objectGeneration,\n      long objectSize,\n      GoogleCloudStorageReadOptions readOptions)", "testcase": false, "constructor": true}, {"identifier": "open", "parameters": "(\n      StorageBlockingStub stub,\n      String bucketName,\n      String objectName,\n      GoogleCloudStorageReadOptions readOptions)", "modifiers": "public static", "return": "GoogleCloudStorageGrpcReadChannel", "signature": "GoogleCloudStorageGrpcReadChannel open(\n      StorageBlockingStub stub,\n      String bucketName,\n      String objectName,\n      GoogleCloudStorageReadOptions readOptions)", "full_signature": "public static GoogleCloudStorageGrpcReadChannel open(\n      StorageBlockingStub stub,\n      String bucketName,\n      String objectName,\n      GoogleCloudStorageReadOptions readOptions)", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.open(\n      StorageBlockingStub stub,\n      String bucketName,\n      String objectName,\n      GoogleCloudStorageReadOptions readOptions)", "testcase": false, "constructor": false}, {"identifier": "convertError", "parameters": "(\n      StatusRuntimeException error, String bucketName, String objectName)", "modifiers": "private static", "return": "IOException", "signature": "IOException convertError(\n      StatusRuntimeException error, String bucketName, String objectName)", "full_signature": "private static IOException convertError(\n      StatusRuntimeException error, String bucketName, String objectName)", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.convertError(\n      StatusRuntimeException error, String bucketName, String objectName)", "testcase": false, "constructor": false}, {"identifier": "put", "parameters": "(ByteString source, int offset, int size, ByteBuffer dest)", "modifiers": "private static final", "return": "void", "signature": "void put(ByteString source, int offset, int size, ByteBuffer dest)", "full_signature": "private static final void put(ByteString source, int offset, int size, ByteBuffer dest)", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.put(ByteString source, int offset, int size, ByteBuffer dest)", "testcase": false, "constructor": false}, {"identifier": "readBufferedContentInto", "parameters": "(ByteBuffer byteBuffer)", "modifiers": "private", "return": "int", "signature": "int readBufferedContentInto(ByteBuffer byteBuffer)", "full_signature": "private int readBufferedContentInto(ByteBuffer byteBuffer)", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.readBufferedContentInto(ByteBuffer byteBuffer)", "testcase": false, "constructor": false}, {"identifier": "read", "parameters": "(ByteBuffer byteBuffer)", "modifiers": "@Override public", "return": "int", "signature": "int read(ByteBuffer byteBuffer)", "full_signature": "@Override public int read(ByteBuffer byteBuffer)", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.read(ByteBuffer byteBuffer)", "testcase": false, "constructor": false}, {"identifier": "requestObjectMedia", "parameters": "(OptionalLong bytesToRead)", "modifiers": "private", "return": "void", "signature": "void requestObjectMedia(OptionalLong bytesToRead)", "full_signature": "private void requestObjectMedia(OptionalLong bytesToRead)", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.requestObjectMedia(OptionalLong bytesToRead)", "testcase": false, "constructor": false}, {"identifier": "cancelCurrentRequest", "parameters": "()", "modifiers": "private", "return": "void", "signature": "void cancelCurrentRequest()", "full_signature": "private void cancelCurrentRequest()", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.cancelCurrentRequest()", "testcase": false, "constructor": false}, {"identifier": "moreServerContent", "parameters": "()", "modifiers": "private", "return": "boolean", "signature": "boolean moreServerContent()", "full_signature": "private boolean moreServerContent()", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.moreServerContent()", "testcase": false, "constructor": false}, {"identifier": "write", "parameters": "(ByteBuffer byteBuffer)", "modifiers": "@Override public", "return": "int", "signature": "int write(ByteBuffer byteBuffer)", "full_signature": "@Override public int write(ByteBuffer byteBuffer)", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.write(ByteBuffer byteBuffer)", "testcase": false, "constructor": false}, {"identifier": "position", "parameters": "()", "modifiers": "@Override public", "return": "long", "signature": "long position()", "full_signature": "@Override public long position()", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.position()", "testcase": false, "constructor": false}, {"identifier": "resourceIdString", "parameters": "()", "modifiers": "private", "return": "String", "signature": "String resourceIdString()", "full_signature": "private String resourceIdString()", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.resourceIdString()", "testcase": false, "constructor": false}, {"identifier": "position", "parameters": "(long newPosition)", "modifiers": "@Override public", "return": "SeekableByteChannel", "signature": "SeekableByteChannel position(long newPosition)", "full_signature": "@Override public SeekableByteChannel position(long newPosition)", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.position(long newPosition)", "testcase": false, "constructor": false}, {"identifier": "size", "parameters": "()", "modifiers": "@Override public", "return": "long", "signature": "long size()", "full_signature": "@Override public long size()", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.size()", "testcase": false, "constructor": false}, {"identifier": "truncate", "parameters": "(long l)", "modifiers": "@Override public", "return": "SeekableByteChannel", "signature": "SeekableByteChannel truncate(long l)", "full_signature": "@Override public SeekableByteChannel truncate(long l)", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.truncate(long l)", "testcase": false, "constructor": false}, {"identifier": "isOpen", "parameters": "()", "modifiers": "@Override public", "return": "boolean", "signature": "boolean isOpen()", "full_signature": "@Override public boolean isOpen()", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.isOpen()", "testcase": false, "constructor": false}, {"identifier": "close", "parameters": "()", "modifiers": "@Override public", "return": "void", "signature": "void close()", "full_signature": "@Override public void close()", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.close()", "testcase": false, "constructor": false}, {"identifier": "toString", "parameters": "()", "modifiers": "@Override public", "return": "String", "signature": "String toString()", "full_signature": "@Override public String toString()", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.toString()", "testcase": false, "constructor": false}], "file": "gcsio/src/main/java/com/google/cloud/hadoop/gcsio/GoogleCloudStorageGrpcReadChannel.java"}, "focal_method": {"identifier": "read", "parameters": "(ByteBuffer byteBuffer)", "modifiers": "@Override public", "return": "int", "body": "@Override\n  public int read(ByteBuffer byteBuffer) throws IOException {\n    logger.atFine().log(\n        \"GCS gRPC read request for up to %d bytes at offset %d from object %s\",\n        byteBuffer.remaining(), position(), objectName);\n\n    if (!isOpen()) {\n      throw new ClosedChannelException();\n    }\n\n    int bytesRead = 0;\n\n    // The server responds in 2MB chunks, but the client can ask for less than that. We store the\n    // remainder in bufferedContent and return pieces of that on the next read call (and flush\n    // that buffer if there is a seek).\n    if (bufferedContent != null) {\n      bytesRead += readBufferedContentInto(byteBuffer);\n    }\n    if (!byteBuffer.hasRemaining()) {\n      return bytesRead;\n    }\n    if (position == objectSize) {\n      return bytesRead > 0 ? bytesRead : -1;\n    }\n    if (resIterator == null) {\n      OptionalLong bytesToRead;\n      if (readStrategy == Fadvise.RANDOM) {\n        long randomRangeSize =\n            Math.max(byteBuffer.remaining(), readOptions.getMinRangeRequestSize());\n        bytesToRead = OptionalLong.of(randomRangeSize);\n      } else {\n        bytesToRead = OptionalLong.empty();\n      }\n      requestObjectMedia(bytesToRead);\n    }\n    while (moreServerContent() && byteBuffer.hasRemaining()) {\n      GetObjectMediaResponse res = resIterator.next();\n\n      ByteString content = res.getChecksummedData().getContent();\n      if (bytesToSkipBeforeReading >= 0 && bytesToSkipBeforeReading < content.size()) {\n        content = res.getChecksummedData().getContent().substring((int) bytesToSkipBeforeReading);\n        bytesToSkipBeforeReading = 0;\n      } else if (bytesToSkipBeforeReading >= content.size()) {\n        bytesToSkipBeforeReading -= content.size();\n        continue;\n      }\n\n      if (readOptions.isGrpcChecksumsEnabled() && res.getChecksummedData().hasCrc32C()) {\n        // TODO: Concatenate all these hashes together and compare the result at the end.\n        Hasher messageHasher = Hashing.crc32c().newHasher();\n        messageHasher.putBytes(res.getChecksummedData().getContent().toByteArray());\n        int calculatedChecksum = messageHasher.hash().asInt();\n        int expectedChecksum = res.getChecksummedData().getCrc32C().getValue();\n        if (calculatedChecksum != expectedChecksum) {\n          throw new IOException(\n              String.format(\n                  \"For %s: Message checksum didn't match. Expected %s, got %s.\",\n                  this, expectedChecksum, calculatedChecksum));\n        }\n      }\n\n      boolean responseSizeLargerThanRemainingBuffer = content.size() > byteBuffer.remaining();\n      int bytesToWrite =\n          responseSizeLargerThanRemainingBuffer ? byteBuffer.remaining() : content.size();\n      put(content, 0, bytesToWrite, byteBuffer);\n      bytesRead += bytesToWrite;\n      position += bytesToWrite;\n\n      if (responseSizeLargerThanRemainingBuffer) {\n        bufferedContent = content;\n        bufferedContentReadOffset = bytesToWrite;\n      }\n    }\n    return bytesRead;\n  }", "signature": "int read(ByteBuffer byteBuffer)", "full_signature": "@Override public int read(ByteBuffer byteBuffer)", "class_method_signature": "GoogleCloudStorageGrpcReadChannel.read(ByteBuffer byteBuffer)", "testcase": false, "constructor": false, "invocations": ["log", "atFine", "remaining", "position", "isOpen", "readBufferedContentInto", "hasRemaining", "max", "remaining", "getMinRangeRequestSize", "of", "empty", "requestObjectMedia", "moreServerContent", "hasRemaining", "next", "getContent", "getChecksummedData", "size", "substring", "getContent", "getChecksummedData", "size", "size", "isGrpcChecksumsEnabled", "hasCrc32C", "getChecksummedData", "newHasher", "crc32c", "putBytes", "toByteArray", "getContent", "getChecksummedData", "asInt", "hash", "getValue", "getCrc32C", "getChecksummedData", "format", "size", "remaining", "remaining", "size", "put"]}, "repository": {"repo_id": 19684359, "url": "https://github.com/GoogleCloudDataproc/bigdata-interop", "stars": 178, "created": "5/12/2014 3:11:55 AM +00:00", "updates": "2020-01-23T23:10:40+00:00", "fork": "False", "license": "licensed"}}