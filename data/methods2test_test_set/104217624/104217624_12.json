{"test_class": {"identifier": "RrdpServiceImplTest", "superclass": "extends GenericStorageTest", "interfaces": "", "fields": [{"original_string": "private static final String RRDP_RIPE_NET_NOTIFICATION_XML = \"https://rrdp.ripe.net/notification.xml\";", "modifier": "private static final", "type": "String", "declarator": "RRDP_RIPE_NET_NOTIFICATION_XML = \"https://rrdp.ripe.net/notification.xml\"", "var_name": "RRDP_RIPE_NET_NOTIFICATION_XML"}, {"original_string": "private static final String SNAPSHOT_URL = \"https://host/path/snapshot.xml\";", "modifier": "private static final", "type": "String", "declarator": "SNAPSHOT_URL = \"https://host/path/snapshot.xml\"", "var_name": "SNAPSHOT_URL"}, {"original_string": "private RrdpClientStub rrdpClient = new RrdpClientStub();", "modifier": "private", "type": "RrdpClientStub", "declarator": "rrdpClient = new RrdpClientStub()", "var_name": "rrdpClient"}, {"original_string": "private RrdpServiceImpl subject;", "modifier": "private", "type": "RrdpServiceImpl", "declarator": "subject", "var_name": "subject"}, {"original_string": "@MockBean\n    private RrdpMetricsService rrdpMetricsService;", "modifier": "@MockBean\n    private", "type": "RrdpMetricsService", "declarator": "rrdpMetricsService", "var_name": "rrdpMetricsService"}], "file": "rpki-validator/src/test/java/net/ripe/rpki/validator3/rrdp/RrdpServiceImplTest.java"}, "test_case": {"identifier": "should_parse_notification_use_delta_the_last_delta_serial_is_not_matching_fallback_to_snapshot", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void should_parse_notification_use_delta_the_last_delta_serial_is_not_matching_fallback_to_snapshot() {\n        final byte[] certificate = Objects.aParseableCertificate();\n        final String sessionId = UUID.randomUUID().toString();\n        final Objects.Publish crl = new Objects.Publish(\"rsync://host/path/crl1.crl\", Objects.aParseableCrl());\n        rrdpClient.add(crl.uri, crl.content);\n\n        final byte[] snapshotXml = Objects.snapshotXml(4, sessionId, crl);\n\n        final Objects.SnapshotInfo emptySnapshot = new Objects.SnapshotInfo(SNAPSHOT_URL, Sha256.hash(snapshotXml));\n        rrdpClient.add(emptySnapshot.uri, snapshotXml);\n\n        final Objects.DeltaPublish publishCert = new Objects.DeltaPublish(\"rsync://host/path/cert.cer\", certificate);\n        final byte[] deltaXml1 = Objects.deltaXml(2, sessionId, publishCert);\n\n        final Objects.DeltaPublish republishCert = new Objects.DeltaPublish(\"rsync://host/path/cert.cer\", Sha256.hash(publishCert.content), certificate);\n        final byte[] deltaXml2 = Objects.deltaXml(3, sessionId, republishCert);\n\n        final Objects.DeltaInfo deltaInfo1 = new Objects.DeltaInfo(\"https://host/path/delta1.xml\", Sha256.hash(deltaXml1), 2);\n        final Objects.DeltaInfo deltaInfo2 = new Objects.DeltaInfo(\"https://host/path/delta2.xml\", Sha256.hash(deltaXml2), 3);\n        rrdpClient.add(deltaInfo1.uri, deltaXml1);\n        rrdpClient.add(deltaInfo2.uri, deltaXml2);\n\n        final String notificationUri = RRDP_RIPE_NET_NOTIFICATION_XML;\n        rrdpClient.add(notificationUri, Objects.notificationXml(4, sessionId, emptySnapshot, deltaInfo1, deltaInfo2));\n\n        final TrustAnchor trustAnchor = TestObjects.newTrustAnchor();\n        wtx0(tx -> this.getTrustAnchors().add(tx, trustAnchor));\n\n        // make current serial lower to trigger delta download\n        final RpkiRepository rpkiRepository = makeRpkiRepository(sessionId, notificationUri, trustAnchor);\n\n        Ref<RpkiRepository> rpkiRepositoryRef = rtx(tx ->\n                this.getRpkiRepositories().makeRef(tx, rpkiRepository.key()));\n\n        // do the first run to get the snapshot\n        final RrdpRepositoryValidationRun validationRun = wtx(tx ->\n                this.getValidationRuns().add(tx, new RrdpRepositoryValidationRun(rpkiRepositoryRef)));\n        subject.storeRepository(rpkiRepository, validationRun);\n        assertEquals(1, validationRun.getValidationChecks().size());\n\n        final ValidationCheck validationCheck = validationRun.getValidationChecks().get(0);\n        assertEquals(ErrorCodes.RRDP_SERIAL_MISMATCH, validationCheck.getKey());\n        assertEquals(ValidationCheck.Status.WARNING, validationCheck.getStatus());\n        assertEquals(rpkiRepository.getRrdpNotifyUri(), validationCheck.getLocation());\n        assertEquals(\"The last delta serial is 3, notification file serial is 4\", validationCheck.getParameters().get(0));\n\n        final List<RpkiObject> objects = rtx(tx -> this.getRpkiObjects().values(tx));\n        assertEquals(1, objects.size());\n\n        final RpkiObject rpkiObject = objects.get(0);\n        assertEquals(RpkiObject.Type.CRL, rpkiObject.getType());\n        rtx0(tx ->\n            assertEquals(Sets.newHashSet(\"rsync://host/path/crl1.crl\"), getLocations(tx, rpkiObject)));\n    }", "signature": "void should_parse_notification_use_delta_the_last_delta_serial_is_not_matching_fallback_to_snapshot()", "full_signature": "@Test public void should_parse_notification_use_delta_the_last_delta_serial_is_not_matching_fallback_to_snapshot()", "class_method_signature": "RrdpServiceImplTest.should_parse_notification_use_delta_the_last_delta_serial_is_not_matching_fallback_to_snapshot()", "testcase": true, "constructor": false, "invocations": ["aParseableCertificate", "toString", "randomUUID", "aParseableCrl", "add", "snapshotXml", "hash", "add", "deltaXml", "hash", "deltaXml", "hash", "hash", "add", "add", "add", "notificationXml", "newTrustAnchor", "wtx0", "add", "getTrustAnchors", "makeRpkiRepository", "rtx", "makeRef", "getRpkiRepositories", "key", "wtx", "add", "getValidationRuns", "storeRepository", "assertEquals", "size", "getValidationChecks", "get", "getValidationChecks", "assertEquals", "getKey", "assertEquals", "getStatus", "assertEquals", "getRrdpNotifyUri", "getLocation", "assertEquals", "get", "getParameters", "rtx", "values", "getRpkiObjects", "assertEquals", "size", "get", "assertEquals", "getType", "rtx0", "assertEquals", "newHashSet", "getLocations"]}, "focal_class": {"identifier": "RrdpServiceImpl", "superclass": "", "interfaces": "implements RrdpService", "fields": [{"original_string": "private static final int PENDING_OBJECT_COMMIT_BATCH_SIZE_BYTES = 1_000_000;", "modifier": "private static final", "type": "int", "declarator": "PENDING_OBJECT_COMMIT_BATCH_SIZE_BYTES = 1_000_000", "var_name": "PENDING_OBJECT_COMMIT_BATCH_SIZE_BYTES"}, {"original_string": "private static final Predicate<RepositoryObjectType> NO_MANIFESTS_PREDICATE = (type) -> type != RepositoryObjectType.Manifest;", "modifier": "private static final", "type": "Predicate<RepositoryObjectType>", "declarator": "NO_MANIFESTS_PREDICATE = (type) -> type != RepositoryObjectType.Manifest", "var_name": "NO_MANIFESTS_PREDICATE"}, {"original_string": "private static final Predicate<RepositoryObjectType> ONLY_MANIFESTS_PREDICATE = (type) -> type == RepositoryObjectType.Manifest;", "modifier": "private static final", "type": "Predicate<RepositoryObjectType>", "declarator": "ONLY_MANIFESTS_PREDICATE = (type) -> type == RepositoryObjectType.Manifest", "var_name": "ONLY_MANIFESTS_PREDICATE"}, {"original_string": "private final RrdpParser rrdpParser = new RrdpParser();", "modifier": "private final", "type": "RrdpParser", "declarator": "rrdpParser = new RrdpParser()", "var_name": "rrdpParser"}, {"original_string": "private final RrdpClient rrdpClient;", "modifier": "private final", "type": "RrdpClient", "declarator": "rrdpClient", "var_name": "rrdpClient"}, {"original_string": "private final RpkiObjects rpkiObjects;", "modifier": "private final", "type": "RpkiObjects", "declarator": "rpkiObjects", "var_name": "rpkiObjects"}, {"original_string": "private final RpkiRepositories rpkiRepositories;", "modifier": "private final", "type": "RpkiRepositories", "declarator": "rpkiRepositories", "var_name": "rpkiRepositories"}, {"original_string": "private final Storage storage;", "modifier": "private final", "type": "Storage", "declarator": "storage", "var_name": "storage"}, {"original_string": "private final RrdpMetricsService rrdpMetrics;", "modifier": "private final", "type": "RrdpMetricsService", "declarator": "rrdpMetrics", "var_name": "rrdpMetrics"}], "methods": [{"identifier": "RrdpServiceImpl", "parameters": "(\n            final RrdpClient rrdpClient,\n            final RpkiObjects rpkiObjects,\n            final RpkiRepositories rpkiRepositories,\n            final Storage storage,\n            final RrdpMetricsService rrdpMetrics\n    )", "modifiers": "@Autowired public", "return": "", "signature": " RrdpServiceImpl(\n            final RrdpClient rrdpClient,\n            final RpkiObjects rpkiObjects,\n            final RpkiRepositories rpkiRepositories,\n            final Storage storage,\n            final RrdpMetricsService rrdpMetrics\n    )", "full_signature": "@Autowired public  RrdpServiceImpl(\n            final RrdpClient rrdpClient,\n            final RpkiObjects rpkiObjects,\n            final RpkiRepositories rpkiRepositories,\n            final Storage storage,\n            final RrdpMetricsService rrdpMetrics\n    )", "class_method_signature": "RrdpServiceImpl.RrdpServiceImpl(\n            final RrdpClient rrdpClient,\n            final RpkiObjects rpkiObjects,\n            final RpkiRepositories rpkiRepositories,\n            final Storage storage,\n            final RrdpMetricsService rrdpMetrics\n    )", "testcase": false, "constructor": true}, {"identifier": "storeRepository", "parameters": "(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "modifiers": "@Override public", "return": "boolean", "signature": "boolean storeRepository(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "full_signature": "@Override public boolean storeRepository(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "class_method_signature": "RrdpServiceImpl.storeRepository(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "testcase": false, "constructor": false}, {"identifier": "doStoreRepository", "parameters": "(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun)", "modifiers": "private", "return": "boolean", "signature": "boolean doStoreRepository(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun)", "full_signature": "private boolean doStoreRepository(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun)", "class_method_signature": "RrdpServiceImpl.doStoreRepository(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun)", "testcase": false, "constructor": false}, {"identifier": "processSnapshot", "parameters": "(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, AtomicBoolean changedObjects)", "modifiers": "private", "return": "void", "signature": "void processSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, AtomicBoolean changedObjects)", "full_signature": "private void processSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, AtomicBoolean changedObjects)", "class_method_signature": "RrdpServiceImpl.processSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, AtomicBoolean changedObjects)", "testcase": false, "constructor": false}, {"identifier": "processDownloadedSnapshot", "parameters": "(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, Path snapshotPath, Predicate<RepositoryObjectType> typePredicate)", "modifiers": "private", "return": "int", "signature": "int processDownloadedSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, Path snapshotPath, Predicate<RepositoryObjectType> typePredicate)", "full_signature": "private int processDownloadedSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, Path snapshotPath, Predicate<RepositoryObjectType> typePredicate)", "class_method_signature": "RrdpServiceImpl.processDownloadedSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, Path snapshotPath, Predicate<RepositoryObjectType> typePredicate)", "testcase": false, "constructor": false}, {"identifier": "processDelta", "parameters": "(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, AtomicBoolean changedObjects)", "modifiers": "private", "return": "void", "signature": "void processDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, AtomicBoolean changedObjects)", "full_signature": "private void processDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, AtomicBoolean changedObjects)", "class_method_signature": "RrdpServiceImpl.processDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, AtomicBoolean changedObjects)", "testcase": false, "constructor": false}, {"identifier": "processDownloadedDelta", "parameters": "(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, Path deltaPath, Predicate<RepositoryObjectType> typePredicate)", "modifiers": "private", "return": "int", "signature": "int processDownloadedDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, Path deltaPath, Predicate<RepositoryObjectType> typePredicate)", "full_signature": "private int processDownloadedDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, Path deltaPath, Predicate<RepositoryObjectType> typePredicate)", "class_method_signature": "RrdpServiceImpl.processDownloadedDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, Path deltaPath, Predicate<RepositoryObjectType> typePredicate)", "testcase": false, "constructor": false}, {"identifier": "verifyAndOrderDeltaSerials", "parameters": "(final Notification notification, RpkiRepository rpkiRepository)", "modifiers": "private", "return": "List<DeltaInfo>", "signature": "List<DeltaInfo> verifyAndOrderDeltaSerials(final Notification notification, RpkiRepository rpkiRepository)", "full_signature": "private List<DeltaInfo> verifyAndOrderDeltaSerials(final Notification notification, RpkiRepository rpkiRepository)", "class_method_signature": "RrdpServiceImpl.verifyAndOrderDeltaSerials(final Notification notification, RpkiRepository rpkiRepository)", "testcase": false, "constructor": false}, {"identifier": "storeSnapshotObjects", "parameters": "(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "modifiers": "", "return": "int", "signature": "int storeSnapshotObjects(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "full_signature": " int storeSnapshotObjects(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "class_method_signature": "RrdpServiceImpl.storeSnapshotObjects(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "testcase": false, "constructor": false}, {"identifier": "storeSnapshotObject", "parameters": "(Tx.Write tx, RpkiRepositoryValidationRun validationRun, Either<ValidationResult, Pair<String, RpkiObject>> maybeRpkiObject, AtomicInteger counter)", "modifiers": "private", "return": "void", "signature": "void storeSnapshotObject(Tx.Write tx, RpkiRepositoryValidationRun validationRun, Either<ValidationResult, Pair<String, RpkiObject>> maybeRpkiObject, AtomicInteger counter)", "full_signature": "private void storeSnapshotObject(Tx.Write tx, RpkiRepositoryValidationRun validationRun, Either<ValidationResult, Pair<String, RpkiObject>> maybeRpkiObject, AtomicInteger counter)", "class_method_signature": "RrdpServiceImpl.storeSnapshotObject(Tx.Write tx, RpkiRepositoryValidationRun validationRun, Either<ValidationResult, Pair<String, RpkiObject>> maybeRpkiObject, AtomicInteger counter)", "testcase": false, "constructor": false}, {"identifier": "storeDeltaObjects", "parameters": "(final Tx.Write wtx,\n                                  final List<DeltaElement> deltaElements,\n                                  final RpkiRepositoryValidationRun validationRun)", "modifiers": "private", "return": "int", "signature": "int storeDeltaObjects(final Tx.Write wtx,\n                                  final List<DeltaElement> deltaElements,\n                                  final RpkiRepositoryValidationRun validationRun)", "full_signature": "private int storeDeltaObjects(final Tx.Write wtx,\n                                  final List<DeltaElement> deltaElements,\n                                  final RpkiRepositoryValidationRun validationRun)", "class_method_signature": "RrdpServiceImpl.storeDeltaObjects(final Tx.Write wtx,\n                                  final List<DeltaElement> deltaElements,\n                                  final RpkiRepositoryValidationRun validationRun)", "testcase": false, "constructor": false}, {"identifier": "applyDeltaWithdraw", "parameters": "(RpkiRepositoryValidationRun validationRun, String uri, DeltaWithdraw deltaWithdraw, Tx.Write tx)", "modifiers": "private", "return": "boolean", "signature": "boolean applyDeltaWithdraw(RpkiRepositoryValidationRun validationRun, String uri, DeltaWithdraw deltaWithdraw, Tx.Write tx)", "full_signature": "private boolean applyDeltaWithdraw(RpkiRepositoryValidationRun validationRun, String uri, DeltaWithdraw deltaWithdraw, Tx.Write tx)", "class_method_signature": "RrdpServiceImpl.applyDeltaWithdraw(RpkiRepositoryValidationRun validationRun, String uri, DeltaWithdraw deltaWithdraw, Tx.Write tx)", "testcase": false, "constructor": false}, {"identifier": "verifyDeltaIsApplicable", "parameters": "(Tx.Read tx, List<DeltaElement> pendingObjects)", "modifiers": "private", "return": "void", "signature": "void verifyDeltaIsApplicable(Tx.Read tx, List<DeltaElement> pendingObjects)", "full_signature": "private void verifyDeltaIsApplicable(Tx.Read tx, List<DeltaElement> pendingObjects)", "class_method_signature": "RrdpServiceImpl.verifyDeltaIsApplicable(Tx.Read tx, List<DeltaElement> pendingObjects)", "testcase": false, "constructor": false}, {"identifier": "checkObjectExists", "parameters": "(DeltaElement deltaElement, String errorCode, byte[] sha256, Tx.Read tx)", "modifiers": "private", "return": "void", "signature": "void checkObjectExists(DeltaElement deltaElement, String errorCode, byte[] sha256, Tx.Read tx)", "full_signature": "private void checkObjectExists(DeltaElement deltaElement, String errorCode, byte[] sha256, Tx.Read tx)", "class_method_signature": "RrdpServiceImpl.checkObjectExists(DeltaElement deltaElement, String errorCode, byte[] sha256, Tx.Read tx)", "testcase": false, "constructor": false}, {"identifier": "applyDeltaPublish", "parameters": "(final RpkiRepositoryValidationRun validationRun,\n                                      final String uri,\n                                      final DeltaPublish deltaPublish,\n                                      final Tx.Write tx)", "modifiers": "private", "return": "boolean", "signature": "boolean applyDeltaPublish(final RpkiRepositoryValidationRun validationRun,\n                                      final String uri,\n                                      final DeltaPublish deltaPublish,\n                                      final Tx.Write tx)", "full_signature": "private boolean applyDeltaPublish(final RpkiRepositoryValidationRun validationRun,\n                                      final String uri,\n                                      final DeltaPublish deltaPublish,\n                                      final Tx.Write tx)", "class_method_signature": "RrdpServiceImpl.applyDeltaPublish(final RpkiRepositoryValidationRun validationRun,\n                                      final String uri,\n                                      final DeltaPublish deltaPublish,\n                                      final Tx.Write tx)", "testcase": false, "constructor": false}], "file": "rpki-validator/src/main/java/net/ripe/rpki/validator3/rrdp/RrdpServiceImpl.java"}, "focal_method": {"identifier": "storeRepository", "parameters": "(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "modifiers": "@Override public", "return": "boolean", "body": "@Override\n    public boolean storeRepository(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun) {\n        Pair<Boolean, Long> timed = Time.timed(() -> {\n            try {\n                return doStoreRepository(rpkiRepository, validationRun);\n            } catch (RrdpException e) {\n                log.warn(\"Error retrieving RRDP repository at {}: \" + e.getMessage(), rpkiRepository.getRrdpNotifyUri());\n                ValidationCheck validationCheck = new ValidationCheck(rpkiRepository.getRrdpNotifyUri(),\n                        ValidationCheck.Status.ERROR, ErrorCodes.RRDP_FETCH, e.getMessage());\n                validationRun.addCheck(validationCheck);\n                validationRun.setFailed();\n            }\n            return false;\n        });\n        log.info(\"RRDP repository job for {} took {}ms\", rpkiRepository.getRrdpNotifyUri(), timed.getRight());\n        return timed.getLeft();\n    }", "signature": "boolean storeRepository(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "full_signature": "@Override public boolean storeRepository(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "class_method_signature": "RrdpServiceImpl.storeRepository(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "testcase": false, "constructor": false, "invocations": ["timed", "doStoreRepository", "warn", "getMessage", "getRrdpNotifyUri", "getRrdpNotifyUri", "getMessage", "addCheck", "setFailed", "info", "getRrdpNotifyUri", "getRight", "getLeft"]}, "repository": {"repo_id": 104217624, "url": "https://github.com/RIPE-NCC/rpki-validator-3", "stars": 32, "created": "9/20/2017 1:15:05 PM +00:00", "updates": "2020-01-27T10:48:38+00:00", "fork": "False", "license": "licensed"}}