{"test_class": {"identifier": "AkCollatorFactoryTest", "superclass": "", "interfaces": "", "fields": [{"original_string": "private final static int NTHREADS = 10;", "modifier": "private final static", "type": "int", "declarator": "NTHREADS = 10", "var_name": "NTHREADS"}, {"original_string": "private AkCollatorFactory.Mode DEFAULT_MODE = AkCollatorFactory.Mode.STRICT;", "modifier": "private", "type": "AkCollatorFactory.Mode", "declarator": "DEFAULT_MODE = AkCollatorFactory.Mode.STRICT", "var_name": "DEFAULT_MODE"}], "file": "fdb-sql-layer-core/src/test/java/com/foundationdb/server/collation/AkCollatorFactoryTest.java"}, "test_case": {"identifier": "uniquePerThread", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void uniquePerThread() throws Exception {\n        final AtomicInteger threadIndex = new AtomicInteger();\n        final Collator[] array = new Collator[NTHREADS];\n        Thread[] threads = new Thread[NTHREADS];\n        for (int i = 0; i < NTHREADS; i++) {\n            threads[i] = new Thread(new Runnable() {\n                public void run() {\n                    int index = threadIndex.getAndIncrement();\n                    AkCollatorICU icu = (AkCollatorICU) (AkCollatorFactory.getAkCollator(\"sv_se_ci\"));\n                    array[index] = icu.collator.get();\n                }\n            });\n        }\n        for (int i = 0; i < NTHREADS; i++) {\n            threads[i].start();\n        }\n        for (int i = 0; i < NTHREADS; i++) {\n            threads[i].join();\n        }\n        for (int i = 0; i < NTHREADS; i++) {\n            assertNotNull(\"Null\", array[i]);\n            for (int j = 0; j < i; j++) {\n                assertTrue(\"Not unique\", array[i] != array[j]);\n            }\n        }\n    }", "signature": "void uniquePerThread()", "full_signature": "@Test public void uniquePerThread()", "class_method_signature": "AkCollatorFactoryTest.uniquePerThread()", "testcase": true, "constructor": false, "invocations": ["getAndIncrement", "getAkCollator", "get", "start", "join", "assertNotNull", "assertTrue"]}, "focal_class": {"identifier": "AkCollatorFactory", "superclass": "", "interfaces": "", "fields": [{"original_string": "public final static int UCS_BINARY_ID = 0;", "modifier": "public final static", "type": "int", "declarator": "UCS_BINARY_ID = 0", "var_name": "UCS_BINARY_ID"}, {"original_string": "public final static String UCS_BINARY = \"UCS_BINARY\";", "modifier": "public final static", "type": "String", "declarator": "UCS_BINARY = \"UCS_BINARY\"", "var_name": "UCS_BINARY"}, {"original_string": "public final static AkCollator UCS_BINARY_COLLATOR = new AkCollatorBinary();", "modifier": "public final static", "type": "AkCollator", "declarator": "UCS_BINARY_COLLATOR = new AkCollatorBinary()", "var_name": "UCS_BINARY_COLLATOR"}, {"original_string": "private final static Map<String, Collator> sourceMap = new HashMap<>();", "modifier": "private final static", "type": "Map<String, Collator>", "declarator": "sourceMap = new HashMap<>()", "var_name": "sourceMap"}, {"original_string": "private final static Map<String, SoftReference<AkCollator>> collatorMap = new ConcurrentHashMap<>();", "modifier": "private final static", "type": "Map<String, SoftReference<AkCollator>>", "declarator": "collatorMap = new ConcurrentHashMap<>()", "var_name": "collatorMap"}, {"original_string": "private final static Map<Integer, SoftReference<AkCollator>> collationIdMap = new ConcurrentHashMap<>();", "modifier": "private final static", "type": "Map<Integer, SoftReference<AkCollator>>", "declarator": "collationIdMap = new ConcurrentHashMap<>()", "var_name": "collationIdMap"}, {"original_string": "private final static Map<String, Integer> schemeToIdMap = new ConcurrentHashMap<>();", "modifier": "private final static", "type": "Map<String, Integer>", "declarator": "schemeToIdMap = new ConcurrentHashMap<>()", "var_name": "schemeToIdMap"}, {"original_string": "private final static AtomicInteger collationIdGenerator = new AtomicInteger(UCS_BINARY_ID);", "modifier": "private final static", "type": "AtomicInteger", "declarator": "collationIdGenerator = new AtomicInteger(UCS_BINARY_ID)", "var_name": "collationIdGenerator"}, {"original_string": "private volatile static Mode mode = Mode.STRICT;", "modifier": "private volatile static", "type": "Mode", "declarator": "mode = Mode.STRICT", "var_name": "mode"}, {"original_string": "private static int cacheHits;", "modifier": "private static", "type": "int", "declarator": "cacheHits", "var_name": "cacheHits"}], "methods": [{"identifier": "setCollationMode", "parameters": "(String modeString)", "modifiers": "public static", "return": "void", "signature": "void setCollationMode(String modeString)", "full_signature": "public static void setCollationMode(String modeString)", "class_method_signature": "AkCollatorFactory.setCollationMode(String modeString)", "testcase": false, "constructor": false}, {"identifier": "setCollationMode", "parameters": "(Mode m)", "modifiers": "public static", "return": "void", "signature": "void setCollationMode(Mode m)", "full_signature": "public static void setCollationMode(Mode m)", "class_method_signature": "AkCollatorFactory.setCollationMode(Mode m)", "testcase": false, "constructor": false}, {"identifier": "getCollationMode", "parameters": "()", "modifiers": "public static", "return": "Mode", "signature": "Mode getCollationMode()", "full_signature": "public static Mode getCollationMode()", "class_method_signature": "AkCollatorFactory.getCollationMode()", "testcase": false, "constructor": false}, {"identifier": "getAkCollator", "parameters": "(final String scheme)", "modifiers": "public static", "return": "AkCollator", "signature": "AkCollator getAkCollator(final String scheme)", "full_signature": "public static AkCollator getAkCollator(final String scheme)", "class_method_signature": "AkCollatorFactory.getAkCollator(final String scheme)", "testcase": false, "constructor": false}, {"identifier": "getAkCollator", "parameters": "(final int collatorId)", "modifiers": "public static", "return": "AkCollator", "signature": "AkCollator getAkCollator(final int collatorId)", "full_signature": "public static AkCollator getAkCollator(final int collatorId)", "class_method_signature": "AkCollatorFactory.getAkCollator(final int collatorId)", "testcase": false, "constructor": false}, {"identifier": "getKeyByValue", "parameters": "(Map<T, E> map, E value)", "modifiers": "public static", "return": "T", "signature": "T getKeyByValue(Map<T, E> map, E value)", "full_signature": "public static T getKeyByValue(Map<T, E> map, E value)", "class_method_signature": "AkCollatorFactory.getKeyByValue(Map<T, E> map, E value)", "testcase": false, "constructor": false}, {"identifier": "forScheme", "parameters": "(final CollationSpecifier specifier)", "modifiers": "static synchronized", "return": "Collator", "signature": "Collator forScheme(final CollationSpecifier specifier)", "full_signature": "static synchronized Collator forScheme(final CollationSpecifier specifier)", "class_method_signature": "AkCollatorFactory.forScheme(final CollationSpecifier specifier)", "testcase": false, "constructor": false}, {"identifier": "mapToBinary", "parameters": "(final String scheme)", "modifiers": "private static", "return": "AkCollator", "signature": "AkCollator mapToBinary(final String scheme)", "full_signature": "private static AkCollator mapToBinary(final String scheme)", "class_method_signature": "AkCollatorFactory.mapToBinary(final String scheme)", "testcase": false, "constructor": false}, {"identifier": "getCacheHits", "parameters": "()", "modifiers": "static", "return": "int", "signature": "int getCacheHits()", "full_signature": "static int getCacheHits()", "class_method_signature": "AkCollatorFactory.getCacheHits()", "testcase": false, "constructor": false}], "file": "fdb-sql-layer-core/src/main/java/com/foundationdb/server/collation/AkCollatorFactory.java"}, "focal_method": {"identifier": "getAkCollator", "parameters": "(final String scheme)", "modifiers": "public static", "return": "AkCollator", "body": "public static AkCollator getAkCollator(final String scheme) {\n        if (mode == Mode.DISABLED || scheme == null) {\n            return UCS_BINARY_COLLATOR;\n        }\n\n        if (scheme.equalsIgnoreCase(UCS_BINARY)) {\n            return mapToBinary(scheme);\n        }\n\n        SoftReference<AkCollator> ref = collatorMap.get(scheme);\n        if (ref != null) {\n            AkCollator akCollator = ref.get();\n            if (akCollator != null) {\n                cacheHits++;\n                return akCollator;\n            }\n        }\n\n        synchronized (collatorMap) {\n\n            Integer collationId = schemeToIdMap.get(scheme);\n            if (collationId == null) {\n                collationId = collationIdGenerator.incrementAndGet();\n            }\n\n            final AkCollator akCollator;\n            try {\n                akCollator = new AkCollatorICU(scheme, collationId);\n            } catch (InvalidCollationSchemeException | UnsupportedCollationException e) {\n                if (mode == Mode.LOOSE) {\n                    return mapToBinary(scheme);\n                }\n                throw e;\n            }\n\n            ref = new SoftReference<>(akCollator);\n            collatorMap.put(scheme, ref);\n            collationIdMap.put(collationId, ref);\n            schemeToIdMap.put(scheme, collationId);\n\n            return akCollator;\n        }\n    }", "signature": "AkCollator getAkCollator(final String scheme)", "full_signature": "public static AkCollator getAkCollator(final String scheme)", "class_method_signature": "AkCollatorFactory.getAkCollator(final String scheme)", "testcase": false, "constructor": false, "invocations": ["equalsIgnoreCase", "mapToBinary", "get", "get", "get", "incrementAndGet", "mapToBinary", "put", "put", "put"]}, "repository": {"repo_id": 32884360, "url": "https://github.com/jaytaylor/sql-layer", "language": "Java", "is_fork": false, "fork_count": 120, "stargazer_count": 77, "size": 138665, "license": "licensed"}}