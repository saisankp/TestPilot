{"test_class": {"identifier": "RrdpServiceImplTest", "superclass": "extends GenericStorageTest", "interfaces": "", "fields": [{"original_string": "private static final String RRDP_RIPE_NET_NOTIFICATION_XML = \"https://rrdp.ripe.net/notification.xml\";", "modifier": "private static final", "type": "String", "declarator": "RRDP_RIPE_NET_NOTIFICATION_XML = \"https://rrdp.ripe.net/notification.xml\"", "var_name": "RRDP_RIPE_NET_NOTIFICATION_XML"}, {"original_string": "private static final String SNAPSHOT_URL = \"https://host/path/snapshot.xml\";", "modifier": "private static final", "type": "String", "declarator": "SNAPSHOT_URL = \"https://host/path/snapshot.xml\"", "var_name": "SNAPSHOT_URL"}, {"original_string": "private RrdpClientStub rrdpClient = new RrdpClientStub();", "modifier": "private", "type": "RrdpClientStub", "declarator": "rrdpClient = new RrdpClientStub()", "var_name": "rrdpClient"}, {"original_string": "private RrdpServiceImpl subject;", "modifier": "private", "type": "RrdpServiceImpl", "declarator": "subject", "var_name": "subject"}, {"original_string": "@MockBean\n    private RrdpMetricsService rrdpMetricsService;", "modifier": "@MockBean\n    private", "type": "RrdpMetricsService", "declarator": "rrdpMetricsService", "var_name": "rrdpMetricsService"}], "file": "rpki-validator/src/test/java/net/ripe/rpki/validator3/rrdp/RrdpServiceImplTest.java"}, "test_case": {"identifier": "should_parse_and_save_snapshot", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void should_parse_and_save_snapshot() throws Exception {\n        final TrustAnchor trustAnchor = TestObjects.newTrustAnchor();\n        wtx0(tx -> this.getTrustAnchors().add(tx, trustAnchor));\n\n        final Ref<TrustAnchor> trustAnchorRef = rtx(tx -> this.getTrustAnchors().makeRef(tx, trustAnchor.key()));\n        RpkiRepository rpkiRepository = wtx(tx -> this.getRpkiRepositories().register(tx,\n                trustAnchorRef, RRDP_RIPE_NET_NOTIFICATION_XML, RpkiRepository.Type.RRDP));\n\n        Ref<RpkiRepository> rpkiRepositoryRef = rtx(tx ->\n                this.getRpkiRepositories().makeRef(tx, rpkiRepository.key()));\n\n        final RrdpRepositoryValidationRun validationRun = wtx(tx ->\n                this.getValidationRuns().add(tx, new RrdpRepositoryValidationRun(rpkiRepositoryRef)));\n\n        new RrdpParser().parseSnapshot(\n                Objects.fileIS(\"rrdp/snapshot2.xml\"),\n                (snapshotInfo) -> {\n                },\n                (snapshotObject) -> {\n                    subject.storeSnapshotObjects(Collections.singletonList(snapshotObject), validationRun);\n                }\n        );\n\n        final List<RpkiObject> objects = rtx(tx -> this.getRpkiObjects().values(tx));\n        assertEquals(3, objects.size());\n\n        rtx0(tx -> {\n            final String uri1 = \"rsync://rpki.ripe.net/repository/DEFAULT/61/fdce4c-2ea5-47eb-94bc-5b50ea88eeab/1/phQ5JfV8llJoaGylcrBcVa7oPfI.roa\";\n            assertTrue(objects.stream().anyMatch(o -> uri1.equals(getLocations(tx, o).first())));\n\n            final String uri2 = \"rsync://rpki.ripe.net/repository/DEFAULT/a0/bf69c4-d64a-4340-9bf1-364854cbc0e8/1/Xt2pFufQkzxVnLyxgKKC8x5dVsw.mft\";\n            assertTrue(objects.stream().anyMatch(o -> uri2.equals(getLocations(tx, o).first())));\n\n            final String uri3 = \"rsync://rpki.ripe.net/repository/DEFAULT/8f/db5787-c2c8-429b-8137-cbf6c1849c44/1/s70Ab2nV-TCWnoHVAM4QdNgMolQ.mft\";\n            assertTrue(objects.stream().anyMatch(o -> uri3.equals(getLocations(tx, o).first())));\n        });\n    }", "signature": "void should_parse_and_save_snapshot()", "full_signature": "@Test public void should_parse_and_save_snapshot()", "class_method_signature": "RrdpServiceImplTest.should_parse_and_save_snapshot()", "testcase": true, "constructor": false, "invocations": ["newTrustAnchor", "wtx0", "add", "getTrustAnchors", "rtx", "makeRef", "getTrustAnchors", "key", "wtx", "register", "getRpkiRepositories", "rtx", "makeRef", "getRpkiRepositories", "key", "wtx", "add", "getValidationRuns", "parseSnapshot", "fileIS", "storeSnapshotObjects", "singletonList", "rtx", "values", "getRpkiObjects", "assertEquals", "size", "rtx0", "assertTrue", "anyMatch", "stream", "equals", "first", "getLocations", "assertTrue", "anyMatch", "stream", "equals", "first", "getLocations", "assertTrue", "anyMatch", "stream", "equals", "first", "getLocations"]}, "focal_class": {"identifier": "RrdpServiceImpl", "superclass": "", "interfaces": "implements RrdpService", "fields": [{"original_string": "private static final int PENDING_OBJECT_COMMIT_BATCH_SIZE_BYTES = 1_000_000;", "modifier": "private static final", "type": "int", "declarator": "PENDING_OBJECT_COMMIT_BATCH_SIZE_BYTES = 1_000_000", "var_name": "PENDING_OBJECT_COMMIT_BATCH_SIZE_BYTES"}, {"original_string": "private static final Predicate<RepositoryObjectType> NO_MANIFESTS_PREDICATE = (type) -> type != RepositoryObjectType.Manifest;", "modifier": "private static final", "type": "Predicate<RepositoryObjectType>", "declarator": "NO_MANIFESTS_PREDICATE = (type) -> type != RepositoryObjectType.Manifest", "var_name": "NO_MANIFESTS_PREDICATE"}, {"original_string": "private static final Predicate<RepositoryObjectType> ONLY_MANIFESTS_PREDICATE = (type) -> type == RepositoryObjectType.Manifest;", "modifier": "private static final", "type": "Predicate<RepositoryObjectType>", "declarator": "ONLY_MANIFESTS_PREDICATE = (type) -> type == RepositoryObjectType.Manifest", "var_name": "ONLY_MANIFESTS_PREDICATE"}, {"original_string": "private final RrdpParser rrdpParser = new RrdpParser();", "modifier": "private final", "type": "RrdpParser", "declarator": "rrdpParser = new RrdpParser()", "var_name": "rrdpParser"}, {"original_string": "private final RrdpClient rrdpClient;", "modifier": "private final", "type": "RrdpClient", "declarator": "rrdpClient", "var_name": "rrdpClient"}, {"original_string": "private final RpkiObjects rpkiObjects;", "modifier": "private final", "type": "RpkiObjects", "declarator": "rpkiObjects", "var_name": "rpkiObjects"}, {"original_string": "private final RpkiRepositories rpkiRepositories;", "modifier": "private final", "type": "RpkiRepositories", "declarator": "rpkiRepositories", "var_name": "rpkiRepositories"}, {"original_string": "private final Storage storage;", "modifier": "private final", "type": "Storage", "declarator": "storage", "var_name": "storage"}, {"original_string": "private final RrdpMetricsService rrdpMetrics;", "modifier": "private final", "type": "RrdpMetricsService", "declarator": "rrdpMetrics", "var_name": "rrdpMetrics"}], "methods": [{"identifier": "RrdpServiceImpl", "parameters": "(\n            final RrdpClient rrdpClient,\n            final RpkiObjects rpkiObjects,\n            final RpkiRepositories rpkiRepositories,\n            final Storage storage,\n            final RrdpMetricsService rrdpMetrics\n    )", "modifiers": "@Autowired public", "return": "", "signature": " RrdpServiceImpl(\n            final RrdpClient rrdpClient,\n            final RpkiObjects rpkiObjects,\n            final RpkiRepositories rpkiRepositories,\n            final Storage storage,\n            final RrdpMetricsService rrdpMetrics\n    )", "full_signature": "@Autowired public  RrdpServiceImpl(\n            final RrdpClient rrdpClient,\n            final RpkiObjects rpkiObjects,\n            final RpkiRepositories rpkiRepositories,\n            final Storage storage,\n            final RrdpMetricsService rrdpMetrics\n    )", "class_method_signature": "RrdpServiceImpl.RrdpServiceImpl(\n            final RrdpClient rrdpClient,\n            final RpkiObjects rpkiObjects,\n            final RpkiRepositories rpkiRepositories,\n            final Storage storage,\n            final RrdpMetricsService rrdpMetrics\n    )", "testcase": false, "constructor": true}, {"identifier": "storeRepository", "parameters": "(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "modifiers": "@Override public", "return": "boolean", "signature": "boolean storeRepository(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "full_signature": "@Override public boolean storeRepository(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "class_method_signature": "RrdpServiceImpl.storeRepository(final RpkiRepository rpkiRepository, final RpkiRepositoryValidationRun validationRun)", "testcase": false, "constructor": false}, {"identifier": "doStoreRepository", "parameters": "(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun)", "modifiers": "private", "return": "boolean", "signature": "boolean doStoreRepository(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun)", "full_signature": "private boolean doStoreRepository(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun)", "class_method_signature": "RrdpServiceImpl.doStoreRepository(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun)", "testcase": false, "constructor": false}, {"identifier": "processSnapshot", "parameters": "(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, AtomicBoolean changedObjects)", "modifiers": "private", "return": "void", "signature": "void processSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, AtomicBoolean changedObjects)", "full_signature": "private void processSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, AtomicBoolean changedObjects)", "class_method_signature": "RrdpServiceImpl.processSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, AtomicBoolean changedObjects)", "testcase": false, "constructor": false}, {"identifier": "processDownloadedSnapshot", "parameters": "(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, Path snapshotPath, Predicate<RepositoryObjectType> typePredicate)", "modifiers": "private", "return": "int", "signature": "int processDownloadedSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, Path snapshotPath, Predicate<RepositoryObjectType> typePredicate)", "full_signature": "private int processDownloadedSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, Path snapshotPath, Predicate<RepositoryObjectType> typePredicate)", "class_method_signature": "RrdpServiceImpl.processDownloadedSnapshot(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, Path snapshotPath, Predicate<RepositoryObjectType> typePredicate)", "testcase": false, "constructor": false}, {"identifier": "processDelta", "parameters": "(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, AtomicBoolean changedObjects)", "modifiers": "private", "return": "void", "signature": "void processDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, AtomicBoolean changedObjects)", "full_signature": "private void processDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, AtomicBoolean changedObjects)", "class_method_signature": "RrdpServiceImpl.processDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, AtomicBoolean changedObjects)", "testcase": false, "constructor": false}, {"identifier": "processDownloadedDelta", "parameters": "(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, Path deltaPath, Predicate<RepositoryObjectType> typePredicate)", "modifiers": "private", "return": "int", "signature": "int processDownloadedDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, Path deltaPath, Predicate<RepositoryObjectType> typePredicate)", "full_signature": "private int processDownloadedDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, Path deltaPath, Predicate<RepositoryObjectType> typePredicate)", "class_method_signature": "RrdpServiceImpl.processDownloadedDelta(RpkiRepository rpkiRepository, RpkiRepositoryValidationRun validationRun, Notification notification, DeltaInfo di, Path deltaPath, Predicate<RepositoryObjectType> typePredicate)", "testcase": false, "constructor": false}, {"identifier": "verifyAndOrderDeltaSerials", "parameters": "(final Notification notification, RpkiRepository rpkiRepository)", "modifiers": "private", "return": "List<DeltaInfo>", "signature": "List<DeltaInfo> verifyAndOrderDeltaSerials(final Notification notification, RpkiRepository rpkiRepository)", "full_signature": "private List<DeltaInfo> verifyAndOrderDeltaSerials(final Notification notification, RpkiRepository rpkiRepository)", "class_method_signature": "RrdpServiceImpl.verifyAndOrderDeltaSerials(final Notification notification, RpkiRepository rpkiRepository)", "testcase": false, "constructor": false}, {"identifier": "storeSnapshotObjects", "parameters": "(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "modifiers": "", "return": "int", "signature": "int storeSnapshotObjects(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "full_signature": " int storeSnapshotObjects(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "class_method_signature": "RrdpServiceImpl.storeSnapshotObjects(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "testcase": false, "constructor": false}, {"identifier": "storeSnapshotObject", "parameters": "(Tx.Write tx, RpkiRepositoryValidationRun validationRun, Either<ValidationResult, Pair<String, RpkiObject>> maybeRpkiObject, AtomicInteger counter)", "modifiers": "private", "return": "void", "signature": "void storeSnapshotObject(Tx.Write tx, RpkiRepositoryValidationRun validationRun, Either<ValidationResult, Pair<String, RpkiObject>> maybeRpkiObject, AtomicInteger counter)", "full_signature": "private void storeSnapshotObject(Tx.Write tx, RpkiRepositoryValidationRun validationRun, Either<ValidationResult, Pair<String, RpkiObject>> maybeRpkiObject, AtomicInteger counter)", "class_method_signature": "RrdpServiceImpl.storeSnapshotObject(Tx.Write tx, RpkiRepositoryValidationRun validationRun, Either<ValidationResult, Pair<String, RpkiObject>> maybeRpkiObject, AtomicInteger counter)", "testcase": false, "constructor": false}, {"identifier": "storeDeltaObjects", "parameters": "(final Tx.Write wtx,\n                                  final List<DeltaElement> deltaElements,\n                                  final RpkiRepositoryValidationRun validationRun)", "modifiers": "private", "return": "int", "signature": "int storeDeltaObjects(final Tx.Write wtx,\n                                  final List<DeltaElement> deltaElements,\n                                  final RpkiRepositoryValidationRun validationRun)", "full_signature": "private int storeDeltaObjects(final Tx.Write wtx,\n                                  final List<DeltaElement> deltaElements,\n                                  final RpkiRepositoryValidationRun validationRun)", "class_method_signature": "RrdpServiceImpl.storeDeltaObjects(final Tx.Write wtx,\n                                  final List<DeltaElement> deltaElements,\n                                  final RpkiRepositoryValidationRun validationRun)", "testcase": false, "constructor": false}, {"identifier": "applyDeltaWithdraw", "parameters": "(RpkiRepositoryValidationRun validationRun, String uri, DeltaWithdraw deltaWithdraw, Tx.Write tx)", "modifiers": "private", "return": "boolean", "signature": "boolean applyDeltaWithdraw(RpkiRepositoryValidationRun validationRun, String uri, DeltaWithdraw deltaWithdraw, Tx.Write tx)", "full_signature": "private boolean applyDeltaWithdraw(RpkiRepositoryValidationRun validationRun, String uri, DeltaWithdraw deltaWithdraw, Tx.Write tx)", "class_method_signature": "RrdpServiceImpl.applyDeltaWithdraw(RpkiRepositoryValidationRun validationRun, String uri, DeltaWithdraw deltaWithdraw, Tx.Write tx)", "testcase": false, "constructor": false}, {"identifier": "verifyDeltaIsApplicable", "parameters": "(Tx.Read tx, List<DeltaElement> pendingObjects)", "modifiers": "private", "return": "void", "signature": "void verifyDeltaIsApplicable(Tx.Read tx, List<DeltaElement> pendingObjects)", "full_signature": "private void verifyDeltaIsApplicable(Tx.Read tx, List<DeltaElement> pendingObjects)", "class_method_signature": "RrdpServiceImpl.verifyDeltaIsApplicable(Tx.Read tx, List<DeltaElement> pendingObjects)", "testcase": false, "constructor": false}, {"identifier": "checkObjectExists", "parameters": "(DeltaElement deltaElement, String errorCode, byte[] sha256, Tx.Read tx)", "modifiers": "private", "return": "void", "signature": "void checkObjectExists(DeltaElement deltaElement, String errorCode, byte[] sha256, Tx.Read tx)", "full_signature": "private void checkObjectExists(DeltaElement deltaElement, String errorCode, byte[] sha256, Tx.Read tx)", "class_method_signature": "RrdpServiceImpl.checkObjectExists(DeltaElement deltaElement, String errorCode, byte[] sha256, Tx.Read tx)", "testcase": false, "constructor": false}, {"identifier": "applyDeltaPublish", "parameters": "(final RpkiRepositoryValidationRun validationRun,\n                                      final String uri,\n                                      final DeltaPublish deltaPublish,\n                                      final Tx.Write tx)", "modifiers": "private", "return": "boolean", "signature": "boolean applyDeltaPublish(final RpkiRepositoryValidationRun validationRun,\n                                      final String uri,\n                                      final DeltaPublish deltaPublish,\n                                      final Tx.Write tx)", "full_signature": "private boolean applyDeltaPublish(final RpkiRepositoryValidationRun validationRun,\n                                      final String uri,\n                                      final DeltaPublish deltaPublish,\n                                      final Tx.Write tx)", "class_method_signature": "RrdpServiceImpl.applyDeltaPublish(final RpkiRepositoryValidationRun validationRun,\n                                      final String uri,\n                                      final DeltaPublish deltaPublish,\n                                      final Tx.Write tx)", "testcase": false, "constructor": false}], "file": "rpki-validator/src/main/java/net/ripe/rpki/validator3/rrdp/RrdpServiceImpl.java"}, "focal_method": {"identifier": "storeSnapshotObjects", "parameters": "(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "modifiers": "", "return": "int", "body": "int storeSnapshotObjects(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun) {\n        final AtomicInteger counter = new AtomicInteger();\n\n        // Parsing RPKI objects is CPU bound, so do this with any available threads\n        List<Either<ValidationResult, Pair<String, RpkiObject>>> converted = snapshotObjects.parallelStream().map((value) ->\n                RpkiObjectUtils.createRpkiObject(value.getUri(), value.getContent())\n        ).collect(Collectors.toList());\n\n        storage.writeTx0(tx -> converted.forEach((maybeRpkiObject) ->\n                storeSnapshotObject(tx, validationRun, maybeRpkiObject, counter)\n        ));\n\n        return counter.get();\n    }", "signature": "int storeSnapshotObjects(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "full_signature": " int storeSnapshotObjects(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "class_method_signature": "RrdpServiceImpl.storeSnapshotObjects(List<SnapshotObject> snapshotObjects,\n                             final RpkiRepositoryValidationRun validationRun)", "testcase": false, "constructor": false, "invocations": ["collect", "map", "parallelStream", "createRpkiObject", "getUri", "getContent", "toList", "writeTx0", "forEach", "storeSnapshotObject", "get"]}, "repository": {"repo_id": 104217624, "url": "https://github.com/RIPE-NCC/rpki-validator-3", "stars": 32, "created": "9/20/2017 1:15:05 PM +00:00", "updates": "2020-01-27T10:48:38+00:00", "fork": "False", "license": "licensed"}}