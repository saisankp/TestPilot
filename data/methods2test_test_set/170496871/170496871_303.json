{"test_class": {"identifier": "ComputeUtilsTest", "superclass": "extends GridCommonAbstractTest", "interfaces": "", "fields": [{"original_string": "private static final int NODE_COUNT = 10;", "modifier": "private static final", "type": "int", "declarator": "NODE_COUNT = 10", "var_name": "NODE_COUNT"}, {"original_string": "private Ignite ignite;", "modifier": "private", "type": "Ignite", "declarator": "ignite", "var_name": "ignite"}], "file": "modules/ml/src/test/java/org/apache/ignite/ml/dataset/impl/cache/util/ComputeUtilsTest.java"}, "test_case": {"identifier": "testGetData", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void testGetData() {\n        ClusterNode node = grid(1).cluster().localNode();\n\n        String upstreamCacheName = \"CACHE_1_\" + UUID.randomUUID();\n        String datasetCacheName = \"CACHE_2_\" + UUID.randomUUID();\n\n        CacheConfiguration<Integer, Integer> upstreamCacheConfiguration = new CacheConfiguration<>();\n        upstreamCacheConfiguration.setName(upstreamCacheName);\n        upstreamCacheConfiguration.setAffinity(new TestAffinityFunction(node));\n        IgniteCache<Integer, Integer> upstreamCache = ignite.createCache(upstreamCacheConfiguration);\n\n        CacheConfiguration<Integer, Integer> datasetCacheConfiguration = new CacheConfiguration<>();\n        datasetCacheConfiguration.setName(datasetCacheName);\n        datasetCacheConfiguration.setAffinity(new TestAffinityFunction(node));\n        IgniteCache<Integer, Integer> datasetCache = ignite.createCache(datasetCacheConfiguration);\n\n        upstreamCache.put(42, 42);\n        datasetCache.put(0, 0);\n\n        UUID datasetId = UUID.randomUUID();\n\n        IgniteAtomicLong cnt = ignite.atomicLong(\"CNT_\" + datasetId, 0, true);\n\n        for (int i = 0; i < 10; i++) {\n            Collection<TestPartitionData> data = ComputeUtils.affinityCallWithRetries(\n                ignite,\n                Arrays.asList(datasetCacheName, upstreamCacheName),\n                part -> ComputeUtils.<Integer, Integer, Serializable, TestPartitionData>getData(\n                    ignite,\n                    upstreamCacheName,\n                    (k, v) -> true,\n                    UpstreamTransformerBuilder.identity(),\n                    datasetCacheName,\n                    datasetId,\n                    (env, upstream, upstreamSize, ctx) -> {\n                        cnt.incrementAndGet();\n\n                        assertEquals(1, upstreamSize);\n\n                        UpstreamEntry<Integer, Integer> e = upstream.next();\n                        return new TestPartitionData(e.getKey() + e.getValue());\n                    },\n                    TestUtils.testEnvBuilder().buildForWorker(part),\n                    false\n                ),\n                0,\n                DeployingContext.unitialized()\n            );\n\n            assertEquals(1, data.size());\n\n            TestPartitionData dataElement = data.iterator().next();\n            assertEquals(84, dataElement.val.intValue());\n        }\n\n        assertEquals(1, cnt.get());\n    }", "signature": "void testGetData()", "full_signature": "@Test public void testGetData()", "class_method_signature": "ComputeUtilsTest.testGetData()", "testcase": true, "constructor": false, "invocations": ["localNode", "cluster", "grid", "randomUUID", "randomUUID", "setName", "setAffinity", "createCache", "setName", "setAffinity", "createCache", "put", "put", "randomUUID", "atomicLong", "affinityCallWithRetries", "asList", "getData", "identity", "incrementAndGet", "assertEquals", "next", "getKey", "getValue", "buildForWorker", "testEnvBuilder", "unitialized", "assertEquals", "size", "next", "iterator", "assertEquals", "intValue", "assertEquals", "get"]}, "focal_class": {"identifier": "ComputeUtils", "superclass": "", "interfaces": "", "fields": [{"original_string": "private static final String DATA_STORAGE_KEY_TEMPLATE = \"part_data_storage_%s\";", "modifier": "private static final", "type": "String", "declarator": "DATA_STORAGE_KEY_TEMPLATE = \"part_data_storage_%s\"", "var_name": "DATA_STORAGE_KEY_TEMPLATE"}, {"original_string": "private static final String ENVIRONMENT_STORAGE_KEY_TEMPLATE = \"part_environment_storage_%s\";", "modifier": "private static final", "type": "String", "declarator": "ENVIRONMENT_STORAGE_KEY_TEMPLATE = \"part_environment_storage_%s\"", "var_name": "ENVIRONMENT_STORAGE_KEY_TEMPLATE"}], "methods": [{"identifier": "affinityCallWithRetries", "parameters": "(Ignite ignite, Collection<String> cacheNames,\n        IgniteFunction<Integer, R> fun, int retries, int interval, DeployingContext deployingContext)", "modifiers": "public static", "return": "Collection<R>", "signature": "Collection<R> affinityCallWithRetries(Ignite ignite, Collection<String> cacheNames,\n        IgniteFunction<Integer, R> fun, int retries, int interval, DeployingContext deployingContext)", "full_signature": "public static Collection<R> affinityCallWithRetries(Ignite ignite, Collection<String> cacheNames,\n        IgniteFunction<Integer, R> fun, int retries, int interval, DeployingContext deployingContext)", "class_method_signature": "ComputeUtils.affinityCallWithRetries(Ignite ignite, Collection<String> cacheNames,\n        IgniteFunction<Integer, R> fun, int retries, int interval, DeployingContext deployingContext)", "testcase": false, "constructor": false}, {"identifier": "affinityCallWithRetries", "parameters": "(Ignite ignite, Collection<String> cacheNames,\n        IgniteFunction<Integer, R> fun, int retries, DeployingContext deployingContext)", "modifiers": "public static", "return": "Collection<R>", "signature": "Collection<R> affinityCallWithRetries(Ignite ignite, Collection<String> cacheNames,\n        IgniteFunction<Integer, R> fun, int retries, DeployingContext deployingContext)", "full_signature": "public static Collection<R> affinityCallWithRetries(Ignite ignite, Collection<String> cacheNames,\n        IgniteFunction<Integer, R> fun, int retries, DeployingContext deployingContext)", "class_method_signature": "ComputeUtils.affinityCallWithRetries(Ignite ignite, Collection<String> cacheNames,\n        IgniteFunction<Integer, R> fun, int retries, DeployingContext deployingContext)", "testcase": false, "constructor": false}, {"identifier": "getLearningEnvironment", "parameters": "(Ignite ignite,\n        UUID datasetId,\n        int part,\n        LearningEnvironmentBuilder envBuilder)", "modifiers": "public static", "return": "LearningEnvironment", "signature": "LearningEnvironment getLearningEnvironment(Ignite ignite,\n        UUID datasetId,\n        int part,\n        LearningEnvironmentBuilder envBuilder)", "full_signature": "public static LearningEnvironment getLearningEnvironment(Ignite ignite,\n        UUID datasetId,\n        int part,\n        LearningEnvironmentBuilder envBuilder)", "class_method_signature": "ComputeUtils.getLearningEnvironment(Ignite ignite,\n        UUID datasetId,\n        int part,\n        LearningEnvironmentBuilder envBuilder)", "testcase": false, "constructor": false}, {"identifier": "getData", "parameters": "(\n        Ignite ignite,\n        String upstreamCacheName, IgniteBiPredicate<K, V> filter,\n        UpstreamTransformerBuilder transformerBuilder,\n        String datasetCacheName, UUID datasetId,\n        PartitionDataBuilder<K, V, C, D> partDataBuilder,\n        LearningEnvironment env,\n        boolean isKeepBinary)", "modifiers": "public static", "return": "D", "signature": "D getData(\n        Ignite ignite,\n        String upstreamCacheName, IgniteBiPredicate<K, V> filter,\n        UpstreamTransformerBuilder transformerBuilder,\n        String datasetCacheName, UUID datasetId,\n        PartitionDataBuilder<K, V, C, D> partDataBuilder,\n        LearningEnvironment env,\n        boolean isKeepBinary)", "full_signature": "public static D getData(\n        Ignite ignite,\n        String upstreamCacheName, IgniteBiPredicate<K, V> filter,\n        UpstreamTransformerBuilder transformerBuilder,\n        String datasetCacheName, UUID datasetId,\n        PartitionDataBuilder<K, V, C, D> partDataBuilder,\n        LearningEnvironment env,\n        boolean isKeepBinary)", "class_method_signature": "ComputeUtils.getData(\n        Ignite ignite,\n        String upstreamCacheName, IgniteBiPredicate<K, V> filter,\n        UpstreamTransformerBuilder transformerBuilder,\n        String datasetCacheName, UUID datasetId,\n        PartitionDataBuilder<K, V, C, D> partDataBuilder,\n        LearningEnvironment env,\n        boolean isKeepBinary)", "testcase": false, "constructor": false}, {"identifier": "removeData", "parameters": "(Ignite ignite, UUID datasetId)", "modifiers": "public static", "return": "void", "signature": "void removeData(Ignite ignite, UUID datasetId)", "full_signature": "public static void removeData(Ignite ignite, UUID datasetId)", "class_method_signature": "ComputeUtils.removeData(Ignite ignite, UUID datasetId)", "testcase": false, "constructor": false}, {"identifier": "removeLearningEnv", "parameters": "(Ignite ignite, UUID datasetId)", "modifiers": "public static", "return": "void", "signature": "void removeLearningEnv(Ignite ignite, UUID datasetId)", "full_signature": "public static void removeLearningEnv(Ignite ignite, UUID datasetId)", "class_method_signature": "ComputeUtils.removeLearningEnv(Ignite ignite, UUID datasetId)", "testcase": false, "constructor": false}, {"identifier": "initContext", "parameters": "(\n        Ignite ignite,\n        String upstreamCacheName,\n        UpstreamTransformerBuilder transformerBuilder,\n        IgniteBiPredicate<K, V> filter,\n        String datasetCacheName,\n        PartitionContextBuilder<K, V, C> ctxBuilder,\n        LearningEnvironmentBuilder envBuilder,\n        int retries,\n        int interval,\n        boolean isKeepBinary,\n        DeployingContext deployingContext)", "modifiers": "public static", "return": "void", "signature": "void initContext(\n        Ignite ignite,\n        String upstreamCacheName,\n        UpstreamTransformerBuilder transformerBuilder,\n        IgniteBiPredicate<K, V> filter,\n        String datasetCacheName,\n        PartitionContextBuilder<K, V, C> ctxBuilder,\n        LearningEnvironmentBuilder envBuilder,\n        int retries,\n        int interval,\n        boolean isKeepBinary,\n        DeployingContext deployingContext)", "full_signature": "public static void initContext(\n        Ignite ignite,\n        String upstreamCacheName,\n        UpstreamTransformerBuilder transformerBuilder,\n        IgniteBiPredicate<K, V> filter,\n        String datasetCacheName,\n        PartitionContextBuilder<K, V, C> ctxBuilder,\n        LearningEnvironmentBuilder envBuilder,\n        int retries,\n        int interval,\n        boolean isKeepBinary,\n        DeployingContext deployingContext)", "class_method_signature": "ComputeUtils.initContext(\n        Ignite ignite,\n        String upstreamCacheName,\n        UpstreamTransformerBuilder transformerBuilder,\n        IgniteBiPredicate<K, V> filter,\n        String datasetCacheName,\n        PartitionContextBuilder<K, V, C> ctxBuilder,\n        LearningEnvironmentBuilder envBuilder,\n        int retries,\n        int interval,\n        boolean isKeepBinary,\n        DeployingContext deployingContext)", "testcase": false, "constructor": false}, {"identifier": "getContext", "parameters": "(Ignite ignite, String datasetCacheName, int part)", "modifiers": "public static", "return": "C", "signature": "C getContext(Ignite ignite, String datasetCacheName, int part)", "full_signature": "public static C getContext(Ignite ignite, String datasetCacheName, int part)", "class_method_signature": "ComputeUtils.getContext(Ignite ignite, String datasetCacheName, int part)", "testcase": false, "constructor": false}, {"identifier": "saveContext", "parameters": "(Ignite ignite, String datasetCacheName, int part, C ctx)", "modifiers": "public static", "return": "void", "signature": "void saveContext(Ignite ignite, String datasetCacheName, int part, C ctx)", "full_signature": "public static void saveContext(Ignite ignite, String datasetCacheName, int part, C ctx)", "class_method_signature": "ComputeUtils.saveContext(Ignite ignite, String datasetCacheName, int part, C ctx)", "testcase": false, "constructor": false}, {"identifier": "computeCount", "parameters": "(\n        IgniteCache<K, V> cache,\n        ScanQuery<K, V> qry,\n        UpstreamTransformer transformer)", "modifiers": "private static", "return": "long", "signature": "long computeCount(\n        IgniteCache<K, V> cache,\n        ScanQuery<K, V> qry,\n        UpstreamTransformer transformer)", "full_signature": "private static long computeCount(\n        IgniteCache<K, V> cache,\n        ScanQuery<K, V> qry,\n        UpstreamTransformer transformer)", "class_method_signature": "ComputeUtils.computeCount(\n        IgniteCache<K, V> cache,\n        ScanQuery<K, V> qry,\n        UpstreamTransformer transformer)", "testcase": false, "constructor": false}, {"identifier": "computeCount", "parameters": "(Iterator<?> iter)", "modifiers": "private static", "return": "long", "signature": "long computeCount(Iterator<?> iter)", "full_signature": "private static long computeCount(Iterator<?> iter)", "class_method_signature": "ComputeUtils.computeCount(Iterator<?> iter)", "testcase": false, "constructor": false}], "file": "modules/ml/src/main/java/org/apache/ignite/ml/dataset/impl/cache/util/ComputeUtils.java"}, "focal_method": {"identifier": "getData", "parameters": "(\n        Ignite ignite,\n        String upstreamCacheName, IgniteBiPredicate<K, V> filter,\n        UpstreamTransformerBuilder transformerBuilder,\n        String datasetCacheName, UUID datasetId,\n        PartitionDataBuilder<K, V, C, D> partDataBuilder,\n        LearningEnvironment env,\n        boolean isKeepBinary)", "modifiers": "public static", "return": "D", "body": "public static <K, V, C extends Serializable, D extends AutoCloseable> D getData(\n        Ignite ignite,\n        String upstreamCacheName, IgniteBiPredicate<K, V> filter,\n        UpstreamTransformerBuilder transformerBuilder,\n        String datasetCacheName, UUID datasetId,\n        PartitionDataBuilder<K, V, C, D> partDataBuilder,\n        LearningEnvironment env,\n        boolean isKeepBinary) {\n\n        PartitionDataStorage dataStorage = (PartitionDataStorage)ignite\n            .cluster()\n            .nodeLocalMap()\n            .computeIfAbsent(String.format(DATA_STORAGE_KEY_TEMPLATE, datasetId), key -> new PartitionDataStorage(env.dataTtl()));\n\n        final int part = env.partition();\n\n        return dataStorage.computeDataIfAbsent(part, () -> {\n            IgniteCache<Integer, C> learningCtxCache = ignite.cache(datasetCacheName);\n            C ctx = learningCtxCache.get(part);\n\n            IgniteCache<K, V> upstreamCache = ignite.cache(upstreamCacheName);\n\n            if (isKeepBinary)\n                upstreamCache = upstreamCache.withKeepBinary();\n\n            ScanQuery<K, V> qry = new ScanQuery<>();\n            qry.setLocal(true);\n            qry.setPartition(part);\n            qry.setFilter(filter);\n\n            UpstreamTransformer transformer = transformerBuilder.build(env);\n            UpstreamTransformer transformerCp = Utils.copy(transformer);\n\n            long cnt = computeCount(upstreamCache, qry, transformer);\n\n            if (cnt > 0) {\n                try (QueryCursor<UpstreamEntry<K, V>> cursor = upstreamCache.query(qry,\n                    e -> new UpstreamEntry<>(e.getKey(), e.getValue()))) {\n\n                    Iterator<UpstreamEntry<K, V>> it = cursor.iterator();\n                    Stream<UpstreamEntry> transformedStream = transformerCp.transform(Utils.asStream(it, cnt).map(x -> (UpstreamEntry)x));\n                    it = Utils.asStream(transformedStream.iterator()).map(x -> (UpstreamEntry<K, V>)x).iterator();\n\n                    Iterator<UpstreamEntry<K, V>> iter = new IteratorWithConcurrentModificationChecker<>(it, cnt,\n                        \"Cache expected to be not modified during dataset data building [partition=\" + part + ']');\n\n                    return partDataBuilder.build(env, iter, cnt, ctx);\n                }\n            }\n\n            return null;\n        });\n    }", "signature": "D getData(\n        Ignite ignite,\n        String upstreamCacheName, IgniteBiPredicate<K, V> filter,\n        UpstreamTransformerBuilder transformerBuilder,\n        String datasetCacheName, UUID datasetId,\n        PartitionDataBuilder<K, V, C, D> partDataBuilder,\n        LearningEnvironment env,\n        boolean isKeepBinary)", "full_signature": "public static D getData(\n        Ignite ignite,\n        String upstreamCacheName, IgniteBiPredicate<K, V> filter,\n        UpstreamTransformerBuilder transformerBuilder,\n        String datasetCacheName, UUID datasetId,\n        PartitionDataBuilder<K, V, C, D> partDataBuilder,\n        LearningEnvironment env,\n        boolean isKeepBinary)", "class_method_signature": "ComputeUtils.getData(\n        Ignite ignite,\n        String upstreamCacheName, IgniteBiPredicate<K, V> filter,\n        UpstreamTransformerBuilder transformerBuilder,\n        String datasetCacheName, UUID datasetId,\n        PartitionDataBuilder<K, V, C, D> partDataBuilder,\n        LearningEnvironment env,\n        boolean isKeepBinary)", "testcase": false, "constructor": false, "invocations": ["computeIfAbsent", "nodeLocalMap", "cluster", "format", "dataTtl", "partition", "computeDataIfAbsent", "cache", "get", "cache", "withKeepBinary", "setLocal", "setPartition", "setFilter", "build", "copy", "computeCount", "query", "getKey", "getValue", "iterator", "transform", "map", "asStream", "iterator", "map", "asStream", "iterator", "build"]}, "repository": {"repo_id": 170496871, "url": "https://github.com/gridgain/gridgain", "stars": 46, "created": "2/13/2019 11:31:35 AM +00:00", "updates": "2020-01-27T16:02:24+00:00", "fork": "False", "license": "licensed"}}