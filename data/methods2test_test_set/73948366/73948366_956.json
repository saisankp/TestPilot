{"test_class": {"identifier": "CloudStoreTest", "superclass": "", "interfaces": "", "fields": [{"original_string": "private final static String AWS_INSTANCE_DOCUMENT = \"{\\n\"\n            + \"  \\\"devpayProductCodes\\\" : null,\\n\"\n            + \"  \\\"availabilityZone\\\" : \\\"us-west-2a\\\",\\n\"\n            + \"  \\\"privateIp\\\" : \\\"10.10.10.10\\\",\\n\"\n            + \"  \\\"version\\\" : \\\"2010-08-31\\\",\\n\"\n            + \"  \\\"instanceId\\\" : \\\"i-056921225f1fbb47a\\\",\\n\"\n            + \"  \\\"billingProducts\\\" : null,\\n\"\n            + \"  \\\"instanceType\\\" : \\\"t2.micro\\\",\\n\"\n            + \"  \\\"accountId\\\" : \\\"111111111111\\\",\\n\"\n            + \"  \\\"pendingTime\\\" : \\\"2016-04-26T05:37:23Z\\\",\\n\"\n            + \"  \\\"imageId\\\" : \\\"ami-c229c0a2\\\",\\n\"\n            + \"  \\\"architecture\\\" : \\\"x86_64\\\",\\n\"\n            + \"  \\\"kernelId\\\" : null,\\n\"\n            + \"  \\\"ramdiskId\\\" : null,\\n\"\n            + \"  \\\"region\\\" : \\\"us-west-2\\\"\\n\"\n            + \"}\";", "modifier": "private final static", "type": "String", "declarator": "AWS_INSTANCE_DOCUMENT = \"{\\n\"\n            + \"  \\\"devpayProductCodes\\\" : null,\\n\"\n            + \"  \\\"availabilityZone\\\" : \\\"us-west-2a\\\",\\n\"\n            + \"  \\\"privateIp\\\" : \\\"10.10.10.10\\\",\\n\"\n            + \"  \\\"version\\\" : \\\"2010-08-31\\\",\\n\"\n            + \"  \\\"instanceId\\\" : \\\"i-056921225f1fbb47a\\\",\\n\"\n            + \"  \\\"billingProducts\\\" : null,\\n\"\n            + \"  \\\"instanceType\\\" : \\\"t2.micro\\\",\\n\"\n            + \"  \\\"accountId\\\" : \\\"111111111111\\\",\\n\"\n            + \"  \\\"pendingTime\\\" : \\\"2016-04-26T05:37:23Z\\\",\\n\"\n            + \"  \\\"imageId\\\" : \\\"ami-c229c0a2\\\",\\n\"\n            + \"  \\\"architecture\\\" : \\\"x86_64\\\",\\n\"\n            + \"  \\\"kernelId\\\" : null,\\n\"\n            + \"  \\\"ramdiskId\\\" : null,\\n\"\n            + \"  \\\"region\\\" : \\\"us-west-2\\\"\\n\"\n            + \"}\"", "var_name": "AWS_INSTANCE_DOCUMENT"}, {"original_string": "private final static String AWS_IAM_ROLE_INFO = \"{\\n\"\n            + \"\\\"Code\\\" : \\\"Success\\\",\\n\"\n            + \"\\\"LastUpdated\\\" : \\\"2016-04-26T05:37:04Z\\\",\\n\"\n            + \"\\\"InstanceProfileArn\\\" : \\\"arn:aws:iam::111111111111:instance-profile/athenz.zts,athenz\\\",\\n\"\n            + \"\\\"InstanceProfileId\\\" : \\\"AIPAJAVNLUGEWFWTIDPRA\\\"\\n\"\n            + \"}\";", "modifier": "private final static", "type": "String", "declarator": "AWS_IAM_ROLE_INFO = \"{\\n\"\n            + \"\\\"Code\\\" : \\\"Success\\\",\\n\"\n            + \"\\\"LastUpdated\\\" : \\\"2016-04-26T05:37:04Z\\\",\\n\"\n            + \"\\\"InstanceProfileArn\\\" : \\\"arn:aws:iam::111111111111:instance-profile/athenz.zts,athenz\\\",\\n\"\n            + \"\\\"InstanceProfileId\\\" : \\\"AIPAJAVNLUGEWFWTIDPRA\\\"\\n\"\n            + \"}\"", "var_name": "AWS_IAM_ROLE_INFO"}], "file": "servers/zts/src/test/java/com/yahoo/athenz/zts/store/CloudStoreTest.java"}, "test_case": {"identifier": "testAssumeAWSRole", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void testAssumeAWSRole() {\n        MockCloudStore cloudStore = new MockCloudStore();\n        cloudStore.awsEnabled = true;\n        AssumeRoleResult mockResult = Mockito.mock(AssumeRoleResult.class);\n        Credentials creds = Mockito.mock(Credentials.class);\n        Mockito.when(creds.getAccessKeyId()).thenReturn(\"accesskeyid\");\n        Mockito.when(creds.getSecretAccessKey()).thenReturn(\"secretaccesskey\");\n        Mockito.when(creds.getSessionToken()).thenReturn(\"sessiontoken\");\n        Mockito.when(creds.getExpiration()).thenReturn(new Date());\n        Mockito.when(mockResult.getCredentials()).thenReturn(creds);\n        cloudStore.setAssumeRoleResult(mockResult);\n        cloudStore.setReturnSuperAWSRole(true);\n\n        AWSTemporaryCredentials awsCreds = cloudStore.assumeAWSRole(\"account\", \"syncer\", \"athenz.syncer\", null, null);\n        assertNotNull(awsCreds);\n        assertEquals(awsCreds.getAccessKeyId(), \"accesskeyid\");\n        assertEquals(awsCreds.getSessionToken(), \"sessiontoken\");\n        assertEquals(awsCreds.getSecretAccessKey(), \"secretaccesskey\");\n        cloudStore.close();\n    }", "signature": "void testAssumeAWSRole()", "full_signature": "@Test public void testAssumeAWSRole()", "class_method_signature": "CloudStoreTest.testAssumeAWSRole()", "testcase": true, "constructor": false, "invocations": ["mock", "mock", "thenReturn", "when", "getAccessKeyId", "thenReturn", "when", "getSecretAccessKey", "thenReturn", "when", "getSessionToken", "thenReturn", "when", "getExpiration", "thenReturn", "when", "getCredentials", "setAssumeRoleResult", "setReturnSuperAWSRole", "assumeAWSRole", "assertNotNull", "assertEquals", "getAccessKeyId", "assertEquals", "getSessionToken", "assertEquals", "getSecretAccessKey", "close"]}, "focal_class": {"identifier": "CloudStore", "superclass": "", "interfaces": "", "fields": [{"original_string": "private static final Logger LOGGER = LoggerFactory.getLogger(CloudStore.class);", "modifier": "private static final", "type": "Logger", "declarator": "LOGGER = LoggerFactory.getLogger(CloudStore.class)", "var_name": "LOGGER"}, {"original_string": "private static final String AWS_ROLE_SESSION_NAME = \"athenz-zts-service\";", "modifier": "private static final", "type": "String", "declarator": "AWS_ROLE_SESSION_NAME = \"athenz-zts-service\"", "var_name": "AWS_ROLE_SESSION_NAME"}, {"original_string": "String awsRole = null;", "modifier": "", "type": "String", "declarator": "awsRole = null", "var_name": "awsRole"}, {"original_string": "String awsRegion;", "modifier": "", "type": "String", "declarator": "awsRegion", "var_name": "awsRegion"}, {"original_string": "boolean awsEnabled;", "modifier": "", "type": "boolean", "declarator": "awsEnabled", "var_name": "awsEnabled"}, {"original_string": "int cacheTimeout;", "modifier": "", "type": "int", "declarator": "cacheTimeout", "var_name": "cacheTimeout"}, {"original_string": "int invalidCacheTimeout;", "modifier": "", "type": "int", "declarator": "invalidCacheTimeout", "var_name": "invalidCacheTimeout"}, {"original_string": "BasicSessionCredentials credentials;", "modifier": "", "type": "BasicSessionCredentials", "declarator": "credentials", "var_name": "credentials"}, {"original_string": "private Map<String, String> cloudAccountCache;", "modifier": "private", "type": "Map<String, String>", "declarator": "cloudAccountCache", "var_name": "cloudAccountCache"}, {"original_string": "ConcurrentHashMap<String, AWSTemporaryCredentials> awsCredsCache;", "modifier": "", "type": "ConcurrentHashMap<String, AWSTemporaryCredentials>", "declarator": "awsCredsCache", "var_name": "awsCredsCache"}, {"original_string": "ConcurrentHashMap<String, Long> awsInvalidCredsCache;", "modifier": "", "type": "ConcurrentHashMap<String, Long>", "declarator": "awsInvalidCredsCache", "var_name": "awsInvalidCredsCache"}, {"original_string": "private HttpClient httpClient;", "modifier": "private", "type": "HttpClient", "declarator": "httpClient", "var_name": "httpClient"}, {"original_string": "private ScheduledExecutorService scheduledThreadPool = null;", "modifier": "private", "type": "ScheduledExecutorService", "declarator": "scheduledThreadPool = null", "var_name": "scheduledThreadPool"}], "methods": [{"identifier": "CloudStore", "parameters": "()", "modifiers": "public", "return": "", "signature": " CloudStore()", "full_signature": "public  CloudStore()", "class_method_signature": "CloudStore.CloudStore()", "testcase": false, "constructor": true}, {"identifier": "setupHttpClient", "parameters": "(HttpClient client)", "modifiers": "", "return": "void", "signature": "void setupHttpClient(HttpClient client)", "full_signature": " void setupHttpClient(HttpClient client)", "class_method_signature": "CloudStore.setupHttpClient(HttpClient client)", "testcase": false, "constructor": false}, {"identifier": "close", "parameters": "()", "modifiers": "public", "return": "void", "signature": "void close()", "full_signature": "public void close()", "class_method_signature": "CloudStore.close()", "testcase": false, "constructor": false}, {"identifier": "setHttpClient", "parameters": "(HttpClient client)", "modifiers": "public", "return": "void", "signature": "void setHttpClient(HttpClient client)", "full_signature": "public void setHttpClient(HttpClient client)", "class_method_signature": "CloudStore.setHttpClient(HttpClient client)", "testcase": false, "constructor": false}, {"identifier": "stopHttpClient", "parameters": "()", "modifiers": "private", "return": "void", "signature": "void stopHttpClient()", "full_signature": "private void stopHttpClient()", "class_method_signature": "CloudStore.stopHttpClient()", "testcase": false, "constructor": false}, {"identifier": "isAwsEnabled", "parameters": "()", "modifiers": "public", "return": "boolean", "signature": "boolean isAwsEnabled()", "full_signature": "public boolean isAwsEnabled()", "class_method_signature": "CloudStore.isAwsEnabled()", "testcase": false, "constructor": false}, {"identifier": "initializeAwsSupport", "parameters": "()", "modifiers": "", "return": "void", "signature": "void initializeAwsSupport()", "full_signature": " void initializeAwsSupport()", "class_method_signature": "CloudStore.initializeAwsSupport()", "testcase": false, "constructor": false}, {"identifier": "getS3Client", "parameters": "()", "modifiers": "public", "return": "AmazonS3", "signature": "AmazonS3 getS3Client()", "full_signature": "public AmazonS3 getS3Client()", "class_method_signature": "CloudStore.getS3Client()", "testcase": false, "constructor": false}, {"identifier": "loadBootMetaData", "parameters": "()", "modifiers": "", "return": "boolean", "signature": "boolean loadBootMetaData()", "full_signature": " boolean loadBootMetaData()", "class_method_signature": "CloudStore.loadBootMetaData()", "testcase": false, "constructor": false}, {"identifier": "parseInstanceInfo", "parameters": "(String document)", "modifiers": "", "return": "boolean", "signature": "boolean parseInstanceInfo(String document)", "full_signature": " boolean parseInstanceInfo(String document)", "class_method_signature": "CloudStore.parseInstanceInfo(String document)", "testcase": false, "constructor": false}, {"identifier": "parseIamRoleInfo", "parameters": "(String iamRole)", "modifiers": "", "return": "boolean", "signature": "boolean parseIamRoleInfo(String iamRole)", "full_signature": " boolean parseIamRoleInfo(String iamRole)", "class_method_signature": "CloudStore.parseIamRoleInfo(String iamRole)", "testcase": false, "constructor": false}, {"identifier": "parseInstanceProfileArn", "parameters": "(String profileArn)", "modifiers": "", "return": "boolean", "signature": "boolean parseInstanceProfileArn(String profileArn)", "full_signature": " boolean parseInstanceProfileArn(String profileArn)", "class_method_signature": "CloudStore.parseInstanceProfileArn(String profileArn)", "testcase": false, "constructor": false}, {"identifier": "fetchRoleCredentials", "parameters": "()", "modifiers": "", "return": "boolean", "signature": "boolean fetchRoleCredentials()", "full_signature": " boolean fetchRoleCredentials()", "class_method_signature": "CloudStore.fetchRoleCredentials()", "testcase": false, "constructor": false}, {"identifier": "getMetaData", "parameters": "(String path)", "modifiers": "", "return": "String", "signature": "String getMetaData(String path)", "full_signature": " String getMetaData(String path)", "class_method_signature": "CloudStore.getMetaData(String path)", "testcase": false, "constructor": false}, {"identifier": "getAssumeRoleRequest", "parameters": "(String account, String roleName, String principal,\n                                           Integer durationSeconds, String externalId)", "modifiers": "", "return": "AssumeRoleRequest", "signature": "AssumeRoleRequest getAssumeRoleRequest(String account, String roleName, String principal,\n                                           Integer durationSeconds, String externalId)", "full_signature": " AssumeRoleRequest getAssumeRoleRequest(String account, String roleName, String principal,\n                                           Integer durationSeconds, String externalId)", "class_method_signature": "CloudStore.getAssumeRoleRequest(String account, String roleName, String principal,\n                                           Integer durationSeconds, String externalId)", "testcase": false, "constructor": false}, {"identifier": "getTokenServiceClient", "parameters": "()", "modifiers": "", "return": "AWSSecurityTokenService", "signature": "AWSSecurityTokenService getTokenServiceClient()", "full_signature": " AWSSecurityTokenService getTokenServiceClient()", "class_method_signature": "CloudStore.getTokenServiceClient()", "testcase": false, "constructor": false}, {"identifier": "getCacheKey", "parameters": "(final String account, final String roleName, final String principal,\n                       Integer durationSeconds, final String externalId)", "modifiers": "", "return": "String", "signature": "String getCacheKey(final String account, final String roleName, final String principal,\n                       Integer durationSeconds, final String externalId)", "full_signature": " String getCacheKey(final String account, final String roleName, final String principal,\n                       Integer durationSeconds, final String externalId)", "class_method_signature": "CloudStore.getCacheKey(final String account, final String roleName, final String principal,\n                       Integer durationSeconds, final String externalId)", "testcase": false, "constructor": false}, {"identifier": "removeExpiredCredentials", "parameters": "()", "modifiers": "", "return": "boolean", "signature": "boolean removeExpiredCredentials()", "full_signature": " boolean removeExpiredCredentials()", "class_method_signature": "CloudStore.removeExpiredCredentials()", "testcase": false, "constructor": false}, {"identifier": "removeExpiredInvalidCredentials", "parameters": "()", "modifiers": "", "return": "boolean", "signature": "boolean removeExpiredInvalidCredentials()", "full_signature": " boolean removeExpiredInvalidCredentials()", "class_method_signature": "CloudStore.removeExpiredInvalidCredentials()", "testcase": false, "constructor": false}, {"identifier": "isFailedTempCredsRequest", "parameters": "(final String cacheKey)", "modifiers": "", "return": "boolean", "signature": "boolean isFailedTempCredsRequest(final String cacheKey)", "full_signature": " boolean isFailedTempCredsRequest(final String cacheKey)", "class_method_signature": "CloudStore.isFailedTempCredsRequest(final String cacheKey)", "testcase": false, "constructor": false}, {"identifier": "putInvalidCacheCreds", "parameters": "(final String key)", "modifiers": "", "return": "void", "signature": "void putInvalidCacheCreds(final String key)", "full_signature": " void putInvalidCacheCreds(final String key)", "class_method_signature": "CloudStore.putInvalidCacheCreds(final String key)", "testcase": false, "constructor": false}, {"identifier": "getCachedCreds", "parameters": "(final String cacheKey, Integer durationSeconds)", "modifiers": "", "return": "AWSTemporaryCredentials", "signature": "AWSTemporaryCredentials getCachedCreds(final String cacheKey, Integer durationSeconds)", "full_signature": " AWSTemporaryCredentials getCachedCreds(final String cacheKey, Integer durationSeconds)", "class_method_signature": "CloudStore.getCachedCreds(final String cacheKey, Integer durationSeconds)", "testcase": false, "constructor": false}, {"identifier": "putCacheCreds", "parameters": "(final String key, AWSTemporaryCredentials tempCreds)", "modifiers": "", "return": "void", "signature": "void putCacheCreds(final String key, AWSTemporaryCredentials tempCreds)", "full_signature": " void putCacheCreds(final String key, AWSTemporaryCredentials tempCreds)", "class_method_signature": "CloudStore.putCacheCreds(final String key, AWSTemporaryCredentials tempCreds)", "testcase": false, "constructor": false}, {"identifier": "assumeAWSRole", "parameters": "(String account, String roleName, String principal,\n                                                 Integer durationSeconds, String externalId)", "modifiers": "public", "return": "AWSTemporaryCredentials", "signature": "AWSTemporaryCredentials assumeAWSRole(String account, String roleName, String principal,\n                                                 Integer durationSeconds, String externalId)", "full_signature": "public AWSTemporaryCredentials assumeAWSRole(String account, String roleName, String principal,\n                                                 Integer durationSeconds, String externalId)", "class_method_signature": "CloudStore.assumeAWSRole(String account, String roleName, String principal,\n                                                 Integer durationSeconds, String externalId)", "testcase": false, "constructor": false}, {"identifier": "getCloudAccount", "parameters": "(String domainName)", "modifiers": "public", "return": "String", "signature": "String getCloudAccount(String domainName)", "full_signature": "public String getCloudAccount(String domainName)", "class_method_signature": "CloudStore.getCloudAccount(String domainName)", "testcase": false, "constructor": false}, {"identifier": "updateAccount", "parameters": "(String domainName, String account)", "modifiers": "", "return": "void", "signature": "void updateAccount(String domainName, String account)", "full_signature": " void updateAccount(String domainName, String account)", "class_method_signature": "CloudStore.updateAccount(String domainName, String account)", "testcase": false, "constructor": false}, {"identifier": "getSshKeyReqType", "parameters": "(String sshKeyReq)", "modifiers": "", "return": "String", "signature": "String getSshKeyReqType(String sshKeyReq)", "full_signature": " String getSshKeyReqType(String sshKeyReq)", "class_method_signature": "CloudStore.getSshKeyReqType(String sshKeyReq)", "testcase": false, "constructor": false}], "file": "servers/zts/src/main/java/com/yahoo/athenz/zts/store/CloudStore.java"}, "focal_method": {"identifier": "assumeAWSRole", "parameters": "(String account, String roleName, String principal,\n                                                 Integer durationSeconds, String externalId)", "modifiers": "public", "return": "AWSTemporaryCredentials", "body": "public AWSTemporaryCredentials assumeAWSRole(String account, String roleName, String principal,\n                                                 Integer durationSeconds, String externalId) {\n\n        if (!awsEnabled) {\n            throw new ResourceException(ResourceException.INTERNAL_SERVER_ERROR,\n                    \"AWS Support not enabled\");\n        }\n\n        // first check to see if we already have the temp creds cached\n\n        final String cacheKey = getCacheKey(account, roleName, principal,\n                durationSeconds, externalId);\n        AWSTemporaryCredentials tempCreds = getCachedCreds(cacheKey, durationSeconds);\n        if (tempCreds != null) {\n            return tempCreds;\n        }\n\n        // before going to AWS STS, check if we have the request in our failed\n        // cache since we don't want to generate too many requests AWS STS\n        // and eventually become rate limited\n\n        if (isFailedTempCredsRequest(cacheKey)) {\n            LOGGER.error(\"CloudStore: assumeAWSRole - failed cached request for account {} with role: {}\",\n                    account, roleName);\n            return null;\n        }\n\n        AssumeRoleRequest req = getAssumeRoleRequest(account, roleName, principal,\n                durationSeconds, externalId);\n\n        try {\n            AWSSecurityTokenService client = getTokenServiceClient();\n            AssumeRoleResult res = client.assumeRole(req);\n\n            Credentials awsCreds = res.getCredentials();\n            tempCreds = new AWSTemporaryCredentials()\n                    .setAccessKeyId(awsCreds.getAccessKeyId())\n                    .setSecretAccessKey(awsCreds.getSecretAccessKey())\n                    .setSessionToken(awsCreds.getSessionToken())\n                    .setExpiration(Timestamp.fromMillis(awsCreds.getExpiration().getTime()));\n\n        } catch (AmazonServiceException ex) {\n\n            LOGGER.error(\"CloudStore: assumeAWSRole - unable to assume role: {}, error: {}, status code: {}\",\n                    req.getRoleArn(), ex.getMessage(), ex.getStatusCode());\n\n            // if this is access denied then we're going to cache\n            // the failed results\n\n            if (ex.getStatusCode() == ResourceException.FORBIDDEN) {\n                putInvalidCacheCreds(cacheKey);\n            }\n\n            return null;\n\n        } catch (Exception ex) {\n\n            LOGGER.error(\"CloudStore: assumeAWSRole - unable to assume role: {}, error: {}\",\n                    req.getRoleArn(), ex.getMessage());\n\n            return null;\n        }\n\n        putCacheCreds(cacheKey, tempCreds);\n        return tempCreds;\n    }", "signature": "AWSTemporaryCredentials assumeAWSRole(String account, String roleName, String principal,\n                                                 Integer durationSeconds, String externalId)", "full_signature": "public AWSTemporaryCredentials assumeAWSRole(String account, String roleName, String principal,\n                                                 Integer durationSeconds, String externalId)", "class_method_signature": "CloudStore.assumeAWSRole(String account, String roleName, String principal,\n                                                 Integer durationSeconds, String externalId)", "testcase": false, "constructor": false, "invocations": ["getCacheKey", "getCachedCreds", "isFailedTempCredsRequest", "error", "getAssumeRoleRequest", "getTokenServiceClient", "assumeRole", "getCredentials", "setExpiration", "setSessionToken", "setSecretAccessKey", "setAccessKeyId", "getAccessKeyId", "getSecretAccessKey", "getSessionToken", "fromMillis", "getTime", "getExpiration", "error", "getRoleArn", "getMessage", "getStatusCode", "getStatusCode", "putInvalidCacheCreds", "error", "getRoleArn", "getMessage", "putCacheCreds"]}, "repository": {"repo_id": 73948366, "url": "https://github.com/yahoo/athenz", "stars": 394, "created": "11/16/2016 6:23:08 PM +00:00", "updates": "2020-01-27T15:36:13+00:00", "fork": "False", "license": "licensed"}}