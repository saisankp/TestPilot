{"test_class": {"identifier": "ValidationRunCleanupServiceTest", "superclass": "extends GenericStorageTest", "interfaces": "", "fields": [{"original_string": "@Autowired\n    private TrustAnchorsFactory factory;", "modifier": "@Autowired\n    private", "type": "TrustAnchorsFactory", "declarator": "factory", "var_name": "factory"}, {"original_string": "@Autowired\n    private ValidationRunCleanupService subject;", "modifier": "@Autowired\n    private", "type": "ValidationRunCleanupService", "declarator": "subject", "var_name": "subject"}, {"original_string": "private TrustAnchor testTA1;", "modifier": "private", "type": "TrustAnchor", "declarator": "testTA1", "var_name": "testTA1"}, {"original_string": "private Ref<TrustAnchor> testTARef1;", "modifier": "private", "type": "Ref<TrustAnchor>", "declarator": "testTARef1", "var_name": "testTARef1"}, {"original_string": "private List<RoaPrefix> roaPrefixes1 = Collections.singletonList(RoaPrefix.of(IpRange.parse(\"127.0.0.0/8\"), null, Asn.parse(\"123\"),\n            DateTime.now().toInstant().getMillis(),\n            DateTime.now().plusYears(1).toInstant().getMillis(),\n            TrustAnchorsFactory.nextSerial()));", "modifier": "private", "type": "List<RoaPrefix>", "declarator": "roaPrefixes1 = Collections.singletonList(RoaPrefix.of(IpRange.parse(\"127.0.0.0/8\"), null, Asn.parse(\"123\"),\n            DateTime.now().toInstant().getMillis(),\n            DateTime.now().plusYears(1).toInstant().getMillis(),\n            TrustAnchorsFactory.nextSerial()))", "var_name": "roaPrefixes1"}, {"original_string": "private List<RoaPrefix> roaPrefixes2 = Collections.singletonList(RoaPrefix.of(IpRange.parse(\"128.0.0.0/8\"), null, Asn.parse(\"124\"),\n            DateTime.now().toInstant().getMillis(),\n            DateTime.now().plusYears(1).toInstant().getMillis(),\n            TrustAnchorsFactory.nextSerial()));", "modifier": "private", "type": "List<RoaPrefix>", "declarator": "roaPrefixes2 = Collections.singletonList(RoaPrefix.of(IpRange.parse(\"128.0.0.0/8\"), null, Asn.parse(\"124\"),\n            DateTime.now().toInstant().getMillis(),\n            DateTime.now().plusYears(1).toInstant().getMillis(),\n            TrustAnchorsFactory.nextSerial()))", "var_name": "roaPrefixes2"}], "file": "rpki-validator/src/test/java/net/ripe/rpki/validator3/domain/cleanup/ValidationRunCleanupServiceTest.java"}, "test_case": {"identifier": "shouldCleanUpOldValidationRunDontDeleteLastSuccessfulPerTA", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void shouldCleanUpOldValidationRunDontDeleteLastSuccessfulPerTA() {\n\n        TrustAnchor testTA2 = wtx(tx -> factory.createTrustAnchor(tx, ta -> ta.roaPrefixes(roaPrefixes2)));\n        wtx0(tx -> getTrustAnchors().add(tx, testTA2));\n\n        Ref<TrustAnchor> testTARef2 = getStorage().readTx(tx -> getTrustAnchors().makeRef(tx, testTA1.key()));\n\n        final InstantWithoutNanos lastMonth = InstantWithoutNanos.now().minus(Duration.ofDays(30));\n        CertificateTreeValidationRun oldValidationRun = new CertificateTreeValidationRun(testTARef1);\n        oldValidationRun.setCreatedAt(lastMonth);\n        oldValidationRun.setCompletedAt(lastMonth);\n        wtx0(tx -> getValidationRuns().add(tx, oldValidationRun));\n\n        CertificateTreeValidationRun oldValidationRun2 = new CertificateTreeValidationRun(testTARef2);\n        oldValidationRun2.setCreatedAt(lastMonth);\n        oldValidationRun2.setCompletedAt(lastMonth);\n        oldValidationRun2.setSucceeded();\n        wtx0(tx -> getValidationRuns().add(tx, oldValidationRun2));\n\n        AtomicInteger oldCount = subject.cleanupValidationRuns().getLeft();\n        assertThat(oldCount.get()).isEqualTo(1);\n    }", "signature": "void shouldCleanUpOldValidationRunDontDeleteLastSuccessfulPerTA()", "full_signature": "@Test public void shouldCleanUpOldValidationRunDontDeleteLastSuccessfulPerTA()", "class_method_signature": "ValidationRunCleanupServiceTest.shouldCleanUpOldValidationRunDontDeleteLastSuccessfulPerTA()", "testcase": true, "constructor": false, "invocations": ["wtx", "createTrustAnchor", "roaPrefixes", "wtx0", "add", "getTrustAnchors", "readTx", "getStorage", "makeRef", "getTrustAnchors", "key", "minus", "now", "ofDays", "setCreatedAt", "setCompletedAt", "wtx0", "add", "getValidationRuns", "setCreatedAt", "setCompletedAt", "setSucceeded", "wtx0", "add", "getValidationRuns", "getLeft", "cleanupValidationRuns", "isEqualTo", "assertThat", "get"]}, "focal_class": {"identifier": "ValidationRunCleanupService", "superclass": "", "interfaces": "", "fields": [{"original_string": "@Autowired\n    private ValidationRuns validationRuns;", "modifier": "@Autowired\n    private", "type": "ValidationRuns", "declarator": "validationRuns", "var_name": "validationRuns"}, {"original_string": "private final Duration cleanupGraceDuration;", "modifier": "private final", "type": "Duration", "declarator": "cleanupGraceDuration", "var_name": "cleanupGraceDuration"}, {"original_string": "private final Storage storage;", "modifier": "private final", "type": "Storage", "declarator": "storage", "var_name": "storage"}], "methods": [{"identifier": "ValidationRunCleanupService", "parameters": "(@Value(\"${rpki.validator.validation.run.cleanup.grace.duration}\") String cleanupGraceDuration,\n                                       Storage storage)", "modifiers": "public", "return": "", "signature": " ValidationRunCleanupService(@Value(\"${rpki.validator.validation.run.cleanup.grace.duration}\") String cleanupGraceDuration,\n                                       Storage storage)", "full_signature": "public  ValidationRunCleanupService(@Value(\"${rpki.validator.validation.run.cleanup.grace.duration}\") String cleanupGraceDuration,\n                                       Storage storage)", "class_method_signature": "ValidationRunCleanupService.ValidationRunCleanupService(@Value(\"${rpki.validator.validation.run.cleanup.grace.duration}\") String cleanupGraceDuration,\n                                       Storage storage)", "testcase": false, "constructor": true}, {"identifier": "cleanupValidationRuns", "parameters": "()", "modifiers": "public", "return": "Pair<AtomicInteger, AtomicInteger>", "signature": "Pair<AtomicInteger, AtomicInteger> cleanupValidationRuns()", "full_signature": "public Pair<AtomicInteger, AtomicInteger> cleanupValidationRuns()", "class_method_signature": "ValidationRunCleanupService.cleanupValidationRuns()", "testcase": false, "constructor": false}], "file": "rpki-validator/src/main/java/net/ripe/rpki/validator3/domain/cleanup/ValidationRunCleanupService.java"}, "focal_method": {"identifier": "cleanupValidationRuns", "parameters": "()", "modifiers": "public", "return": "Pair<AtomicInteger, AtomicInteger>", "body": "public Pair<AtomicInteger, AtomicInteger> cleanupValidationRuns() {\n        AtomicInteger oldCount = new AtomicInteger();\n        AtomicInteger orphanCount = new AtomicInteger();\n        InstantWithoutNanos completedBefore = InstantWithoutNanos.now().minus(cleanupGraceDuration);\n        Long t = Time.timed(() -> {\n            // Delete all validation runs older than `cleanupGraceDuration` that have a later validation run.\n            oldCount.set(storage.writeTx(tx -> validationRuns.removeOldValidationRuns(tx, completedBefore)));\n            orphanCount.set(storage.writeTx(tx -> validationRuns.removeOrphanValidationRunAssociations(tx)));\n        });\n        log.info(\"Removed {} old validation runs and {} orphans in {}ms\", oldCount.get(), orphanCount.get(), t);\n        storage.gc();\n        return Pair.of(oldCount, orphanCount);\n    }", "signature": "Pair<AtomicInteger, AtomicInteger> cleanupValidationRuns()", "full_signature": "public Pair<AtomicInteger, AtomicInteger> cleanupValidationRuns()", "class_method_signature": "ValidationRunCleanupService.cleanupValidationRuns()", "testcase": false, "constructor": false, "invocations": ["minus", "now", "timed", "set", "writeTx", "removeOldValidationRuns", "set", "writeTx", "removeOrphanValidationRunAssociations", "info", "get", "get", "gc", "of"]}, "repository": {"repo_id": 104217624, "url": "https://github.com/RIPE-NCC/rpki-validator-3", "stars": 32, "created": "9/20/2017 1:15:05 PM +00:00", "updates": "2020-01-27T10:48:38+00:00", "fork": "False", "license": "licensed"}}