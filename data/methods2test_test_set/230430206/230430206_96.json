{"test_class": {"identifier": "ReferenceCountedACLCacheTest", "superclass": "", "interfaces": "", "fields": [], "file": "zookeeper-server/src/test/java/org/apache/zookeeper/server/ReferenceCountedACLCacheTest.java"}, "test_case": {"identifier": "testPurgeUnused", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void testPurgeUnused() throws IOException {\n        ReferenceCountedACLCache cache = new ReferenceCountedACLCache();\n\n        List<ACL> acl1 = createACL(\"one\");\n        List<ACL> acl2 = createACL(\"two\");\n        List<ACL> acl3 = createACL(\"three\");\n        List<ACL> acl4 = createACL(\"four\");\n        List<ACL> acl5 = createACL(\"five\");\n\n        Long aclId1 = convertACLsNTimes(cache, acl1, 1);\n        Long aclId2 = convertACLsNTimes(cache, acl2, 2);\n        Long aclId3 = convertACLsNTimes(cache, acl3, 3);\n        Long aclId4 = convertACLsNTimes(cache, acl4, 4);\n        Long aclId5 = convertACLsNTimes(cache, acl5, 5);\n\n        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n        BinaryOutputArchive archive = BinaryOutputArchive.getArchive(baos);\n        cache.serialize(archive);\n\n        BinaryInputArchive inArchive = BinaryInputArchive.getArchive(new ByteArrayInputStream(baos.toByteArray()));\n        ReferenceCountedACLCache deserializedCache = new ReferenceCountedACLCache();\n        deserializedCache.deserialize(inArchive);\n        callAddUsageNTimes(deserializedCache, aclId1, 1);\n        callAddUsageNTimes(deserializedCache, aclId2, 2);\n        deserializedCache.purgeUnused();\n\n        assertEquals(2, deserializedCache.size());\n        assertEquals(aclId1, deserializedCache.convertAcls(acl1));\n        assertEquals(aclId2, deserializedCache.convertAcls(acl2));\n        assertFalse(acl3.equals(deserializedCache.convertAcls(acl3)));\n        assertFalse(acl4.equals(deserializedCache.convertAcls(acl4)));\n        assertFalse(acl5.equals(deserializedCache.convertAcls(acl5)));\n    }", "signature": "void testPurgeUnused()", "full_signature": "@Test public void testPurgeUnused()", "class_method_signature": "ReferenceCountedACLCacheTest.testPurgeUnused()", "testcase": true, "constructor": false, "invocations": ["createACL", "createACL", "createACL", "createACL", "createACL", "convertACLsNTimes", "convertACLsNTimes", "convertACLsNTimes", "convertACLsNTimes", "convertACLsNTimes", "getArchive", "serialize", "getArchive", "toByteArray", "deserialize", "callAddUsageNTimes", "callAddUsageNTimes", "purgeUnused", "assertEquals", "size", "assertEquals", "convertAcls", "assertEquals", "convertAcls", "assertFalse", "equals", "convertAcls", "assertFalse", "equals", "convertAcls", "assertFalse", "equals", "convertAcls"]}, "focal_class": {"identifier": "ReferenceCountedACLCache", "superclass": "", "interfaces": "", "fields": [{"original_string": "private static final Logger LOG = LoggerFactory.getLogger(ReferenceCountedACLCache.class);", "modifier": "private static final", "type": "Logger", "declarator": "LOG = LoggerFactory.getLogger(ReferenceCountedACLCache.class)", "var_name": "LOG"}, {"original_string": "final Map<Long, List<ACL>> longKeyMap =\n            new HashMap<Long, List<ACL>>();", "modifier": "final", "type": "Map<Long, List<ACL>>", "declarator": "longKeyMap =\n            new HashMap<Long, List<ACL>>()", "var_name": "longKeyMap"}, {"original_string": "final Map<List<ACL>, Long> aclKeyMap =\n            new HashMap<List<ACL>, Long>();", "modifier": "final", "type": "Map<List<ACL>, Long>", "declarator": "aclKeyMap =\n            new HashMap<List<ACL>, Long>()", "var_name": "aclKeyMap"}, {"original_string": "final Map<Long, AtomicLongWithEquals> referenceCounter =\n            new HashMap<Long, AtomicLongWithEquals>();", "modifier": "final", "type": "Map<Long, AtomicLongWithEquals>", "declarator": "referenceCounter =\n            new HashMap<Long, AtomicLongWithEquals>()", "var_name": "referenceCounter"}, {"original_string": "private static final long OPEN_UNSAFE_ACL_ID = -1L;", "modifier": "private static final", "type": "long", "declarator": "OPEN_UNSAFE_ACL_ID = -1L", "var_name": "OPEN_UNSAFE_ACL_ID"}, {"original_string": "long aclIndex = 0;", "modifier": "", "type": "long", "declarator": "aclIndex = 0", "var_name": "aclIndex"}], "methods": [{"identifier": "convertAcls", "parameters": "(List<ACL> acls)", "modifiers": "public synchronized", "return": "Long", "signature": "Long convertAcls(List<ACL> acls)", "full_signature": "public synchronized Long convertAcls(List<ACL> acls)", "class_method_signature": "ReferenceCountedACLCache.convertAcls(List<ACL> acls)", "testcase": false, "constructor": false}, {"identifier": "convertLong", "parameters": "(Long longVal)", "modifiers": "public synchronized", "return": "List<ACL>", "signature": "List<ACL> convertLong(Long longVal)", "full_signature": "public synchronized List<ACL> convertLong(Long longVal)", "class_method_signature": "ReferenceCountedACLCache.convertLong(Long longVal)", "testcase": false, "constructor": false}, {"identifier": "incrementIndex", "parameters": "()", "modifiers": "private", "return": "long", "signature": "long incrementIndex()", "full_signature": "private long incrementIndex()", "class_method_signature": "ReferenceCountedACLCache.incrementIndex()", "testcase": false, "constructor": false}, {"identifier": "deserialize", "parameters": "(InputArchive ia)", "modifiers": "public synchronized", "return": "void", "signature": "void deserialize(InputArchive ia)", "full_signature": "public synchronized void deserialize(InputArchive ia)", "class_method_signature": "ReferenceCountedACLCache.deserialize(InputArchive ia)", "testcase": false, "constructor": false}, {"identifier": "serialize", "parameters": "(OutputArchive oa)", "modifiers": "public synchronized", "return": "void", "signature": "void serialize(OutputArchive oa)", "full_signature": "public synchronized void serialize(OutputArchive oa)", "class_method_signature": "ReferenceCountedACLCache.serialize(OutputArchive oa)", "testcase": false, "constructor": false}, {"identifier": "size", "parameters": "()", "modifiers": "public", "return": "int", "signature": "int size()", "full_signature": "public int size()", "class_method_signature": "ReferenceCountedACLCache.size()", "testcase": false, "constructor": false}, {"identifier": "clear", "parameters": "()", "modifiers": "private", "return": "void", "signature": "void clear()", "full_signature": "private void clear()", "class_method_signature": "ReferenceCountedACLCache.clear()", "testcase": false, "constructor": false}, {"identifier": "addUsage", "parameters": "(Long acl)", "modifiers": "public synchronized", "return": "void", "signature": "void addUsage(Long acl)", "full_signature": "public synchronized void addUsage(Long acl)", "class_method_signature": "ReferenceCountedACLCache.addUsage(Long acl)", "testcase": false, "constructor": false}, {"identifier": "removeUsage", "parameters": "(Long acl)", "modifiers": "public synchronized", "return": "void", "signature": "void removeUsage(Long acl)", "full_signature": "public synchronized void removeUsage(Long acl)", "class_method_signature": "ReferenceCountedACLCache.removeUsage(Long acl)", "testcase": false, "constructor": false}, {"identifier": "purgeUnused", "parameters": "()", "modifiers": "public synchronized", "return": "void", "signature": "void purgeUnused()", "full_signature": "public synchronized void purgeUnused()", "class_method_signature": "ReferenceCountedACLCache.purgeUnused()", "testcase": false, "constructor": false}], "file": "zookeeper-server/src/main/java/org/apache/zookeeper/server/ReferenceCountedACLCache.java"}, "focal_method": {"identifier": "purgeUnused", "parameters": "()", "modifiers": "public synchronized", "return": "void", "body": "public synchronized void purgeUnused() {\n        Iterator<Map.Entry<Long, AtomicLongWithEquals>> refCountIter = referenceCounter.entrySet().iterator();\n        while (refCountIter.hasNext()) {\n            Map.Entry<Long, AtomicLongWithEquals> entry = refCountIter.next();\n            if (entry.getValue().get() <= 0) {\n                Long acl = entry.getKey();\n                aclKeyMap.remove(longKeyMap.get(acl));\n                longKeyMap.remove(acl);\n                refCountIter.remove();\n            }\n        }\n    }", "signature": "void purgeUnused()", "full_signature": "public synchronized void purgeUnused()", "class_method_signature": "ReferenceCountedACLCache.purgeUnused()", "testcase": false, "constructor": false, "invocations": ["iterator", "entrySet", "hasNext", "next", "get", "getValue", "getKey", "remove", "get", "remove", "remove"]}, "repository": {"repo_id": 230430206, "url": "https://github.com/boomblog/zookeeper-vip2", "language": "Java", "is_fork": false, "fork_count": 29, "stargazer_count": 10, "size": 3105, "license": "licensed"}}