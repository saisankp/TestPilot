{"test_class": {"identifier": "SplitTest", "superclass": "extends TestBase", "interfaces": "", "fields": [], "file": "hbase0.98/hbase-manager-0.98/src/test/java/com/kakao/hbase/manager/command/SplitTest.java"}, "test_case": {"identifier": "testSplitFileRegex", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void testSplitFileRegex() throws Exception {\n        String keyFileName = \"exportkeys_test.keys\";\n\n        List<HRegionInfo> regionInfoList;\n\n        byte[] splitPoint = \"splitpoint\".getBytes();\n        splitTable(splitPoint);\n        byte[] splitPoint2 = \"splitpoint2\".getBytes();\n        String tableName2 = createAdditionalTable(tableName + \"2\");\n        splitTable(tableName2, splitPoint2);\n        byte[] splitPoint31 = Bytes.toBytes(3100L);\n        byte[] splitPoint32 = Bytes.toBytes(3200L);\n        String tableName3 = createAdditionalTable(tableName + \"22\");\n        splitTable(tableName3, splitPoint31);\n        splitTable(tableName3, splitPoint32);\n\n        try {\n            // export 3 tables\n            String tableNameRegex = tableName + \".*\";\n            String[] argsParam = {\"zookeeper\", tableNameRegex, keyFileName};\n            Args args = new ManagerArgs(argsParam);\n            Assert.assertEquals(\"zookeeper\", args.getZookeeperQuorum());\n            Command command = new ExportKeys(admin, args);\n\n            waitForSplitting(2);\n            waitForSplitting(tableName2, 2);\n            waitForSplitting(tableName3, 3);\n            command.run();\n\n            // merge all regions into one\n            regionInfoList = getRegionInfoList(tableName);\n            mergeRegion(regionInfoList.get(0), regionInfoList.get(1));\n            assertEquals(1, getRegionInfoList(tableName).size());\n            regionInfoList = getRegionInfoList(tableName2);\n            mergeRegion(tableName2, regionInfoList.get(0), regionInfoList.get(1));\n            assertEquals(1, getRegionInfoList(tableName2).size());\n            regionInfoList = getRegionInfoList(tableName3);\n            mergeRegion(tableName3, regionInfoList.get(0), regionInfoList.get(1));\n            regionInfoList = getRegionInfoList(tableName3);\n            mergeRegion(tableName3, regionInfoList.get(0), regionInfoList.get(1));\n            assertEquals(1, getRegionInfoList(tableName3).size());\n\n            // split\n            tableNameRegex = tableName2 + \".*\";\n            String[] argsParam2 = {\"zookeeper\", tableNameRegex, \"filE\", keyFileName, \"--force-proceed\"};\n            Args args2 = new ManagerArgs(argsParam2);\n            assertEquals(\"zookeeper\", args2.getZookeeperQuorum());\n            command = new Split(admin, args2);\n\n            command.run();\n            waitForSplitting(tableName2, 2);\n            waitForSplitting(tableName3, 3);\n\n            ArrayList<HRegionInfo> regionInfoList1 = getRegionInfoList(tableName);\n            ArrayList<HRegionInfo> regionInfoList2 = getRegionInfoList(tableName2);\n            ArrayList<HRegionInfo> regionInfoList3 = getRegionInfoList(tableName3);\n            assertEquals(1, regionInfoList1.size());\n            assertEquals(2, regionInfoList2.size());\n            assertArrayEquals(splitPoint2, regionInfoList2.get(1).getStartKey());\n            assertEquals(3, regionInfoList3.size());\n            assertArrayEquals(splitPoint31, regionInfoList3.get(1).getStartKey());\n            assertArrayEquals(splitPoint32, regionInfoList3.get(2).getStartKey());\n        } finally {\n            Path filePath = Paths.get(keyFileName);\n            if (Files.exists(filePath)) Files.delete(filePath);\n        }\n    }", "signature": "void testSplitFileRegex()", "full_signature": "@Test public void testSplitFileRegex()", "class_method_signature": "SplitTest.testSplitFileRegex()", "testcase": true, "constructor": false, "invocations": ["getBytes", "splitTable", "getBytes", "createAdditionalTable", "splitTable", "toBytes", "toBytes", "createAdditionalTable", "splitTable", "splitTable", "assertEquals", "getZookeeperQuorum", "waitForSplitting", "waitForSplitting", "waitForSplitting", "run", "getRegionInfoList", "mergeRegion", "get", "get", "assertEquals", "size", "getRegionInfoList", "getRegionInfoList", "mergeRegion", "get", "get", "assertEquals", "size", "getRegionInfoList", "getRegionInfoList", "mergeRegion", "get", "get", "getRegionInfoList", "mergeRegion", "get", "get", "assertEquals", "size", "getRegionInfoList", "assertEquals", "getZookeeperQuorum", "run", "waitForSplitting", "waitForSplitting", "getRegionInfoList", "getRegionInfoList", "getRegionInfoList", "assertEquals", "size", "assertEquals", "size", "assertArrayEquals", "getStartKey", "get", "assertEquals", "size", "assertArrayEquals", "getStartKey", "get", "assertArrayEquals", "getStartKey", "get", "get", "exists", "delete"]}, "focal_class": {"identifier": "Split", "superclass": "", "interfaces": "implements Command", "fields": [{"original_string": "private final HBaseAdmin admin;", "modifier": "private final", "type": "HBaseAdmin", "declarator": "admin", "var_name": "admin"}, {"original_string": "private final Args args;", "modifier": "private final", "type": "Args", "declarator": "args", "var_name": "args"}], "methods": [{"identifier": "Split", "parameters": "(HBaseAdmin admin, Args args)", "modifiers": "public", "return": "", "signature": " Split(HBaseAdmin admin, Args args)", "full_signature": "public  Split(HBaseAdmin admin, Args args)", "class_method_signature": "Split.Split(HBaseAdmin admin, Args args)", "testcase": false, "constructor": true}, {"identifier": "usage", "parameters": "()", "modifiers": "public static", "return": "String", "signature": "String usage()", "full_signature": "public static String usage()", "class_method_signature": "Split.usage()", "testcase": false, "constructor": false}, {"identifier": "tableSet", "parameters": "(HBaseAdmin admin, Args args)", "modifiers": "private static", "return": "Set<String>", "signature": "Set<String> tableSet(HBaseAdmin admin, Args args)", "full_signature": "private static Set<String> tableSet(HBaseAdmin admin, Args args)", "class_method_signature": "Split.tableSet(HBaseAdmin admin, Args args)", "testcase": false, "constructor": false}, {"identifier": "run", "parameters": "()", "modifiers": "@Override public", "return": "void", "signature": "void run()", "full_signature": "@Override public void run()", "class_method_signature": "Split.run()", "testcase": false, "constructor": false}, {"identifier": "split", "parameters": "(HTable table, byte[] splitPoint)", "modifiers": "private", "return": "void", "signature": "void split(HTable table, byte[] splitPoint)", "full_signature": "private void split(HTable table, byte[] splitPoint)", "class_method_signature": "Split.split(HTable table, byte[] splitPoint)", "testcase": false, "constructor": false}], "file": "hbase0.98/hbase-manager-0.98/src/main/java/com/kakao/hbase/manager/command/Split.java"}, "focal_method": {"identifier": "run", "parameters": "()", "modifiers": "@Override public", "return": "void", "body": "@Override\n    public void run() throws IOException, DecoderException {\n        String action = ((String) args.getOptionSet().nonOptionArguments().get(2)).toLowerCase();\n        SplitAction splitAction = SplitAction.valueOf(action);\n        Set<String> tableSet = tableSet(admin, args);\n        Map<String, List<byte[]>> splitMap = splitAction.split(tableSet, args);\n\n        if (!args.isForceProceed() && !Util.askProceed()) return;\n\n        for (Map.Entry<String, List<byte[]>> entry : splitMap.entrySet()) {\n            String tableName = entry.getKey();\n            try (HTable table = new HTable(admin.getConfiguration(), tableName)) {\n                for (byte[] splitPoint : entry.getValue()) {\n                    System.out.print(\"splitting - \" + tableName + \" - \" + Bytes.toStringBinary(splitPoint));\n                    try {\n                        for (int i = 0; i < Constant.TRY_MAX; i++) {\n                            try {\n                                split(table, splitPoint);\n                                break;\n                            } catch (NotServingRegionException e) {\n                                Thread.sleep(Constant.WAIT_INTERVAL_MS);\n                            }\n                            if (i == Constant.TRY_MAX - 1)\n                                throw new RuntimeException(\"Splitting is not finished in \" + (Constant.TRY_MAX * Constant.WAIT_INTERVAL_MS / 1000) + \" seconds.\");\n                        }\n                    } catch (IOException e) {\n                        if (!e.getMessage().contains(\"should not give a splitkey which equals to startkey\")) throw e;\n                        System.out.println(\" - SKIPPING\");\n                        continue;\n                    }\n                    System.out.println(\" - OK\");\n                }\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n        }\n    }", "signature": "void run()", "full_signature": "@Override public void run()", "class_method_signature": "Split.run()", "testcase": false, "constructor": false, "invocations": ["toLowerCase", "get", "nonOptionArguments", "getOptionSet", "valueOf", "tableSet", "split", "isForceProceed", "askProceed", "entrySet", "getKey", "getConfiguration", "getValue", "print", "toStringBinary", "split", "sleep", "contains", "getMessage", "println", "println", "printStackTrace"]}, "repository": {"repo_id": 46396068, "url": "https://github.com/kakao/hbase-tools", "language": "Java", "is_fork": false, "fork_count": 21, "stargazer_count": 49, "size": 1758, "license": "licensed"}}