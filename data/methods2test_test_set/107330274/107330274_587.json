{"test_class": {"identifier": "AWSAppAutoScalingClientTest", "superclass": "", "interfaces": "", "fields": [], "file": "titus-ext/aws/src/test/java/com/netflix/titus/ext/aws/appscale/AWSAppAutoScalingClientTest.java"}, "test_case": {"identifier": "deleteScalableTargetIsIdempotent", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void deleteScalableTargetIsIdempotent() {\n        String jobId = UUID.randomUUID().toString();\n        String policyId = UUID.randomUUID().toString();\n\n        AWSApplicationAutoScalingAsync clientAsync = mock(AWSApplicationAutoScalingAsync.class);\n        AWSAppScalingConfig config = mock(AWSAppScalingConfig.class);\n        AWSAppAutoScalingClient autoScalingClient = new AWSAppAutoScalingClient(clientAsync, config, new NoopRegistry());\n\n        AtomicBoolean isDeleted = new AtomicBoolean(false);\n        when(clientAsync.deregisterScalableTargetAsync(any(), any())).thenAnswer(invocation -> {\n            DeregisterScalableTargetRequest request = invocation.getArgument(0);\n            AsyncHandler<DeregisterScalableTargetRequest, DeregisterScalableTargetResult> handler = invocation.getArgument(1);\n            if (isDeleted.get()) {\n                ObjectNotFoundException notFoundException = new ObjectNotFoundException(policyId + \" does not exist\");\n                handler.onError(notFoundException);\n                return Future.failed(notFoundException);\n            }\n\n            DeregisterScalableTargetResult resultSuccess = new DeregisterScalableTargetResult();\n            HttpResponse successResponse = new HttpResponse(null, null);\n            successResponse.setStatusCode(200);\n            resultSuccess.setSdkHttpMetadata(SdkHttpMetadata.from(successResponse));\n\n            isDeleted.set(true);\n            handler.onSuccess(request, resultSuccess);\n            return Future.successful(resultSuccess);\n        });\n\n        AssertableSubscriber<Void> firstCall = autoScalingClient.deleteScalableTarget(jobId).test();\n        firstCall.awaitTerminalEvent(2, TimeUnit.SECONDS);\n        firstCall.assertNoErrors();\n        firstCall.assertCompleted();\n        verify(clientAsync, times(1)).deregisterScalableTargetAsync(any(), any());\n\n        // second should complete fast when NotFound and not retry with exponential backoff\n        AssertableSubscriber<Void> secondCall = autoScalingClient.deleteScalableTarget(jobId).test();\n        secondCall.awaitTerminalEvent(2, TimeUnit.SECONDS);\n        secondCall.assertNoErrors();\n        secondCall.assertCompleted();\n        verify(clientAsync, times(2)).deregisterScalableTargetAsync(any(), any());\n    }", "signature": "void deleteScalableTargetIsIdempotent()", "full_signature": "@Test public void deleteScalableTargetIsIdempotent()", "class_method_signature": "AWSAppAutoScalingClientTest.deleteScalableTargetIsIdempotent()", "testcase": true, "constructor": false, "invocations": ["toString", "randomUUID", "toString", "randomUUID", "mock", "mock", "thenAnswer", "when", "deregisterScalableTargetAsync", "any", "any", "getArgument", "getArgument", "get", "onError", "failed", "setStatusCode", "setSdkHttpMetadata", "from", "set", "onSuccess", "successful", "test", "deleteScalableTarget", "awaitTerminalEvent", "assertNoErrors", "assertCompleted", "deregisterScalableTargetAsync", "verify", "times", "any", "any", "test", "deleteScalableTarget", "awaitTerminalEvent", "assertNoErrors", "assertCompleted", "deregisterScalableTargetAsync", "verify", "times", "any", "any"]}, "focal_class": {"identifier": "AWSAppAutoScalingClient", "superclass": "", "interfaces": "implements AppAutoScalingClient", "fields": [{"original_string": "private static Logger logger = LoggerFactory.getLogger(AWSAppAutoScalingClient.class);", "modifier": "private static", "type": "Logger", "declarator": "logger = LoggerFactory.getLogger(AWSAppAutoScalingClient.class)", "var_name": "logger"}, {"original_string": "public final static String SERVICE_NAMESPACE = \"custom-resource\";", "modifier": "public final static", "type": "String", "declarator": "SERVICE_NAMESPACE = \"custom-resource\"", "var_name": "SERVICE_NAMESPACE"}, {"original_string": "public final static String SCALABLE_DIMENSION = \"custom-resource:ResourceType:Property\";", "modifier": "public final static", "type": "String", "declarator": "SCALABLE_DIMENSION = \"custom-resource:ResourceType:Property\"", "var_name": "SCALABLE_DIMENSION"}, {"original_string": "private final AWSApplicationAutoScalingAsync awsAppAutoScalingClientAsync;", "modifier": "private final", "type": "AWSApplicationAutoScalingAsync", "declarator": "awsAppAutoScalingClientAsync", "var_name": "awsAppAutoScalingClientAsync"}, {"original_string": "private final AWSAppScalingConfig awsAppScalingConfig;", "modifier": "private final", "type": "AWSAppScalingConfig", "declarator": "awsAppScalingConfig", "var_name": "awsAppScalingConfig"}, {"original_string": "private final AWSAppAutoScalingMetrics awsAppAutoScalingMetrics;", "modifier": "private final", "type": "AWSAppAutoScalingMetrics", "declarator": "awsAppAutoScalingMetrics", "var_name": "awsAppAutoScalingMetrics"}], "methods": [{"identifier": "AWSAppAutoScalingClient", "parameters": "(AWSCredentialsProvider awsCredentialsProvider,\n                                   AWSAppScalingConfig awsAppScalingConfig,\n                                   Registry registry)", "modifiers": "@Inject public", "return": "", "signature": " AWSAppAutoScalingClient(AWSCredentialsProvider awsCredentialsProvider,\n                                   AWSAppScalingConfig awsAppScalingConfig,\n                                   Registry registry)", "full_signature": "@Inject public  AWSAppAutoScalingClient(AWSCredentialsProvider awsCredentialsProvider,\n                                   AWSAppScalingConfig awsAppScalingConfig,\n                                   Registry registry)", "class_method_signature": "AWSAppAutoScalingClient.AWSAppAutoScalingClient(AWSCredentialsProvider awsCredentialsProvider,\n                                   AWSAppScalingConfig awsAppScalingConfig,\n                                   Registry registry)", "testcase": false, "constructor": true}, {"identifier": "AWSAppAutoScalingClient", "parameters": "(AWSApplicationAutoScalingAsync awsAppAutoScalingClientAsync, AWSAppScalingConfig awsAppScalingConfig, Registry registry)", "modifiers": "@VisibleForTesting", "return": "", "signature": " AWSAppAutoScalingClient(AWSApplicationAutoScalingAsync awsAppAutoScalingClientAsync, AWSAppScalingConfig awsAppScalingConfig, Registry registry)", "full_signature": "@VisibleForTesting  AWSAppAutoScalingClient(AWSApplicationAutoScalingAsync awsAppAutoScalingClientAsync, AWSAppScalingConfig awsAppScalingConfig, Registry registry)", "class_method_signature": "AWSAppAutoScalingClient.AWSAppAutoScalingClient(AWSApplicationAutoScalingAsync awsAppAutoScalingClientAsync, AWSAppScalingConfig awsAppScalingConfig, Registry registry)", "testcase": false, "constructor": true}, {"identifier": "createScalableTarget", "parameters": "(String jobId, int minCapacity, int maxCapacity)", "modifiers": "@Override public", "return": "Completable", "signature": "Completable createScalableTarget(String jobId, int minCapacity, int maxCapacity)", "full_signature": "@Override public Completable createScalableTarget(String jobId, int minCapacity, int maxCapacity)", "class_method_signature": "AWSAppAutoScalingClient.createScalableTarget(String jobId, int minCapacity, int maxCapacity)", "testcase": false, "constructor": false}, {"identifier": "getScalableTargetsForJob", "parameters": "(String jobId)", "modifiers": "@Override public", "return": "Observable<AutoScalableTarget>", "signature": "Observable<AutoScalableTarget> getScalableTargetsForJob(String jobId)", "full_signature": "@Override public Observable<AutoScalableTarget> getScalableTargetsForJob(String jobId)", "class_method_signature": "AWSAppAutoScalingClient.getScalableTargetsForJob(String jobId)", "testcase": false, "constructor": false}, {"identifier": "createOrUpdateScalingPolicy", "parameters": "(String policyRefId, String jobId, PolicyConfiguration policyConfiguration)", "modifiers": "@Override public", "return": "Observable<String>", "signature": "Observable<String> createOrUpdateScalingPolicy(String policyRefId, String jobId, PolicyConfiguration policyConfiguration)", "full_signature": "@Override public Observable<String> createOrUpdateScalingPolicy(String policyRefId, String jobId, PolicyConfiguration policyConfiguration)", "class_method_signature": "AWSAppAutoScalingClient.createOrUpdateScalingPolicy(String policyRefId, String jobId, PolicyConfiguration policyConfiguration)", "testcase": false, "constructor": false}, {"identifier": "deleteScalableTarget", "parameters": "(String jobId)", "modifiers": "@Override public", "return": "Completable", "signature": "Completable deleteScalableTarget(String jobId)", "full_signature": "@Override public Completable deleteScalableTarget(String jobId)", "class_method_signature": "AWSAppAutoScalingClient.deleteScalableTarget(String jobId)", "testcase": false, "constructor": false}, {"identifier": "deleteScalingPolicy", "parameters": "(String policyRefId, String jobId)", "modifiers": "@Override public", "return": "Completable", "signature": "Completable deleteScalingPolicy(String policyRefId, String jobId)", "full_signature": "@Override public Completable deleteScalingPolicy(String policyRefId, String jobId)", "class_method_signature": "AWSAppAutoScalingClient.deleteScalingPolicy(String policyRefId, String jobId)", "testcase": false, "constructor": false}], "file": "titus-ext/aws/src/main/java/com/netflix/titus/ext/aws/appscale/AWSAppAutoScalingClient.java"}, "focal_method": {"identifier": "deleteScalableTarget", "parameters": "(String jobId)", "modifiers": "@Override public", "return": "Completable", "body": "@Override\n    public Completable deleteScalableTarget(String jobId) {\n        DeregisterScalableTargetRequest deRegisterRequest = new DeregisterScalableTargetRequest();\n        deRegisterRequest.setResourceId(\n                AWSAppAutoScalingUtil.buildGatewayResourceId(jobId,\n                        awsAppScalingConfig.getAWSGatewayEndpointPrefix(),\n                        awsAppScalingConfig.getRegion(),\n                        awsAppScalingConfig.getAWSGatewayEndpointTargetStage()));\n        deRegisterRequest.setServiceNamespace(SERVICE_NAMESPACE);\n        deRegisterRequest.setScalableDimension(SCALABLE_DIMENSION);\n\n        return RetryWrapper.wrapWithExponentialRetry(String.format(\"deleteScalableTarget for job %s\", jobId),\n                Observable.create(emitter -> awsAppAutoScalingClientAsync.deregisterScalableTargetAsync(deRegisterRequest, new AsyncHandler<DeregisterScalableTargetRequest, DeregisterScalableTargetResult>() {\n                    @Override\n                    public void onError(Exception exception) {\n                        if (exception instanceof ObjectNotFoundException) {\n                            logger.info(\"Scalable target does not exist anymore for job {}\", jobId);\n                            emitter.onCompleted();\n                        } else {\n                            logger.error(\"Deregister scalable target exception {} - {}\", jobId, exception.getMessage());\n                            awsAppAutoScalingMetrics.registerAwsDeleteTargetError(exception);\n                            emitter.onError(exception);\n                        }\n                    }\n\n                    @Override\n                    public void onSuccess(DeregisterScalableTargetRequest request, DeregisterScalableTargetResult deregisterScalableTargetResult) {\n                        int httpStatusCode = deregisterScalableTargetResult.getSdkHttpMetadata().getHttpStatusCode();\n                        logger.info(\"De-registered scalable target for {}, status {}\", jobId, httpStatusCode);\n                        awsAppAutoScalingMetrics.registerAwsDeleteTargetSuccess();\n                        emitter.onCompleted();\n                    }\n                }), Emitter.BackpressureMode.NONE)).toCompletable();\n    }", "signature": "Completable deleteScalableTarget(String jobId)", "full_signature": "@Override public Completable deleteScalableTarget(String jobId)", "class_method_signature": "AWSAppAutoScalingClient.deleteScalableTarget(String jobId)", "testcase": false, "constructor": false, "invocations": ["setResourceId", "buildGatewayResourceId", "getAWSGatewayEndpointPrefix", "getRegion", "getAWSGatewayEndpointTargetStage", "setServiceNamespace", "setScalableDimension", "toCompletable", "wrapWithExponentialRetry", "format", "create", "deregisterScalableTargetAsync", "info", "onCompleted", "error", "getMessage", "registerAwsDeleteTargetError", "onError", "getHttpStatusCode", "getSdkHttpMetadata", "info", "registerAwsDeleteTargetSuccess", "onCompleted"]}, "repository": {"repo_id": 107330274, "url": "https://github.com/Netflix/titus-control-plane", "stars": 241, "created": "10/17/2017 10:20:55 PM +00:00", "updates": "2020-01-25T13:01:05+00:00", "fork": "False", "license": "licensed"}}