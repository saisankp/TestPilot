{"test_class": {"identifier": "ModifyFeaturesStrategyTest", "superclass": "extends AbstractCommandStrategyTest", "interfaces": "", "fields": [{"original_string": "private static Features modifiedFeatures;", "modifier": "private static", "type": "Features", "declarator": "modifiedFeatures", "var_name": "modifiedFeatures"}, {"original_string": "private ModifyFeaturesStrategy underTest;", "modifier": "private", "type": "ModifyFeaturesStrategy", "declarator": "underTest", "var_name": "underTest"}], "file": "services/things/persistence/src/test/java/org/eclipse/ditto/services/things/persistence/actors/strategies/commands/ModifyFeaturesStrategyTest.java"}, "test_case": {"identifier": "modifyFeaturePropertiesSoThatThingGetsTooLarge", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void modifyFeaturePropertiesSoThatThingGetsTooLarge() {\n        final CommandStrategy.Context<ThingId> context = getDefaultContext();\n\n        final Feature feature = Feature.newBuilder()\n                .properties(JsonObject.newBuilder().set(\"foo\", false).set(\"bar\", 42).build())\n                .withId(\"myFeature\")\n                .build();\n\n        final long staticOverhead = 80;\n        final StringBuilder sb = new StringBuilder();\n        for (int i = 0; i < THING_SIZE_LIMIT_BYTES - staticOverhead; i++) {\n            sb.append('a');\n        }\n        final JsonObject largeAttributes = JsonObject.newBuilder()\n                .set(\"a\", sb.toString())\n                .build();\n        final ThingId thingId = ThingId.of(\"foo\", \"bar\");\n        final Thing thing = Thing.newBuilder()\n                .setId(thingId)\n                .setAttributes(largeAttributes)\n                .build();\n\n        // creating the Thing should be possible as we are below the limit:\n        CreateThing.of(thing, null, DittoHeaders.empty());\n\n        final ModifyFeatures command =\n                ModifyFeatures.of(thingId, Features.newBuilder().set(feature).build(), DittoHeaders.empty());\n\n        // but modifying the features which would cause the Thing to exceed the limit should not be allowed:\n        assertThatThrownBy(() -> underTest.doApply(context, thing, NEXT_REVISION, command, null))\n                .isInstanceOf(ThingTooLargeException.class);\n    }", "signature": "void modifyFeaturePropertiesSoThatThingGetsTooLarge()", "full_signature": "@Test public void modifyFeaturePropertiesSoThatThingGetsTooLarge()", "class_method_signature": "ModifyFeaturesStrategyTest.modifyFeaturePropertiesSoThatThingGetsTooLarge()", "testcase": true, "constructor": false, "invocations": ["getDefaultContext", "build", "withId", "properties", "newBuilder", "build", "set", "set", "newBuilder", "append", "build", "set", "newBuilder", "toString", "of", "build", "setAttributes", "setId", "newBuilder", "of", "empty", "of", "build", "set", "newBuilder", "empty", "isInstanceOf", "assertThatThrownBy", "doApply"]}, "focal_class": {"identifier": "ModifyFeaturesStrategy", "superclass": "extends AbstractThingCommandStrategy<ModifyFeatures>", "interfaces": "", "fields": [], "methods": [{"identifier": "ModifyFeaturesStrategy", "parameters": "()", "modifiers": "", "return": "", "signature": " ModifyFeaturesStrategy()", "full_signature": "  ModifyFeaturesStrategy()", "class_method_signature": "ModifyFeaturesStrategy.ModifyFeaturesStrategy()", "testcase": false, "constructor": true}, {"identifier": "doApply", "parameters": "(final Context<ThingId> context,\n            @Nullable final Thing thing,\n            final long nextRevision,\n            final ModifyFeatures command,\n            @Nullable final Metadata metadata)", "modifiers": "@Override protected", "return": "Result<ThingEvent>", "signature": "Result<ThingEvent> doApply(final Context<ThingId> context,\n            @Nullable final Thing thing,\n            final long nextRevision,\n            final ModifyFeatures command,\n            @Nullable final Metadata metadata)", "full_signature": "@Override protected Result<ThingEvent> doApply(final Context<ThingId> context,\n            @Nullable final Thing thing,\n            final long nextRevision,\n            final ModifyFeatures command,\n            @Nullable final Metadata metadata)", "class_method_signature": "ModifyFeaturesStrategy.doApply(final Context<ThingId> context,\n            @Nullable final Thing thing,\n            final long nextRevision,\n            final ModifyFeatures command,\n            @Nullable final Metadata metadata)", "testcase": false, "constructor": false}, {"identifier": "getModifyResult", "parameters": "(final Context<ThingId> context, final long nextRevision,\n            final ModifyFeatures command, @Nullable final Thing thing, @Nullable final Metadata metadata)", "modifiers": "private", "return": "Result<ThingEvent>", "signature": "Result<ThingEvent> getModifyResult(final Context<ThingId> context, final long nextRevision,\n            final ModifyFeatures command, @Nullable final Thing thing, @Nullable final Metadata metadata)", "full_signature": "private Result<ThingEvent> getModifyResult(final Context<ThingId> context, final long nextRevision,\n            final ModifyFeatures command, @Nullable final Thing thing, @Nullable final Metadata metadata)", "class_method_signature": "ModifyFeaturesStrategy.getModifyResult(final Context<ThingId> context, final long nextRevision,\n            final ModifyFeatures command, @Nullable final Thing thing, @Nullable final Metadata metadata)", "testcase": false, "constructor": false}, {"identifier": "getCreateResult", "parameters": "(final Context<ThingId> context, final long nextRevision,\n            final ModifyFeatures command, @Nullable final Thing thing, @Nullable final Metadata metadata)", "modifiers": "private", "return": "Result<ThingEvent>", "signature": "Result<ThingEvent> getCreateResult(final Context<ThingId> context, final long nextRevision,\n            final ModifyFeatures command, @Nullable final Thing thing, @Nullable final Metadata metadata)", "full_signature": "private Result<ThingEvent> getCreateResult(final Context<ThingId> context, final long nextRevision,\n            final ModifyFeatures command, @Nullable final Thing thing, @Nullable final Metadata metadata)", "class_method_signature": "ModifyFeaturesStrategy.getCreateResult(final Context<ThingId> context, final long nextRevision,\n            final ModifyFeatures command, @Nullable final Thing thing, @Nullable final Metadata metadata)", "testcase": false, "constructor": false}, {"identifier": "previousEntityTag", "parameters": "(final ModifyFeatures command, @Nullable final Thing previousEntity)", "modifiers": "@Override public", "return": "Optional<EntityTag>", "signature": "Optional<EntityTag> previousEntityTag(final ModifyFeatures command, @Nullable final Thing previousEntity)", "full_signature": "@Override public Optional<EntityTag> previousEntityTag(final ModifyFeatures command, @Nullable final Thing previousEntity)", "class_method_signature": "ModifyFeaturesStrategy.previousEntityTag(final ModifyFeatures command, @Nullable final Thing previousEntity)", "testcase": false, "constructor": false}, {"identifier": "nextEntityTag", "parameters": "(final ModifyFeatures command, @Nullable final Thing newEntity)", "modifiers": "@Override public", "return": "Optional<EntityTag>", "signature": "Optional<EntityTag> nextEntityTag(final ModifyFeatures command, @Nullable final Thing newEntity)", "full_signature": "@Override public Optional<EntityTag> nextEntityTag(final ModifyFeatures command, @Nullable final Thing newEntity)", "class_method_signature": "ModifyFeaturesStrategy.nextEntityTag(final ModifyFeatures command, @Nullable final Thing newEntity)", "testcase": false, "constructor": false}], "file": "services/things/persistence/src/main/java/org/eclipse/ditto/services/things/persistence/actors/strategies/commands/ModifyFeaturesStrategy.java"}, "focal_method": {"identifier": "doApply", "parameters": "(final Context<ThingId> context,\n            @Nullable final Thing thing,\n            final long nextRevision,\n            final ModifyFeatures command,\n            @Nullable final Metadata metadata)", "modifiers": "@Override protected", "return": "Result<ThingEvent>", "body": "@Override\n    protected Result<ThingEvent> doApply(final Context<ThingId> context,\n            @Nullable final Thing thing,\n            final long nextRevision,\n            final ModifyFeatures command,\n            @Nullable final Metadata metadata) {\n\n        final Thing nonNullThing = getEntityOrThrow(thing);\n\n        final JsonObject thingWithoutFeaturesJsonObject = nonNullThing.removeFeatures().toJson();\n        final JsonObject featuresJsonObject = command.getFeatures().toJson();\n\n        ThingCommandSizeValidator.getInstance().ensureValidSize(\n                () -> {\n                    final long lengthWithOutFeatures = thingWithoutFeaturesJsonObject.getUpperBoundForStringSize();\n                    final long featuresLength = featuresJsonObject.getUpperBoundForStringSize() + \"features\".length() + 5L;\n                    return lengthWithOutFeatures + featuresLength;\n                },\n                () -> {\n                    final long lengthWithOutFeatures = thingWithoutFeaturesJsonObject.toString().length();\n                    final long featuresLength = featuresJsonObject.toString().length() + \"features\".length() + 5L;\n                    return lengthWithOutFeatures + featuresLength;\n                },\n                command::getDittoHeaders);\n\n        return nonNullThing.getFeatures()\n                .map(features -> getModifyResult(context, nextRevision, command, thing, metadata))\n                .orElseGet(() -> getCreateResult(context, nextRevision, command, thing, metadata));\n    }", "signature": "Result<ThingEvent> doApply(final Context<ThingId> context,\n            @Nullable final Thing thing,\n            final long nextRevision,\n            final ModifyFeatures command,\n            @Nullable final Metadata metadata)", "full_signature": "@Override protected Result<ThingEvent> doApply(final Context<ThingId> context,\n            @Nullable final Thing thing,\n            final long nextRevision,\n            final ModifyFeatures command,\n            @Nullable final Metadata metadata)", "class_method_signature": "ModifyFeaturesStrategy.doApply(final Context<ThingId> context,\n            @Nullable final Thing thing,\n            final long nextRevision,\n            final ModifyFeatures command,\n            @Nullable final Metadata metadata)", "testcase": false, "constructor": false, "invocations": ["getEntityOrThrow", "toJson", "removeFeatures", "toJson", "getFeatures", "ensureValidSize", "getInstance", "getUpperBoundForStringSize", "getUpperBoundForStringSize", "length", "length", "toString", "length", "toString", "length", "orElseGet", "map", "getFeatures", "getModifyResult", "getCreateResult"]}, "repository": {"repo_id": 87849739, "url": "https://github.com/eclipse/ditto", "stars": 139, "created": "4/10/2017 7:29:57 PM +00:00", "updates": "2020-01-27T14:02:39+00:00", "fork": "False", "license": "licensed"}}