{"test_class": {"identifier": "DemandResponseEventServiceTest", "superclass": "", "interfaces": "", "fields": [{"original_string": "@Resource\n\tprivate DemandResponseEventService demandResponseEventService;", "modifier": "@Resource\n\tprivate", "type": "DemandResponseEventService", "declarator": "demandResponseEventService", "var_name": "demandResponseEventService"}, {"original_string": "@Resource\n\tprivate VenService venService;", "modifier": "@Resource\n\tprivate", "type": "VenService", "declarator": "venService", "var_name": "venService"}, {"original_string": "@Resource\n\tprivate VenDemandResponseEventDao venDemandResponseEventDao;", "modifier": "@Resource\n\tprivate", "type": "VenDemandResponseEventDao", "declarator": "venDemandResponseEventDao", "var_name": "venDemandResponseEventDao"}, {"original_string": "@Resource\n\tprivate VenMarketContextService venMarketContextService;", "modifier": "@Resource\n\tprivate", "type": "VenMarketContextService", "declarator": "venMarketContextService", "var_name": "venMarketContextService"}, {"original_string": "private Long start = System.currentTimeMillis();", "modifier": "private", "type": "Long", "declarator": "start = System.currentTimeMillis()", "var_name": "start"}, {"original_string": "private List<Ven> vens = new ArrayList<Ven>();", "modifier": "private", "type": "List<Ven>", "declarator": "vens = new ArrayList<Ven>()", "var_name": "vens"}, {"original_string": "private List<DemandResponseEvent> events = new ArrayList<DemandResponseEvent>();", "modifier": "private", "type": "List<DemandResponseEvent>", "declarator": "events = new ArrayList<DemandResponseEvent>()", "var_name": "events"}, {"original_string": "private VenMarketContext marketContext = null;", "modifier": "private", "type": "VenMarketContext", "declarator": "marketContext = null", "var_name": "marketContext"}, {"original_string": "private DemandResponseEvent event1 = null;", "modifier": "private", "type": "DemandResponseEvent", "declarator": "event1 = null", "var_name": "event1"}, {"original_string": "private DemandResponseEvent event2 = null;", "modifier": "private", "type": "DemandResponseEvent", "declarator": "event2 = null", "var_name": "event2"}, {"original_string": "private DemandResponseEvent event3 = null;", "modifier": "private", "type": "DemandResponseEvent", "declarator": "event3 = null", "var_name": "event3"}, {"original_string": "private Ven ven1;", "modifier": "private", "type": "Ven", "declarator": "ven1", "var_name": "ven1"}, {"original_string": "private Ven ven2;", "modifier": "private", "type": "Ven", "declarator": "ven2", "var_name": "ven2"}, {"original_string": "private Ven ven3;", "modifier": "private", "type": "Ven", "declarator": "ven3", "var_name": "ven3"}], "file": "OpenADRServerVTNCommon/src/test/java/com/avob/openadr/server/common/vtn/service/DemandResponseEventServiceTest.java"}, "test_case": {"identifier": "updateTest", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n\tpublic void updateTest() {\n\t\tlong count = venDemandResponseEventDao.count();\n\t\tassertEquals(4L, count);\n\n\t\tIterable<VenDemandResponseEvent> findAll = venDemandResponseEventDao.findAll();\n\n\t\tIterator<VenDemandResponseEvent> iterator = findAll.iterator();\n\n\t\twhile (iterator.hasNext()) {\n\t\t\tVenDemandResponseEvent next = iterator.next();\n\t\t\tassertEquals(-1, next.getLastSentModificationNumber());\n\t\t\tassertNull(next.getVenOpt());\n//\t\t\tassertTrue(next.getVen().getUsername() == \"ven1\" || next.getVen().getUsername() == \"ven2\"\n//\t\t\t\t\t|| next.getVen().getUsername() == \"ven3\");\n\t\t}\n\t}", "signature": "void updateTest()", "full_signature": "@Test public void updateTest()", "class_method_signature": "DemandResponseEventServiceTest.updateTest()", "testcase": true, "constructor": false, "invocations": ["count", "assertEquals", "findAll", "iterator", "hasNext", "next", "assertEquals", "getLastSentModificationNumber", "assertNull", "getVenOpt"]}, "focal_class": {"identifier": "DemandResponseEventService", "superclass": "", "interfaces": "", "fields": [{"original_string": "private static final Logger LOGGER = LoggerFactory.getLogger(DemandResponseEventService.class);", "modifier": "private static final", "type": "Logger", "declarator": "LOGGER = LoggerFactory.getLogger(DemandResponseEventService.class)", "var_name": "LOGGER"}, {"original_string": "private static final Integer DEFAULT_SEARCH_SIZE = 20;", "modifier": "private static final", "type": "Integer", "declarator": "DEFAULT_SEARCH_SIZE = 20", "var_name": "DEFAULT_SEARCH_SIZE"}, {"original_string": "private static final Sort SORT_ASC_ACTIVEPERIOD = Sort.by(Sort.Direction.ASC, \"activePeriod.start\");", "modifier": "private static final", "type": "Sort", "declarator": "SORT_ASC_ACTIVEPERIOD = Sort.by(Sort.Direction.ASC, \"activePeriod.start\")", "var_name": "SORT_ASC_ACTIVEPERIOD"}, {"original_string": "@Value(\"${oadr.supportPush:#{false}}\")\n\tprivate Boolean supportPush;", "modifier": "@Value(\"${oadr.supportPush:#{false}}\")\n\tprivate", "type": "Boolean", "declarator": "supportPush", "var_name": "supportPush"}, {"original_string": "@Resource\n\tprivate VenDao venDao;", "modifier": "@Resource\n\tprivate", "type": "VenDao", "declarator": "venDao", "var_name": "venDao"}, {"original_string": "@Resource\n\tprivate DemandResponseEventDao demandResponseEventDao;", "modifier": "@Resource\n\tprivate", "type": "DemandResponseEventDao", "declarator": "demandResponseEventDao", "var_name": "demandResponseEventDao"}, {"original_string": "@Resource\n\tprivate VenDemandResponseEventDao venDemandResponseEventDao;", "modifier": "@Resource\n\tprivate", "type": "VenDemandResponseEventDao", "declarator": "venDemandResponseEventDao", "var_name": "venDemandResponseEventDao"}, {"original_string": "@Resource\n\tprivate DemandResponseEventPublisher demandResponseEventPublisher;", "modifier": "@Resource\n\tprivate", "type": "DemandResponseEventPublisher", "declarator": "demandResponseEventPublisher", "var_name": "demandResponseEventPublisher"}, {"original_string": "@Resource\n\tprivate DemandResponseEventSignalDao demandResponseEventSignalDao;", "modifier": "@Resource\n\tprivate", "type": "DemandResponseEventSignalDao", "declarator": "demandResponseEventSignalDao", "var_name": "demandResponseEventSignalDao"}, {"original_string": "@Resource\n\tprivate Executor executor;", "modifier": "@Resource\n\tprivate", "type": "Executor", "declarator": "executor", "var_name": "executor"}, {"original_string": "@Resource\n\tprivate DtoMapper dtoMapper;", "modifier": "@Resource\n\tprivate", "type": "DtoMapper", "declarator": "dtoMapper", "var_name": "dtoMapper"}, {"original_string": "private DatatypeFactory datatypeFactory;", "modifier": "private", "type": "DatatypeFactory", "declarator": "datatypeFactory", "var_name": "datatypeFactory"}], "methods": [{"identifier": "init", "parameters": "()", "modifiers": "@PostConstruct public", "return": "void", "signature": "void init()", "full_signature": "@PostConstruct public void init()", "class_method_signature": "DemandResponseEventService.init()", "testcase": false, "constructor": false}, {"identifier": "findVenForTarget", "parameters": "(DemandResponseEvent event,\n\t\t\tList<? extends DemandResponseEventTargetInterface> targets)", "modifiers": "private", "return": "List<Ven>", "signature": "List<Ven> findVenForTarget(DemandResponseEvent event,\n\t\t\tList<? extends DemandResponseEventTargetInterface> targets)", "full_signature": "private List<Ven> findVenForTarget(DemandResponseEvent event,\n\t\t\tList<? extends DemandResponseEventTargetInterface> targets)", "class_method_signature": "DemandResponseEventService.findVenForTarget(DemandResponseEvent event,\n\t\t\tList<? extends DemandResponseEventTargetInterface> targets)", "testcase": false, "constructor": false}, {"identifier": "create", "parameters": "(DemandResponseEventCreateDto dto)", "modifiers": "@Transactional(readOnly = false) public", "return": "DemandResponseEvent", "signature": "DemandResponseEvent create(DemandResponseEventCreateDto dto)", "full_signature": "@Transactional(readOnly = false) public DemandResponseEvent create(DemandResponseEventCreateDto dto)", "class_method_signature": "DemandResponseEventService.create(DemandResponseEventCreateDto dto)", "testcase": false, "constructor": false}, {"identifier": "update", "parameters": "(DemandResponseEvent event, DemandResponseEventUpdateDto dto)", "modifiers": "@Transactional(readOnly = false) public", "return": "DemandResponseEvent", "signature": "DemandResponseEvent update(DemandResponseEvent event, DemandResponseEventUpdateDto dto)", "full_signature": "@Transactional(readOnly = false) public DemandResponseEvent update(DemandResponseEvent event, DemandResponseEventUpdateDto dto)", "class_method_signature": "DemandResponseEventService.update(DemandResponseEvent event, DemandResponseEventUpdateDto dto)", "testcase": false, "constructor": false}, {"identifier": "distributeEventToPushVen", "parameters": "(DemandResponseEvent event)", "modifiers": "public", "return": "void", "signature": "void distributeEventToPushVen(DemandResponseEvent event)", "full_signature": "public void distributeEventToPushVen(DemandResponseEvent event)", "class_method_signature": "DemandResponseEventService.distributeEventToPushVen(DemandResponseEvent event)", "testcase": false, "constructor": false}, {"identifier": "publish", "parameters": "(DemandResponseEvent event)", "modifiers": "@Transactional(readOnly = false) public", "return": "DemandResponseEvent", "signature": "DemandResponseEvent publish(DemandResponseEvent event)", "full_signature": "@Transactional(readOnly = false) public DemandResponseEvent publish(DemandResponseEvent event)", "class_method_signature": "DemandResponseEventService.publish(DemandResponseEvent event)", "testcase": false, "constructor": false}, {"identifier": "active", "parameters": "(DemandResponseEvent event)", "modifiers": "@Transactional(readOnly = false) public", "return": "DemandResponseEvent", "signature": "DemandResponseEvent active(DemandResponseEvent event)", "full_signature": "@Transactional(readOnly = false) public DemandResponseEvent active(DemandResponseEvent event)", "class_method_signature": "DemandResponseEventService.active(DemandResponseEvent event)", "testcase": false, "constructor": false}, {"identifier": "cancel", "parameters": "(DemandResponseEvent event)", "modifiers": "@Transactional(readOnly = false) public", "return": "DemandResponseEvent", "signature": "DemandResponseEvent cancel(DemandResponseEvent event)", "full_signature": "@Transactional(readOnly = false) public DemandResponseEvent cancel(DemandResponseEvent event)", "class_method_signature": "DemandResponseEventService.cancel(DemandResponseEvent event)", "testcase": false, "constructor": false}, {"identifier": "pushAsync", "parameters": "(Ven ven, DemandResponseEventOadrProfileEnum profile)", "modifiers": "private", "return": "void", "signature": "void pushAsync(Ven ven, DemandResponseEventOadrProfileEnum profile)", "full_signature": "private void pushAsync(Ven ven, DemandResponseEventOadrProfileEnum profile)", "class_method_signature": "DemandResponseEventService.pushAsync(Ven ven, DemandResponseEventOadrProfileEnum profile)", "testcase": false, "constructor": false}, {"identifier": "findById", "parameters": "(Long id)", "modifiers": "public", "return": "Optional<DemandResponseEvent>", "signature": "Optional<DemandResponseEvent> findById(Long id)", "full_signature": "public Optional<DemandResponseEvent> findById(Long id)", "class_method_signature": "DemandResponseEventService.findById(Long id)", "testcase": false, "constructor": false}, {"identifier": "getSignals", "parameters": "(DemandResponseEvent event)", "modifiers": "public", "return": "List<DemandResponseEventSignal>", "signature": "List<DemandResponseEventSignal> getSignals(DemandResponseEvent event)", "full_signature": "public List<DemandResponseEventSignal> getSignals(DemandResponseEvent event)", "class_method_signature": "DemandResponseEventService.getSignals(DemandResponseEvent event)", "testcase": false, "constructor": false}, {"identifier": "delete", "parameters": "(Long id)", "modifiers": "public", "return": "boolean", "signature": "boolean delete(Long id)", "full_signature": "public boolean delete(Long id)", "class_method_signature": "DemandResponseEventService.delete(Long id)", "testcase": false, "constructor": false}, {"identifier": "delete", "parameters": "(Iterable<DemandResponseEvent> entities)", "modifiers": "public", "return": "void", "signature": "void delete(Iterable<DemandResponseEvent> entities)", "full_signature": "public void delete(Iterable<DemandResponseEvent> entities)", "class_method_signature": "DemandResponseEventService.delete(Iterable<DemandResponseEvent> entities)", "testcase": false, "constructor": false}, {"identifier": "hasResponded", "parameters": "(String venId, DemandResponseEvent event)", "modifiers": "public", "return": "boolean", "signature": "boolean hasResponded(String venId, DemandResponseEvent event)", "full_signature": "public boolean hasResponded(String venId, DemandResponseEvent event)", "class_method_signature": "DemandResponseEventService.hasResponded(String venId, DemandResponseEvent event)", "testcase": false, "constructor": false}, {"identifier": "updateVenDemandResponseEvent", "parameters": "(Long demandResponseEventId, Long modificationNumber, String venUsername,\n\t\t\tDemandResponseEventOptEnum venOpt)", "modifiers": "public", "return": "void", "signature": "void updateVenDemandResponseEvent(Long demandResponseEventId, Long modificationNumber, String venUsername,\n\t\t\tDemandResponseEventOptEnum venOpt)", "full_signature": "public void updateVenDemandResponseEvent(Long demandResponseEventId, Long modificationNumber, String venUsername,\n\t\t\tDemandResponseEventOptEnum venOpt)", "class_method_signature": "DemandResponseEventService.updateVenDemandResponseEvent(Long demandResponseEventId, Long modificationNumber, String venUsername,\n\t\t\tDemandResponseEventOptEnum venOpt)", "testcase": false, "constructor": false}, {"identifier": "getVenDemandResponseEvent", "parameters": "(Long demandResponseEventId, String venUsername)", "modifiers": "public", "return": "VenDemandResponseEvent", "signature": "VenDemandResponseEvent getVenDemandResponseEvent(Long demandResponseEventId, String venUsername)", "full_signature": "public VenDemandResponseEvent getVenDemandResponseEvent(Long demandResponseEventId, String venUsername)", "class_method_signature": "DemandResponseEventService.getVenDemandResponseEvent(Long demandResponseEventId, String venUsername)", "testcase": false, "constructor": false}, {"identifier": "getVenDemandResponseEventOpt", "parameters": "(Long demandResponseEventId, String venUsername)", "modifiers": "public", "return": "DemandResponseEventOptEnum", "signature": "DemandResponseEventOptEnum getVenDemandResponseEventOpt(Long demandResponseEventId, String venUsername)", "full_signature": "public DemandResponseEventOptEnum getVenDemandResponseEventOpt(Long demandResponseEventId, String venUsername)", "class_method_signature": "DemandResponseEventService.getVenDemandResponseEventOpt(Long demandResponseEventId, String venUsername)", "testcase": false, "constructor": false}, {"identifier": "findToSentEventByVenUsername", "parameters": "(String username)", "modifiers": "public", "return": "List<DemandResponseEvent>", "signature": "List<DemandResponseEvent> findToSentEventByVenUsername(String username)", "full_signature": "public List<DemandResponseEvent> findToSentEventByVenUsername(String username)", "class_method_signature": "DemandResponseEventService.findToSentEventByVenUsername(String username)", "testcase": false, "constructor": false}, {"identifier": "findToSentEventByVenUsername", "parameters": "(String username, Long size)", "modifiers": "public", "return": "List<DemandResponseEvent>", "signature": "List<DemandResponseEvent> findToSentEventByVenUsername(String username, Long size)", "full_signature": "public List<DemandResponseEvent> findToSentEventByVenUsername(String username, Long size)", "class_method_signature": "DemandResponseEventService.findToSentEventByVenUsername(String username, Long size)", "testcase": false, "constructor": false}, {"identifier": "getVenDemandResponseEvent", "parameters": "(Long demandResponseEventId)", "modifiers": "public", "return": "List<VenDemandResponseEvent>", "signature": "List<VenDemandResponseEvent> getVenDemandResponseEvent(Long demandResponseEventId)", "full_signature": "public List<VenDemandResponseEvent> getVenDemandResponseEvent(Long demandResponseEventId)", "class_method_signature": "DemandResponseEventService.getVenDemandResponseEvent(Long demandResponseEventId)", "testcase": false, "constructor": false}, {"identifier": "search", "parameters": "(List<DemandResponseEventFilter> filters, Long start, Long end)", "modifiers": "public", "return": "Page<DemandResponseEvent>", "signature": "Page<DemandResponseEvent> search(List<DemandResponseEventFilter> filters, Long start, Long end)", "full_signature": "public Page<DemandResponseEvent> search(List<DemandResponseEventFilter> filters, Long start, Long end)", "class_method_signature": "DemandResponseEventService.search(List<DemandResponseEventFilter> filters, Long start, Long end)", "testcase": false, "constructor": false}, {"identifier": "search", "parameters": "(List<DemandResponseEventFilter> filters, Long start, Long end, Integer page,\n\t\t\tInteger size)", "modifiers": "public", "return": "Page<DemandResponseEvent>", "signature": "Page<DemandResponseEvent> search(List<DemandResponseEventFilter> filters, Long start, Long end, Integer page,\n\t\t\tInteger size)", "full_signature": "public Page<DemandResponseEvent> search(List<DemandResponseEventFilter> filters, Long start, Long end, Integer page,\n\t\t\tInteger size)", "class_method_signature": "DemandResponseEventService.search(List<DemandResponseEventFilter> filters, Long start, Long end, Integer page,\n\t\t\tInteger size)", "testcase": false, "constructor": false}], "file": "OpenADRServerVTNCommon/src/main/java/com/avob/openadr/server/common/vtn/service/DemandResponseEventService.java"}, "focal_method": {"identifier": "update", "parameters": "(DemandResponseEvent event, DemandResponseEventUpdateDto dto)", "modifiers": "@Transactional(readOnly = false) public", "return": "DemandResponseEvent", "body": "@Transactional(readOnly = false)\n\tpublic DemandResponseEvent update(DemandResponseEvent event, DemandResponseEventUpdateDto dto) {\n\n\t\tList<DemandResponseEventTarget> toKeep = new ArrayList<>();\n\t\tList<DemandResponseEventTargetDto> toAdd = new ArrayList<>();\n\t\tfor (DemandResponseEventTargetDto updateTarget : dto.getTargets()) {\n\t\t\tboolean found = false;\n\t\t\tfor (DemandResponseEventTarget target : event.getTargets()) {\n\t\t\t\tif (target.getTargetType().equals(updateTarget.getTargetType())\n\t\t\t\t\t\t&& target.getTargetId().equals(updateTarget.getTargetId())) {\n\t\t\t\t\tfound = true;\n\t\t\t\t\ttoKeep.add(target);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!found) {\n\t\t\t\ttoAdd.add(updateTarget);\n\t\t\t}\n\n\t\t}\n\n\t\tif (!toAdd.isEmpty()) {\n\t\t\tList<VenDemandResponseEvent> list = new ArrayList<>();\n\t\t\tList<Ven> findVenForTarget = findVenForTarget(event, toAdd);\n\t\t\tfor (Ven ven : findVenForTarget) {\n\t\t\t\tlist.add(new VenDemandResponseEvent(event, ven));\n\t\t\t}\n\t\t\tif (!list.isEmpty()) {\n\t\t\t\tvenDemandResponseEventDao.saveAll(list);\n\t\t\t}\n\n\t\t}\n\n\t\tSet<DemandResponseEventTarget> actualSet = new HashSet<DemandResponseEventTarget>(event.getTargets());\n\t\tactualSet.removeAll(toKeep);\n\t\t// unlink removed target\n\t\tif (!actualSet.isEmpty()) {\n\t\t\tList<Ven> vens = findVenForTarget(event, new ArrayList<>(actualSet));\n\t\t\tvenDemandResponseEventDao.deleteByEventIdAndVenIn(event.getId(), vens);\n\t\t}\n\n\t\t// update modification number if event is published\n\t\tif (dto.getPublished()) {\n\t\t\tevent.getDescriptor().setModificationNumber(event.getDescriptor().getModificationNumber() + 1);\n\t\t}\n\n\t\tDemandResponseEvent partialUpdate = dtoMapper.map(dto, DemandResponseEvent.class);\n\t\t// link signals\n\t\tdemandResponseEventSignalDao.deleteAll(event.getSignals());\n\t\tpartialUpdate.getSignals().forEach(sig -> sig.setEvent(event));\n\t\tdemandResponseEventSignalDao.saveAll(partialUpdate.getSignals());\n\n\t\t// update event\n\t\tevent.getSignals().clear();\n\t\tevent.getTargets().clear();\n\t\tevent.getSignals().addAll(partialUpdate.getSignals());\n\t\tevent.getTargets().addAll(partialUpdate.getTargets());\n\t\tevent.setLastUpdateTimestamp(System.currentTimeMillis());\n\t\tevent.setPublished(partialUpdate.isPublished());\n\t\tDemandResponseEvent save = demandResponseEventDao.save(event);\n\n\t\tif (dto.getPublished()) {\n\t\t\tthis.distributeEventToPushVen(event);\n\t\t}\n\n\t\treturn save;\n\t}", "signature": "DemandResponseEvent update(DemandResponseEvent event, DemandResponseEventUpdateDto dto)", "full_signature": "@Transactional(readOnly = false) public DemandResponseEvent update(DemandResponseEvent event, DemandResponseEventUpdateDto dto)", "class_method_signature": "DemandResponseEventService.update(DemandResponseEvent event, DemandResponseEventUpdateDto dto)", "testcase": false, "constructor": false, "invocations": ["getTargets", "getTargets", "equals", "getTargetType", "getTargetType", "equals", "getTargetId", "getTargetId", "add", "add", "isEmpty", "findVenForTarget", "add", "isEmpty", "saveAll", "getTargets", "removeAll", "isEmpty", "findVenForTarget", "deleteByEventIdAndVenIn", "getId", "getPublished", "setModificationNumber", "getDescriptor", "getModificationNumber", "getDescriptor", "map", "deleteAll", "getSignals", "forEach", "getSignals", "setEvent", "saveAll", "getSignals", "clear", "getSignals", "clear", "getTargets", "addAll", "getSignals", "getSignals", "addAll", "getTargets", "getTargets", "setLastUpdateTimestamp", "currentTimeMillis", "setPublished", "isPublished", "save", "getPublished", "distributeEventToPushVen"]}, "repository": {"repo_id": 169761438, "url": "https://github.com/avob/OpenADR", "language": "Java", "is_fork": false, "fork_count": 6, "stargazer_count": 8, "size": 55915, "license": "licensed"}}