{"test_class": {"identifier": "TestThemisScanner", "superclass": "extends ClientTestBase", "interfaces": "", "fields": [], "file": "themis-client/src/test/java/org/apache/hadoop/hbase/themis/TestThemisScanner.java"}, "test_case": {"identifier": "testScanWithEmptyRowLeftAfterLockClean", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n  public void testScanWithEmptyRowLeftAfterLockClean() throws Exception {\n    prepareScanData(new ColumnCoordinate[]{});\n    writeLockAndData(COLUMN_WITH_ANOTHER_ROW, lastTs(prewriteTs));\n    Mockito.when(mockRegister.isWorkerAlive(TestBase.CLIENT_TEST_ADDRESS)).thenReturn(false);\n    ThemisScan pScan = prepareScan(TRANSACTION_COLUMNS);\n    pScan.setCaching(10);\n    ThemisScanner scanner = transaction.getScanner(TABLENAME, pScan);\n    // no rows left after the lock has been cleaned\n    checkAndCloseScanner(scanner);\n    \n    prepareScanData(new ColumnCoordinate[]{COLUMN, COLUMN_WITH_ANOTHER_FAMILY, COLUMN_WITH_ANOTHER_QUALIFIER});\n    writeLockAndData(COLUMN_WITH_ANOTHER_ROW, lastTs(prewriteTs));\n    Mockito.when(mockRegister.isWorkerAlive(TestBase.CLIENT_TEST_ADDRESS)).thenReturn(false);\n    pScan = prepareScan(TRANSACTION_COLUMNS);\n    pScan.setCaching(10);\n    scanner = transaction.getScanner(TABLENAME, pScan);\n    checkResultForROW(scanner.next());\n    checkAndCloseScanner(scanner);\n  }", "signature": "void testScanWithEmptyRowLeftAfterLockClean()", "full_signature": "@Test public void testScanWithEmptyRowLeftAfterLockClean()", "class_method_signature": "TestThemisScanner.testScanWithEmptyRowLeftAfterLockClean()", "testcase": true, "constructor": false, "invocations": ["prepareScanData", "writeLockAndData", "lastTs", "thenReturn", "when", "isWorkerAlive", "prepareScan", "setCaching", "getScanner", "checkAndCloseScanner", "prepareScanData", "writeLockAndData", "lastTs", "thenReturn", "when", "isWorkerAlive", "prepareScan", "setCaching", "getScanner", "checkResultForROW", "next", "checkAndCloseScanner"]}, "focal_class": {"identifier": "ThemisScanner", "superclass": "extends AbstractClientScanner", "interfaces": "", "fields": [{"original_string": "protected final ResultScanner scanner;", "modifier": "protected final", "type": "ResultScanner", "declarator": "scanner", "var_name": "scanner"}, {"original_string": "protected final byte[] tableName;", "modifier": "protected final", "type": "byte[]", "declarator": "tableName", "var_name": "tableName"}, {"original_string": "protected Transaction transaction;", "modifier": "protected", "type": "Transaction", "declarator": "transaction", "var_name": "transaction"}, {"original_string": "protected final Scan scan;", "modifier": "protected final", "type": "Scan", "declarator": "scan", "var_name": "scan"}], "methods": [{"identifier": "ThemisScanner", "parameters": "(final byte[] tableName, final Scan scan, final Transaction transaction)", "modifiers": "public", "return": "", "signature": " ThemisScanner(final byte[] tableName, final Scan scan, final Transaction transaction)", "full_signature": "public  ThemisScanner(final byte[] tableName, final Scan scan, final Transaction transaction)", "class_method_signature": "ThemisScanner.ThemisScanner(final byte[] tableName, final Scan scan, final Transaction transaction)", "testcase": false, "constructor": true}, {"identifier": "setStartTsToScan", "parameters": "(Scan scan, long startTs)", "modifiers": "protected static", "return": "void", "signature": "void setStartTsToScan(Scan scan, long startTs)", "full_signature": "protected static void setStartTsToScan(Scan scan, long startTs)", "class_method_signature": "ThemisScanner.setStartTsToScan(Scan scan, long startTs)", "testcase": false, "constructor": false}, {"identifier": "createGetFromScan", "parameters": "(Scan scan, byte[] rowkey)", "modifiers": "public static", "return": "Get", "signature": "Get createGetFromScan(Scan scan, byte[] rowkey)", "full_signature": "public static Get createGetFromScan(Scan scan, byte[] rowkey)", "class_method_signature": "ThemisScanner.createGetFromScan(Scan scan, byte[] rowkey)", "testcase": false, "constructor": false}, {"identifier": "next", "parameters": "()", "modifiers": "public", "return": "Result", "signature": "Result next()", "full_signature": "public Result next()", "class_method_signature": "ThemisScanner.next()", "testcase": false, "constructor": false}, {"identifier": "close", "parameters": "()", "modifiers": "public", "return": "void", "signature": "void close()", "full_signature": "public void close()", "class_method_signature": "ThemisScanner.close()", "testcase": false, "constructor": false}, {"identifier": "getScan", "parameters": "()", "modifiers": "protected", "return": "Scan", "signature": "Scan getScan()", "full_signature": "protected Scan getScan()", "class_method_signature": "ThemisScanner.getScan()", "testcase": false, "constructor": false}, {"identifier": "next", "parameters": "(int nbRows)", "modifiers": "@Override public", "return": "Result[]", "signature": "Result[] next(int nbRows)", "full_signature": "@Override public Result[] next(int nbRows)", "class_method_signature": "ThemisScanner.next(int nbRows)", "testcase": false, "constructor": false}], "file": "themis-client/src/main/java/org/apache/hadoop/hbase/themis/ThemisScanner.java"}, "focal_method": {"identifier": "next", "parameters": "()", "modifiers": "public", "return": "Result", "body": "public Result next() throws IOException {\n    long beginTs = System.nanoTime();\n    Result pResult = null;\n    boolean lockClean = false;\n    try {\n      pResult = this.scanner.next();\n      if (pResult == null) {\n        return null;\n      }\n\n      // if we encounter conflict locks, we need to clean lock for this row and read again\n      if (ThemisCpUtil.isLockResult(pResult)) {\n        lockClean = true;\n        Get rowGet = createGetFromScan(scan, pResult.getRow());\n        pResult = transaction.tryToCleanLockAndGetAgain(tableName, rowGet, pResult.list());\n        // empty result indicates the current row has been erased, we should get next row\n        if (pResult.isEmpty()) {\n          return next();\n        } else {\n          return pResult;\n        }\n      }\n      return pResult;\n    } finally {\n      ThemisStatistics.updateLatency(ThemisStatistics.getStatistics().nextLatency, beginTs);\n      ThemisStatistics.logSlowOperation(\"themisNext\", beginTs, \"row=\" + pResult + \", lockClean=\" + lockClean);\n    }\n  }", "signature": "Result next()", "full_signature": "public Result next()", "class_method_signature": "ThemisScanner.next()", "testcase": false, "constructor": false, "invocations": ["nanoTime", "next", "isLockResult", "createGetFromScan", "getRow", "tryToCleanLockAndGetAgain", "list", "isEmpty", "next", "updateLatency", "getStatistics", "logSlowOperation"]}, "repository": {"repo_id": 19147361, "url": "https://github.com/XiaoMi/themis", "language": "Java", "is_fork": false, "fork_count": 57, "stargazer_count": 212, "size": 1400, "license": "Apache License 2.0"}}