{"test_class": {"identifier": "TrackedEntityCriteriaMapperTest", "superclass": "extends\n    DhisSpringTest", "interfaces": "", "fields": [{"original_string": "@Autowired\n    private OrganisationUnitService organisationUnitService;", "modifier": "@Autowired\n    private", "type": "OrganisationUnitService", "declarator": "organisationUnitService", "var_name": "organisationUnitService"}, {"original_string": "@Autowired\n    private ProgramService programService;", "modifier": "@Autowired\n    private", "type": "ProgramService", "declarator": "programService", "var_name": "programService"}, {"original_string": "@Autowired\n    private TrackedEntityAttributeService attributeService;", "modifier": "@Autowired\n    private", "type": "TrackedEntityAttributeService", "declarator": "attributeService", "var_name": "attributeService"}, {"original_string": "@Autowired\n    private UserService userService;", "modifier": "@Autowired\n    private", "type": "UserService", "declarator": "userService", "var_name": "userService"}, {"original_string": "@Autowired\n    private TrackedEntityTypeService trackedEntityTypeService;", "modifier": "@Autowired\n    private", "type": "TrackedEntityTypeService", "declarator": "trackedEntityTypeService", "var_name": "trackedEntityTypeService"}, {"original_string": "@Autowired\n    private TrackedEntityCriteriaMapper trackedEntityCriteriaMapper;", "modifier": "@Autowired\n    private", "type": "TrackedEntityCriteriaMapper", "declarator": "trackedEntityCriteriaMapper", "var_name": "trackedEntityCriteriaMapper"}, {"original_string": "private Program programA;", "modifier": "private", "type": "Program", "declarator": "programA", "var_name": "programA"}, {"original_string": "private OrganisationUnit organisationUnit;", "modifier": "private", "type": "OrganisationUnit", "declarator": "organisationUnit", "var_name": "organisationUnit"}, {"original_string": "private TrackedEntityType trackedEntityTypeA = createTrackedEntityType( 'A' );", "modifier": "private", "type": "TrackedEntityType", "declarator": "trackedEntityTypeA = createTrackedEntityType( 'A' )", "var_name": "trackedEntityTypeA"}, {"original_string": "private TrackedEntityAttribute attrD = createTrackedEntityAttribute( 'D' );", "modifier": "private", "type": "TrackedEntityAttribute", "declarator": "attrD = createTrackedEntityAttribute( 'D' )", "var_name": "attrD"}, {"original_string": "private TrackedEntityAttribute attrE = createTrackedEntityAttribute( 'E' );", "modifier": "private", "type": "TrackedEntityAttribute", "declarator": "attrE = createTrackedEntityAttribute( 'E' )", "var_name": "attrE"}, {"original_string": "private TrackedEntityAttribute filtF = createTrackedEntityAttribute( 'F' );", "modifier": "private", "type": "TrackedEntityAttribute", "declarator": "filtF = createTrackedEntityAttribute( 'F' )", "var_name": "filtF"}, {"original_string": "private TrackedEntityAttribute filtG = createTrackedEntityAttribute( 'G' );", "modifier": "private", "type": "TrackedEntityAttribute", "declarator": "filtG = createTrackedEntityAttribute( 'G' )", "var_name": "filtG"}, {"original_string": "@Rule\n    public ExpectedException exception = ExpectedException.none();", "modifier": "@Rule\n    public", "type": "ExpectedException", "declarator": "exception = ExpectedException.none()", "var_name": "exception"}], "file": "dhis-2/dhis-web/dhis-web-api/src/test/java/org/hisp/dhis/webapi/controller/event/mapper/TrackedEntityCriteriaMapperTest.java"}, "test_case": {"identifier": "verifyCriteriaMappingFailOnUserNonInOuHierarchy", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void verifyCriteriaMappingFailOnUserNonInOuHierarchy()\n    {\n        exception.expect( IllegalQueryException.class );\n        exception.expectMessage( \"Organisation unit is not part of the search scope: \" + organisationUnit.getUid() );\n\n        // Force Current User Service to return a User without search org unit\n        ReflectionTestUtils.setField( trackedEntityCriteriaMapper, \"currentUserService\",\n            new MockCurrentUserService( createUser( \"testUser2\" ) ) );\n        TrackedEntityInstanceCriteria criteria = new TrackedEntityInstanceCriteria();\n        criteria.setOu( organisationUnit.getUid() );\n\n        trackedEntityCriteriaMapper.map( criteria );\n    }", "signature": "void verifyCriteriaMappingFailOnUserNonInOuHierarchy()", "full_signature": "@Test public void verifyCriteriaMappingFailOnUserNonInOuHierarchy()", "class_method_signature": "TrackedEntityCriteriaMapperTest.verifyCriteriaMappingFailOnUserNonInOuHierarchy()", "testcase": true, "constructor": false, "invocations": ["expect", "expectMessage", "getUid", "setField", "createUser", "setOu", "getUid", "map"]}, "focal_class": {"identifier": "TrackedEntityCriteriaMapper", "superclass": "", "interfaces": "", "fields": [{"original_string": "private final CurrentUserService currentUserService;", "modifier": "private final", "type": "CurrentUserService", "declarator": "currentUserService", "var_name": "currentUserService"}, {"original_string": "private final OrganisationUnitService organisationUnitService;", "modifier": "private final", "type": "OrganisationUnitService", "declarator": "organisationUnitService", "var_name": "organisationUnitService"}, {"original_string": "private final ProgramService programService;", "modifier": "private final", "type": "ProgramService", "declarator": "programService", "var_name": "programService"}, {"original_string": "private final TrackedEntityTypeService trackedEntityTypeService;", "modifier": "private final", "type": "TrackedEntityTypeService", "declarator": "trackedEntityTypeService", "var_name": "trackedEntityTypeService"}, {"original_string": "private final TrackedEntityAttributeService attributeService;", "modifier": "private final", "type": "TrackedEntityAttributeService", "declarator": "attributeService", "var_name": "attributeService"}], "methods": [{"identifier": "TrackedEntityCriteriaMapper", "parameters": "( CurrentUserService currentUserService,\n        OrganisationUnitService organisationUnitService, ProgramService programService,\n        TrackedEntityAttributeService attributeService, TrackedEntityTypeService trackedEntityTypeService )", "modifiers": "public", "return": "", "signature": " TrackedEntityCriteriaMapper( CurrentUserService currentUserService,\n        OrganisationUnitService organisationUnitService, ProgramService programService,\n        TrackedEntityAttributeService attributeService, TrackedEntityTypeService trackedEntityTypeService )", "full_signature": "public  TrackedEntityCriteriaMapper( CurrentUserService currentUserService,\n        OrganisationUnitService organisationUnitService, ProgramService programService,\n        TrackedEntityAttributeService attributeService, TrackedEntityTypeService trackedEntityTypeService )", "class_method_signature": "TrackedEntityCriteriaMapper.TrackedEntityCriteriaMapper( CurrentUserService currentUserService,\n        OrganisationUnitService organisationUnitService, ProgramService programService,\n        TrackedEntityAttributeService attributeService, TrackedEntityTypeService trackedEntityTypeService )", "testcase": false, "constructor": true}, {"identifier": "map", "parameters": "( TrackedEntityInstanceCriteria criteria )", "modifiers": "@Transactional( readOnly = true ) public", "return": "TrackedEntityInstanceQueryParams", "signature": "TrackedEntityInstanceQueryParams map( TrackedEntityInstanceCriteria criteria )", "full_signature": "@Transactional( readOnly = true ) public TrackedEntityInstanceQueryParams map( TrackedEntityInstanceCriteria criteria )", "class_method_signature": "TrackedEntityCriteriaMapper.map( TrackedEntityInstanceCriteria criteria )", "testcase": false, "constructor": false}, {"identifier": "getQueryFilter", "parameters": "( String query )", "modifiers": "private", "return": "QueryFilter", "signature": "QueryFilter getQueryFilter( String query )", "full_signature": "private QueryFilter getQueryFilter( String query )", "class_method_signature": "TrackedEntityCriteriaMapper.getQueryFilter( String query )", "testcase": false, "constructor": false}, {"identifier": "getQueryItem", "parameters": "( String item )", "modifiers": "private", "return": "QueryItem", "signature": "QueryItem getQueryItem( String item )", "full_signature": "private QueryItem getQueryItem( String item )", "class_method_signature": "TrackedEntityCriteriaMapper.getQueryItem( String item )", "testcase": false, "constructor": false}, {"identifier": "getItem", "parameters": "( String item )", "modifiers": "private", "return": "QueryItem", "signature": "QueryItem getItem( String item )", "full_signature": "private QueryItem getItem( String item )", "class_method_signature": "TrackedEntityCriteriaMapper.getItem( String item )", "testcase": false, "constructor": false}, {"identifier": "validateProgram", "parameters": "( TrackedEntityInstanceCriteria criteria )", "modifiers": "private", "return": "Program", "signature": "Program validateProgram( TrackedEntityInstanceCriteria criteria )", "full_signature": "private Program validateProgram( TrackedEntityInstanceCriteria criteria )", "class_method_signature": "TrackedEntityCriteriaMapper.validateProgram( TrackedEntityInstanceCriteria criteria )", "testcase": false, "constructor": false}, {"identifier": "validateProgramStage", "parameters": "( TrackedEntityInstanceCriteria criteria, Program program )", "modifiers": "private", "return": "ProgramStage", "signature": "ProgramStage validateProgramStage( TrackedEntityInstanceCriteria criteria, Program program )", "full_signature": "private ProgramStage validateProgramStage( TrackedEntityInstanceCriteria criteria, Program program )", "class_method_signature": "TrackedEntityCriteriaMapper.validateProgramStage( TrackedEntityInstanceCriteria criteria, Program program )", "testcase": false, "constructor": false}, {"identifier": "validateTrackedEntityType", "parameters": "( TrackedEntityInstanceCriteria criteria )", "modifiers": "private", "return": "TrackedEntityType", "signature": "TrackedEntityType validateTrackedEntityType( TrackedEntityInstanceCriteria criteria )", "full_signature": "private TrackedEntityType validateTrackedEntityType( TrackedEntityInstanceCriteria criteria )", "class_method_signature": "TrackedEntityCriteriaMapper.validateTrackedEntityType( TrackedEntityInstanceCriteria criteria )", "testcase": false, "constructor": false}, {"identifier": "validateAssignedUser", "parameters": "( TrackedEntityInstanceCriteria criteria )", "modifiers": "private", "return": "void", "signature": "void validateAssignedUser( TrackedEntityInstanceCriteria criteria )", "full_signature": "private void validateAssignedUser( TrackedEntityInstanceCriteria criteria )", "class_method_signature": "TrackedEntityCriteriaMapper.validateAssignedUser( TrackedEntityInstanceCriteria criteria )", "testcase": false, "constructor": false}, {"identifier": "getOrderParams", "parameters": "( TrackedEntityInstanceCriteria criteria )", "modifiers": "private", "return": "List<String>", "signature": "List<String> getOrderParams( TrackedEntityInstanceCriteria criteria )", "full_signature": "private List<String> getOrderParams( TrackedEntityInstanceCriteria criteria )", "class_method_signature": "TrackedEntityCriteriaMapper.getOrderParams( TrackedEntityInstanceCriteria criteria )", "testcase": false, "constructor": false}, {"identifier": "getProgramStageFromProgram", "parameters": "( Program program, String programStage )", "modifiers": "private", "return": "ProgramStage", "signature": "ProgramStage getProgramStageFromProgram( Program program, String programStage )", "full_signature": "private ProgramStage getProgramStageFromProgram( Program program, String programStage )", "class_method_signature": "TrackedEntityCriteriaMapper.getProgramStageFromProgram( Program program, String programStage )", "testcase": false, "constructor": false}], "file": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/event/mapper/TrackedEntityCriteriaMapper.java"}, "focal_method": {"identifier": "map", "parameters": "( TrackedEntityInstanceCriteria criteria )", "modifiers": "@Transactional( readOnly = true ) public", "return": "TrackedEntityInstanceQueryParams", "body": "@Transactional( readOnly = true )\n    public TrackedEntityInstanceQueryParams map( TrackedEntityInstanceCriteria criteria )\n    {\n        TrackedEntityInstanceQueryParams params = new TrackedEntityInstanceQueryParams();\n\n        final Date programEnrollmentStartDate = ObjectUtils.firstNonNull( criteria.getProgramEnrollmentStartDate(),\n            criteria.getProgramStartDate() );\n\n        final Date programEnrollmentEndDate = ObjectUtils.firstNonNull( criteria.getProgramEnrollmentEndDate(),\n            criteria.getProgramEndDate() );\n\n        Set<OrganisationUnit> possibleSearchOrgUnits = new HashSet<>();\n\n        User user = currentUserService.getCurrentUser();\n\n        if ( user != null )\n        {\n            possibleSearchOrgUnits = user.getTeiSearchOrganisationUnitsWithFallback();\n        }\n\n        QueryFilter queryFilter = getQueryFilter( criteria.getQuery() );\n\n        if ( criteria.getAttribute() != null )\n        {\n            for ( String attr : criteria.getAttribute() )\n            {\n                QueryItem it = getQueryItem( attr );\n\n                params.getAttributes().add( it );\n            }\n        }\n\n        if ( criteria.getFilter() != null )\n        {\n            for ( String filt : criteria.getFilter() )\n            {\n                QueryItem it = getQueryItem( filt );\n\n                params.getFilters().add( it );\n            }\n        }\n\n        for ( String orgUnit : criteria.getOrgUnits() )\n        {\n            OrganisationUnit organisationUnit = organisationUnitService.getOrganisationUnit( orgUnit );\n\n            if ( organisationUnit == null )\n            {\n                throw new IllegalQueryException( \"Organisation unit does not exist: \" + orgUnit );\n            }\n\n            if ( !organisationUnitService.isInUserHierarchy( organisationUnit.getUid(), possibleSearchOrgUnits ) )\n            {\n                throw new IllegalQueryException( \"Organisation unit is not part of the search scope: \" + orgUnit );\n            }\n\n            params.getOrganisationUnits().add( organisationUnit );\n        }\n\n        validateAssignedUser( criteria );\n\n        if ( criteria.getOuMode() == OrganisationUnitSelectionMode.CAPTURE && user != null )\n        {\n            params.getOrganisationUnits().addAll( user.getOrganisationUnits() );\n        }\n        Program program = validateProgram( criteria );\n        params.setQuery( queryFilter )\n            .setProgram( program )\n            .setProgramStage( validateProgramStage( criteria, program) )\n            .setProgramStatus( criteria.getProgramStatus() )\n            .setFollowUp( criteria.getFollowUp() )\n            .setLastUpdatedStartDate( criteria.getLastUpdatedStartDate() )\n            .setLastUpdatedEndDate( criteria.getLastUpdatedEndDate() )\n            .setLastUpdatedDuration( criteria.getLastUpdatedDuration() )\n            .setProgramEnrollmentStartDate( programEnrollmentStartDate )\n            .setProgramEnrollmentEndDate( programEnrollmentEndDate )\n            .setProgramIncidentStartDate( criteria.getProgramIncidentStartDate() )\n            .setProgramIncidentEndDate( criteria.getProgramIncidentEndDate() )\n            .setTrackedEntityType( validateTrackedEntityType( criteria ) )\n            .setOrganisationUnitMode( criteria.getOuMode() )\n            .setEventStatus( criteria.getEventStatus() )\n            .setEventStartDate( criteria.getEventStartDate() )\n            .setEventEndDate( criteria.getEventEndDate() )\n            .setAssignedUserSelectionMode( criteria.getAssignedUserMode() )\n            .setAssignedUsers( criteria.getAssignedUsers() )\n            .setSkipMeta( criteria.isSkipMeta() )\n            .setPage( criteria.getPage() )\n            .setPageSize( criteria.getPageSize() )\n            .setTotalPages( criteria.isTotalPages() )\n            .setSkipPaging( PagerUtils.isSkipPaging( criteria.getSkipPaging(), criteria.getPaging() ) )\n            .setIncludeDeleted( criteria.isIncludeDeleted() )\n            .setIncludeAllAttributes( criteria.isIncludeAllAttributes() )\n            .setUser( user )\n            .setOrders( getOrderParams( criteria ) );\n\n        return params;\n\n    }", "signature": "TrackedEntityInstanceQueryParams map( TrackedEntityInstanceCriteria criteria )", "full_signature": "@Transactional( readOnly = true ) public TrackedEntityInstanceQueryParams map( TrackedEntityInstanceCriteria criteria )", "class_method_signature": "TrackedEntityCriteriaMapper.map( TrackedEntityInstanceCriteria criteria )", "testcase": false, "constructor": false, "invocations": ["firstNonNull", "getProgramEnrollmentStartDate", "getProgramStartDate", "firstNonNull", "getProgramEnrollmentEndDate", "getProgramEndDate", "getCurrentUser", "getTeiSearchOrganisationUnitsWithFallback", "getQueryFilter", "getQuery", "getAttribute", "getAttribute", "getQueryItem", "add", "getAttributes", "getFilter", "getFilter", "getQueryItem", "add", "getFilters", "getOrgUnits", "getOrganisationUnit", "isInUserHierarchy", "getUid", "add", "getOrganisationUnits", "validateAssignedUser", "getOuMode", "addAll", "getOrganisationUnits", "getOrganisationUnits", "validateProgram", "setOrders", "setUser", "setIncludeAllAttributes", "setIncludeDeleted", "setSkipPaging", "setTotalPages", "setPageSize", "setPage", "setSkipMeta", "setAssignedUsers", "setAssignedUserSelectionMode", "setEventEndDate", "setEventStartDate", "setEventStatus", "setOrganisationUnitMode", "setTrackedEntityType", "setProgramIncidentEndDate", "setProgramIncidentStartDate", "setProgramEnrollmentEndDate", "setProgramEnrollmentStartDate", "setLastUpdatedDuration", "setLastUpdatedEndDate", "setLastUpdatedStartDate", "setFollowUp", "setProgramStatus", "setProgramStage", "setProgram", "setQuery", "validateProgramStage", "getProgramStatus", "getFollowUp", "getLastUpdatedStartDate", "getLastUpdatedEndDate", "getLastUpdatedDuration", "getProgramIncidentStartDate", "getProgramIncidentEndDate", "validateTrackedEntityType", "getOuMode", "getEventStatus", "getEventStartDate", "getEventEndDate", "getAssignedUserMode", "getAssignedUsers", "isSkipMeta", "getPage", "getPageSize", "isTotalPages", "isSkipPaging", "getSkipPaging", "getPaging", "isIncludeDeleted", "isIncludeAllAttributes", "getOrderParams"]}, "repository": {"repo_id": 66940520, "url": "https://github.com/dhis2/dhis2-core", "stars": 151, "created": "8/30/2016 12:57:05 PM +00:00", "updates": "2020-01-24T18:06:36+00:00", "fork": "False", "license": "licensed"}}