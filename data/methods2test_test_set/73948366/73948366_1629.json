{"test_class": {"identifier": "PutGroupMembershipNotificationTaskTest", "superclass": "", "interfaces": "", "fields": [], "file": "servers/zms/src/test/java/com/yahoo/athenz/zms/notification/PutGroupMembershipNotificationTaskTest.java"}, "test_case": {"identifier": "testGenerateAndSendPostPutGroupMembershipNotificationNotifyGroups", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void testGenerateAndSendPostPutGroupMembershipNotificationNotifyGroups() {\n        DBService dbsvc = Mockito.mock(DBService.class);\n        NotificationService mockNotificationService =  Mockito.mock(NotificationService.class);\n        NotificationServiceFactory testfact = () -> mockNotificationService;\n        NotificationManager notificationManager = getNotificationManager(dbsvc, testfact);\n        notificationManager.shutdown();\n        Map<String, String> details = new HashMap<>();\n        details.put(\"domain\", \"testdomain1\");\n        details.put(\"group\", \"group1\");\n\n        List<RoleMember> roleMembers = new ArrayList<>();\n        RoleMember rm = new RoleMember().setMemberName(\"user.domapprover1\").setActive(true);\n        roleMembers.add(rm);\n\n        rm = new RoleMember().setMemberName(\"user.domapprover2\").setActive(true);\n        roleMembers.add(rm);\n\n        rm = new RoleMember().setMemberName(\"dom2.testsvc1\").setActive(true);\n        roleMembers.add(rm);\n\n        Role domainRole = new Role().setName(\"athenz:role.approvers\").setRoleMembers(roleMembers);\n\n        roleMembers = new ArrayList<>();\n        rm = new RoleMember().setMemberName(\"user.approver1\").setActive(true);\n        roleMembers.add(rm);\n\n        rm = new RoleMember().setMemberName(\"user.approver2\").setActive(true);\n        roleMembers.add(rm);\n\n        rm = new RoleMember().setMemberName(\"dom2.testsvc1\").setActive(true);\n        roleMembers.add(rm);\n\n        Role localRole = new Role().setName(\"testdomain1:role.notify\").setRoleMembers(roleMembers);\n\n        List<Role> roles1 = new ArrayList<>();\n        roles1.add(localRole);\n\n        AthenzDomain athenzDomain1 = new AthenzDomain(\"coretech\");\n        athenzDomain1.setRoles(roles1);\n\n        List<Role> roles2 = new ArrayList<>();\n        roles2.add(domainRole);\n\n        AthenzDomain athenzDomain2 = new AthenzDomain(\"athenz\");\n        athenzDomain2.setRoles(roles2);\n\n        Mockito.when(dbsvc.getRolesByDomain(\"testdomain1\")).thenReturn(athenzDomain1.getRoles());\n        Mockito.when(dbsvc.getRolesByDomain(\"athenz\")).thenReturn(athenzDomain2.getRoles());\n\n        ArgumentCaptor<Notification> captor = ArgumentCaptor.forClass(Notification.class);\n\n        Group notifyGroup = new Group().setAuditEnabled(false).setSelfServe(false).setReviewEnabled(true)\n                .setNotifyRoles(\"athenz:role.approvers,notify\");\n        List<Notification> notifications = new PutGroupMembershipNotificationTask(\"testdomain1\", \"neworg\",\n                notifyGroup, details, dbsvc, USER_DOMAIN_PREFIX).getNotifications();\n        notificationManager.sendNotifications(notifications);\n\n        Notification notification = new Notification();\n        notification.addRecipient(\"user.domapprover1\")\n                .addRecipient(\"user.domapprover2\")\n                .addRecipient(\"user.approver1\")\n                .addRecipient(\"user.approver2\");\n        notification.addDetails(\"domain\", \"testdomain1\").addDetails(\"group\", \"group1\");\n        PutGroupMembershipNotificationTask.PutGroupMembershipNotificationToEmailConverter converter =\n                new PutGroupMembershipNotificationTask.PutGroupMembershipNotificationToEmailConverter();\n        notification.setNotificationToEmailConverter(converter);\n        notification.setType(\"group_membership_approval\");\n        Mockito.verify(mockNotificationService, atLeastOnce()).notify(captor.capture());\n        Notification actualNotification = captor.getValue();\n\n        assertEquals(actualNotification, notification);\n        assertEquals(actualNotification, notification);\n    }", "signature": "void testGenerateAndSendPostPutGroupMembershipNotificationNotifyGroups()", "full_signature": "@Test public void testGenerateAndSendPostPutGroupMembershipNotificationNotifyGroups()", "class_method_signature": "PutGroupMembershipNotificationTaskTest.testGenerateAndSendPostPutGroupMembershipNotificationNotifyGroups()", "testcase": true, "constructor": false, "invocations": ["mock", "mock", "getNotificationManager", "shutdown", "put", "put", "setActive", "setMemberName", "add", "setActive", "setMemberName", "add", "setActive", "setMemberName", "add", "setRoleMembers", "setName", "setActive", "setMemberName", "add", "setActive", "setMemberName", "add", "setActive", "setMemberName", "add", "setRoleMembers", "setName", "add", "setRoles", "add", "setRoles", "thenReturn", "when", "getRolesByDomain", "getRoles", "thenReturn", "when", "getRolesByDomain", "getRoles", "forClass", "setNotifyRoles", "setReviewEnabled", "setSelfServe", "setAuditEnabled", "getNotifications", "sendNotifications", "addRecipient", "addRecipient", "addRecipient", "addRecipient", "addDetails", "addDetails", "setNotificationToEmailConverter", "setType", "notify", "verify", "atLeastOnce", "capture", "getValue", "assertEquals", "assertEquals"]}, "focal_class": {"identifier": "PutGroupMembershipNotificationTask", "superclass": "", "interfaces": "implements NotificationTask", "fields": [{"original_string": "final String domain;", "modifier": "final", "type": "String", "declarator": "domain", "var_name": "domain"}, {"original_string": "final String org;", "modifier": "final", "type": "String", "declarator": "org", "var_name": "org"}, {"original_string": "final Group group;", "modifier": "final", "type": "Group", "declarator": "group", "var_name": "group"}, {"original_string": "private final Map<String, String> details;", "modifier": "private final", "type": "Map<String, String>", "declarator": "details", "var_name": "details"}, {"original_string": "private final NotificationCommon notificationCommon;", "modifier": "private final", "type": "NotificationCommon", "declarator": "notificationCommon", "var_name": "notificationCommon"}, {"original_string": "private final static String DESCRIPTION = \"Group Membership Approval Notification\";", "modifier": "private final static", "type": "String", "declarator": "DESCRIPTION = \"Group Membership Approval Notification\"", "var_name": "DESCRIPTION"}, {"original_string": "private final static String NOTIFICATION_TYPE = \"group_membership_approval\";", "modifier": "private final static", "type": "String", "declarator": "NOTIFICATION_TYPE = \"group_membership_approval\"", "var_name": "NOTIFICATION_TYPE"}, {"original_string": "private final PutGroupMembershipNotificationToEmailConverter putGroupMembershipNotificationToEmailConverter;", "modifier": "private final", "type": "PutGroupMembershipNotificationToEmailConverter", "declarator": "putGroupMembershipNotificationToEmailConverter", "var_name": "putGroupMembershipNotificationToEmailConverter"}], "methods": [{"identifier": "PutGroupMembershipNotificationTask", "parameters": "(String domain, String org, Group group, Map<String, String> details, DBService dbService, String userDomainPrefix)", "modifiers": "public", "return": "", "signature": " PutGroupMembershipNotificationTask(String domain, String org, Group group, Map<String, String> details, DBService dbService, String userDomainPrefix)", "full_signature": "public  PutGroupMembershipNotificationTask(String domain, String org, Group group, Map<String, String> details, DBService dbService, String userDomainPrefix)", "class_method_signature": "PutGroupMembershipNotificationTask.PutGroupMembershipNotificationTask(String domain, String org, Group group, Map<String, String> details, DBService dbService, String userDomainPrefix)", "testcase": false, "constructor": true}, {"identifier": "getNotifications", "parameters": "()", "modifiers": "@Override public", "return": "List<Notification>", "signature": "List<Notification> getNotifications()", "full_signature": "@Override public List<Notification> getNotifications()", "class_method_signature": "PutGroupMembershipNotificationTask.getNotifications()", "testcase": false, "constructor": false}, {"identifier": "getDescription", "parameters": "()", "modifiers": "@Override public", "return": "String", "signature": "String getDescription()", "full_signature": "@Override public String getDescription()", "class_method_signature": "PutGroupMembershipNotificationTask.getDescription()", "testcase": false, "constructor": false}], "file": "servers/zms/src/main/java/com/yahoo/athenz/zms/notification/PutGroupMembershipNotificationTask.java"}, "focal_method": {"identifier": "getNotifications", "parameters": "()", "modifiers": "@Override public", "return": "List<Notification>", "body": "@Override\n    public List<Notification> getNotifications() {\n        // we need to generate the appropriate recipients for the notification\n        // there are 2 possible use cases we need to handle here:\n        // a) audit enabled role - we need to add the domain and org roles\n        //          from the sys.auth.audit domain\n        // b) review/self-serve roles - we need to look at the configured\n        //          role list for notification and if not present then default\n        //          to the admin role from the domain\n\n        Set<String> recipients = new HashSet<>();\n        if (group.getAuditEnabled() == Boolean.TRUE) {\n\n            recipients.add(ZMSUtils.roleResourceName(ZMSConsts.SYS_AUTH_AUDIT_BY_DOMAIN, domain));\n            recipients.add(ZMSUtils.roleResourceName(ZMSConsts.SYS_AUTH_AUDIT_BY_ORG, org));\n\n        } else {\n\n            // if we're given a notify role list then we're going\n            // to add those role members to the recipient list\n            // otherwise use the admin role for the domain\n\n            final String notifyRoles = group.getNotifyRoles();\n            if (notifyRoles == null || notifyRoles.isEmpty()) {\n                recipients.add(ZMSUtils.roleResourceName(domain, ZMSConsts.ADMIN_ROLE_NAME));\n            } else {\n                Iterable<String> roleNames = Splitter.on(',')\n                        .omitEmptyStrings()\n                        .trimResults()\n                        .split(notifyRoles);\n\n                for (String roleName : roleNames) {\n                    if (!roleName.contains(AuthorityConsts.ROLE_SEP)) {\n                        recipients.add(ZMSUtils.roleResourceName(domain, roleName));\n                    } else {\n                        recipients.add(roleName);\n                    }\n                }\n            }\n        }\n\n        // create and process our notification\n\n        return Collections.singletonList(notificationCommon.createNotification(\n                recipients,\n                details,\n                putGroupMembershipNotificationToEmailConverter,\n                NOTIFICATION_TYPE));\n    }", "signature": "List<Notification> getNotifications()", "full_signature": "@Override public List<Notification> getNotifications()", "class_method_signature": "PutGroupMembershipNotificationTask.getNotifications()", "testcase": false, "constructor": false, "invocations": ["getAuditEnabled", "add", "roleResourceName", "add", "roleResourceName", "getNotifyRoles", "isEmpty", "add", "roleResourceName", "split", "trimResults", "omitEmptyStrings", "on", "contains", "add", "roleResourceName", "add", "singletonList", "createNotification"]}, "repository": {"repo_id": 73948366, "url": "https://github.com/yahoo/athenz", "stars": 394, "created": "11/16/2016 6:23:08 PM +00:00", "updates": "2020-01-27T15:36:13+00:00", "fork": "False", "license": "licensed"}}