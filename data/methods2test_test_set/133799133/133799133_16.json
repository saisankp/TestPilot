{"test_class": {"identifier": "CvcTlsCheckTest", "superclass": "", "interfaces": "", "fields": [{"original_string": "private static final String CERTIFICATE_VALID = \"certificate valid\";", "modifier": "private static final", "type": "String", "declarator": "CERTIFICATE_VALID = \"certificate valid\"", "var_name": "CERTIFICATE_VALID"}, {"original_string": "private static final String JAVA_IO_TMPDIR = System.getProperty(\"java.io.tmpdir\") + \"/poseidas\";", "modifier": "private static final", "type": "String", "declarator": "JAVA_IO_TMPDIR = System.getProperty(\"java.io.tmpdir\") + \"/poseidas\"", "var_name": "JAVA_IO_TMPDIR"}, {"original_string": "private static String tempDirectory;", "modifier": "private static", "type": "String", "declarator": "tempDirectory", "var_name": "tempDirectory"}], "file": "poseidas/src/test/java/de/governikus/eumw/poseidas/server/idprovider/config/CvcTlsCheckTest.java"}, "test_case": {"identifier": "testCheck", "parameters": "()", "modifiers": "@Test", "return": "void", "body": "@Test\n  void testCheck() throws Exception\n  {\n    tempDirectory = JAVA_IO_TMPDIR + \"-\" + (int)(Math.random() * 1000000);\n    Files.createDirectory(Paths.get(tempDirectory));\n    log.trace(\"Generated random temp dir: {}\", tempDirectory);\n    Path resourceDirectory = Paths.get(\"src\", \"test\", \"resources\");\n    File source = new File(resourceDirectory + \"/POSeIDAS-cvctls.xml\");\n    File dest = new File(tempDirectory + \"/POSeIDAS.xml\");\n    Files.copy(source.toPath(), dest.toPath(), StandardCopyOption.REPLACE_EXISTING);\n    System.setProperty(\"spring.config.additional-location\", Paths.get(tempDirectory).toString());\n\n    TerminalPermissionAO terminalPermission = mock(TerminalPermissionAO.class);\n\n    TerminalPermission tpA = mock(TerminalPermission.class);\n    when(terminalPermission.getTerminalPermission(\"provider_a\")).thenReturn(tpA);\n    when(tpA.getFullCvc()).thenReturn(new TerminalData(Hex.parse(\"7f218201487f4e8201005f290100420e44454553544456314130303030317f494f060a04007f0007020202020386410457dcc1d8e2564196999e929499445cd41d4b98fd4c9cad27c3c8415cf12cddff9a6511410ce0844ad857d227408b509fec6687ab93bdcfc8d6e917baf6eda8d25f201044454553545445524d314130303030317f4c12060904007f00070301020253053c0ff3ffff5f25060106010000045f2406010601000005655e732d060904007f0007030103018020885675b2ab976500e4b836d1d250011d1070c025bc8fd204157960f95b0b5569732d060904007f0007030103028020144969238b6ae406c90f22f1092bb83cc834020128d70b70fca6ca43bdc1d50f5f37403a9f4294b21c6ed37732853da4a538b1b55f68caf70b9b5f74b144869c1818b42f48d281af0963b5e49faa18c9935bf775d0b3e214fd71615d037efcd6af6522\"),\n                                                       Hex.parse(\"3081a6060a04007f00070301030101a1090c07736563756e6574a3140c126549442d5365727665722054657374626564a41a131868747470733a2f2f736f6d652e746573742e75726c2e6465a5130c114356205465726d73206f66205573616765a746314404205c6fcac6857d69b469b8e8e523b656338bdda1ac43dea739e0510c862901d06d042071b89f97689425ccad573f4754d74baafdbb95980d9135605eed4bf29781674c\")));\n\n    TerminalPermission tpB = mock(TerminalPermission.class);\n    when(terminalPermission.getTerminalPermission(\"provider_b\")).thenReturn(tpB);\n    when(tpB.getFullCvc()).thenReturn(new TerminalData(Hex.parse(\"7f218201487f4e8201005f290100420e44454553544456314130303030317f494f060a04007f0007020202020386410457dcc1d8e2564196999e929499445cd41d4b98fd4c9cad27c3c8415cf12cddff9a6511410ce0844ad857d227408b509fec6687ab93bdcfc8d6e917baf6eda8d25f201044454553545445524d314130303030317f4c12060904007f00070301020253053c0ff3ffff5f25060106010000045f2406060000060103655e732d060904007f00070301030180203f8185d7c732cdcc2326a005a3d9188de01629cf0da3eacb380feaf54176c5b2732d060904007f0007030103028020144969238b6ae406c90f22f1092bb83cc834020128d70b70fca6ca43bdc1d50f5f37403a9f4294b21c6ed37732853da4a538b1b55f68caf70b9b5f74b144869c1818b42f48d281af0963b5e49faa18c9935bf775d0b3e214fd71615d037efcd6af6522\"),\n                                                       Hex.parse(\"3081a4060a04007f00070301030101a1090c07736563756e6574a3140c126549442d5365727665722054657374626564a418131668747470733A2F2F6C6F63616C686F73743A38343530a5130c114356205465726d73206f66205573616765a746314404205c6fcac6857d69b469b8e8e523b656338bdda1ac43dea739e0510c862901d06d0420f4bcf457aad98b6e53824d0f8afffe588472bb2f472115aee278717fa619a845\")));\n\n    TerminalPermission tpC = mock(TerminalPermission.class);\n    when(terminalPermission.getTerminalPermission(\"provider_c\")).thenReturn(tpC);\n    when(tpC.getFullCvc()).thenReturn(new TerminalData(Hex.parse(\"7f218201487f4e8201005f290100420e44454553544456314130303030317f494f060a04007f0007020202020386410457dcc1d8e2564196999e929499445cd41d4b98fd4c9cad27c3c8415cf12cddff9a6511410ce0844ad857d227408b509fec6687ab93bdcfc8d6e917baf6eda8d25f201044454553545445524d314130303030317f4c12060904007f00070301020253053c0ff3ffff5f25060600010000045f2406060300060103655e732d060904007f0007030103018020885675b2ab976500e4b836d1d250011d1070c025bc8fd204157960f95b0b5569732d060904007f0007030103028020144969238b6ae406c90f22f1092bb83cc834020128d70b70fca6ca43bdc1d50f5f37403a9f4294b21c6ed37732853da4a538b1b55f68caf70b9b5f74b144869c1818b42f48d281af0963b5e49faa18c9935bf775d0b3e214fd71615d037efcd6af6522\"),\n                                                       Hex.parse(\"3081a6060a04007f00070301030101a1090c07736563756e6574a3140c126549442d5365727665722054657374626564a41a131868747470733a2f2f736f6d652e746573742e75726c2e6465a5130c114356205465726d73206f66205573616765a746314404205c6fcac6857d69b469b8e8e523b656338bdda1ac43dea739e0510c862901d06d042071b89f97689425ccad573f4754d74baafdbb95980d9135605eed4bf29781674c\")));\n\n    TerminalPermission tpD = mock(TerminalPermission.class);\n    when(terminalPermission.getTerminalPermission(\"provider_d\")).thenReturn(tpD);\n    when(tpD.getFullCvc()).thenThrow(IllegalArgumentException.class);\n\n    when(terminalPermission.getTerminalPermission(\"provider_e\")).thenReturn(null);\n\n    // no server running\n    CvcTlsCheck check = new CvcTlsCheck(terminalPermission);\n    CvcTlsCheckResult result = check.check();\n    assertFalse(CERTIFICATE_VALID, result.isServerTlsValid());\n\n    // server running with expired cert\n    ConfigurationProperties.x509CertificatePath(resourceDirectory + \"/localhost_expired.pem\");\n    ConfigurationProperties.privateKeyPath(resourceDirectory + \"/localhost_expired.pkcs8\");\n    ClientAndServer.startClientAndServer(8450);\n    result = check.check();\n    assertFalse(CERTIFICATE_VALID, result.isServerTlsValid());\n\n    // server running with not yet valid cert\n    ConfigurationProperties.x509CertificatePath(resourceDirectory + \"/localhost_notyetvalid.pem\");\n    ConfigurationProperties.privateKeyPath(resourceDirectory + \"/localhost_notyetvalid.pkcs8\");\n    result = check.check();\n    assertFalse(CERTIFICATE_VALID, result.isServerTlsValid());\n\n    // server running with valid cert\n    ConfigurationProperties.x509CertificatePath(resourceDirectory + \"/localhost_valid.pem\");\n    ConfigurationProperties.privateKeyPath(resourceDirectory + \"/localhost_valid.pkcs8\");\n    result = check.check();\n    assertTrue(\"certificate invalid\", result.isServerTlsValid());\n    CvcCheckResults results = result.getProviderCvcChecks().get(\"providerA\");\n    assertTrue(\"CVC not present\", results.isCvcPresent());\n    assertFalse(\"CVC valid\", results.isCvcValidity());\n    assertFalse(\"server URLs match\", results.isCvcUrlMatch());\n    assertFalse(\"TLS cert in CVC\", results.isCvcTlsMatch());\n    results = result.getProviderCvcChecks().get(\"providerB\");\n    assertTrue(\"CVC not present\", results.isCvcPresent());\n    assertTrue(\"CVC invalid\", results.isCvcValidity());\n    assertTrue(\"server URLs do not match\", results.isCvcUrlMatch());\n    assertTrue(\"TLS cert not in CVC\", results.isCvcTlsMatch());\n    results = result.getProviderCvcChecks().get(\"providerC\");\n    assertTrue(\"CVC not present\", results.isCvcPresent());\n    assertFalse(\"CVC valid\", results.isCvcValidity());\n    results = result.getProviderCvcChecks().get(\"providerD\");\n    assertFalse(\"CVC present\", results.isCvcPresent());\n    assertFalse(\"CVC valid\", results.isCvcValidity());\n    assertFalse(\"server URLs match\", results.isCvcUrlMatch());\n    assertFalse(\"TLS cert in CVC\", results.isCvcTlsMatch());\n    results = result.getProviderCvcChecks().get(\"providerE\");\n    assertFalse(\"CVC present\", results.isCvcPresent());\n    assertFalse(\"CVC valid\", results.isCvcValidity());\n    assertFalse(\"server URLs match\", results.isCvcUrlMatch());\n    assertFalse(\"TLS cert in CVC\", results.isCvcTlsMatch());\n  }", "signature": "void testCheck()", "full_signature": "@Test void testCheck()", "class_method_signature": "CvcTlsCheckTest.testCheck()", "testcase": true, "constructor": false, "invocations": ["random", "createDirectory", "get", "trace", "get", "copy", "toPath", "toPath", "setProperty", "toString", "get", "mock", "mock", "thenReturn", "when", "getTerminalPermission", "thenReturn", "when", "getFullCvc", "parse", "parse", "mock", "thenReturn", "when", "getTerminalPermission", "thenReturn", "when", "getFullCvc", "parse", "parse", "mock", "thenReturn", "when", "getTerminalPermission", "thenReturn", "when", "getFullCvc", "parse", "parse", "mock", "thenReturn", "when", "getTerminalPermission", "thenThrow", "when", "getFullCvc", "thenReturn", "when", "getTerminalPermission", "check", "assertFalse", "isServerTlsValid", "x509CertificatePath", "privateKeyPath", "startClientAndServer", "check", "assertFalse", "isServerTlsValid", "x509CertificatePath", "privateKeyPath", "check", "assertFalse", "isServerTlsValid", "x509CertificatePath", "privateKeyPath", "check", "assertTrue", "isServerTlsValid", "get", "getProviderCvcChecks", "assertTrue", "isCvcPresent", "assertFalse", "isCvcValidity", "assertFalse", "isCvcUrlMatch", "assertFalse", "isCvcTlsMatch", "get", "getProviderCvcChecks", "assertTrue", "isCvcPresent", "assertTrue", "isCvcValidity", "assertTrue", "isCvcUrlMatch", "assertTrue", "isCvcTlsMatch", "get", "getProviderCvcChecks", "assertTrue", "isCvcPresent", "assertFalse", "isCvcValidity", "get", "getProviderCvcChecks", "assertFalse", "isCvcPresent", "assertFalse", "isCvcValidity", "assertFalse", "isCvcUrlMatch", "assertFalse", "isCvcTlsMatch", "get", "getProviderCvcChecks", "assertFalse", "isCvcPresent", "assertFalse", "isCvcValidity", "assertFalse", "isCvcUrlMatch", "assertFalse", "isCvcTlsMatch"]}, "focal_class": {"identifier": "CvcTlsCheck", "superclass": "", "interfaces": "", "fields": [{"original_string": "private TerminalPermissionAO facade;", "modifier": "private", "type": "TerminalPermissionAO", "declarator": "facade", "var_name": "facade"}], "methods": [{"identifier": "check", "parameters": "()", "modifiers": "public", "return": "CvcTlsCheckResult", "signature": "CvcTlsCheckResult check()", "full_signature": "public CvcTlsCheckResult check()", "class_method_signature": "CvcTlsCheck.check()", "testcase": false, "constructor": false}, {"identifier": "testCvcTlsMatch", "parameters": "(TerminalData data, Optional<X509Certificate> certificate)", "modifiers": "private static", "return": "boolean", "signature": "boolean testCvcTlsMatch(TerminalData data, Optional<X509Certificate> certificate)", "full_signature": "private static boolean testCvcTlsMatch(TerminalData data, Optional<X509Certificate> certificate)", "class_method_signature": "CvcTlsCheck.testCvcTlsMatch(TerminalData data, Optional<X509Certificate> certificate)", "testcase": false, "constructor": false}, {"identifier": "testCvcUrlMatch", "parameters": "(TerminalData data, String serverUrl)", "modifiers": "private static", "return": "boolean", "signature": "boolean testCvcUrlMatch(TerminalData data, String serverUrl)", "full_signature": "private static boolean testCvcUrlMatch(TerminalData data, String serverUrl)", "class_method_signature": "CvcTlsCheck.testCvcUrlMatch(TerminalData data, String serverUrl)", "testcase": false, "constructor": false}, {"identifier": "getOwnTlsCertificate", "parameters": "(String url)", "modifiers": "private static", "return": "Optional<X509Certificate>", "signature": "Optional<X509Certificate> getOwnTlsCertificate(String url)", "full_signature": "private static Optional<X509Certificate> getOwnTlsCertificate(String url)", "class_method_signature": "CvcTlsCheck.getOwnTlsCertificate(String url)", "testcase": false, "constructor": false}, {"identifier": "getSSLSocketFactory", "parameters": "()", "modifiers": "private static", "return": "SSLSocketFactory", "signature": "SSLSocketFactory getSSLSocketFactory()", "full_signature": "private static SSLSocketFactory getSSLSocketFactory()", "class_method_signature": "CvcTlsCheck.getSSLSocketFactory()", "testcase": false, "constructor": false}, {"identifier": "testTlsValidity", "parameters": "(X509Certificate certificate)", "modifiers": "private static", "return": "boolean", "signature": "boolean testTlsValidity(X509Certificate certificate)", "full_signature": "private static boolean testTlsValidity(X509Certificate certificate)", "class_method_signature": "CvcTlsCheck.testTlsValidity(X509Certificate certificate)", "testcase": false, "constructor": false}, {"identifier": "testCvcExpired", "parameters": "(TerminalData data)", "modifiers": "private static", "return": "boolean", "signature": "boolean testCvcExpired(TerminalData data)", "full_signature": "private static boolean testCvcExpired(TerminalData data)", "class_method_signature": "CvcTlsCheck.testCvcExpired(TerminalData data)", "testcase": false, "constructor": false}], "file": "poseidas/src/main/java/de/governikus/eumw/poseidas/server/idprovider/config/CvcTlsCheck.java"}, "focal_method": {"identifier": "check", "parameters": "()", "modifiers": "public", "return": "CvcTlsCheckResult", "body": "public CvcTlsCheckResult check()\n  {\n    CoreConfigurationDto config = PoseidasConfigurator.getInstance().getCurrentConfig();\n\n    CvcTlsCheckResult resultHolder = new CvcTlsCheckResult();\n    Optional<X509Certificate> certificate = getOwnTlsCertificate(config.getServerUrl());\n\n    // Test TLS Certificates\n    if (certificate.isPresent())\n    {\n      resultHolder.setServerTlsValid(testTlsValidity(certificate.get()));\n    }\n    else\n    {\n      log.warn(\"TLS certificate not found for url {} \", config.getServerUrl());\n    }\n\n    // Check CVCs\n    for ( ServiceProviderDto sp : config.getServiceProvider().values() )\n    {\n      CvcCheckResults cvcResults = new CvcCheckResults();\n      TerminalPermission tp = facade.getTerminalPermission(sp.getEpaConnectorConfiguration().getCVCRefID());\n      if (tp == null)\n      {\n        resultHolder.getProviderCvcChecks().put(sp.getEntityID(), cvcResults);\n        continue;\n      }\n      try\n      {\n        TerminalData data = tp.getFullCvc();\n        cvcResults.setCvcPresent(true);\n        cvcResults.setCvcValidity(testCvcExpired(data));\n        cvcResults.setCvcUrlMatch(testCvcUrlMatch(data, config.getServerUrl()));\n        cvcResults.setCvcTlsMatch(testCvcTlsMatch(data, certificate));\n      }\n      catch (IllegalArgumentException e)\n      {\n        // happens if no cvc in terminalpermission\n      }\n      resultHolder.getProviderCvcChecks().put(sp.getEntityID(), cvcResults);\n    }\n    return resultHolder;\n  }", "signature": "CvcTlsCheckResult check()", "full_signature": "public CvcTlsCheckResult check()", "class_method_signature": "CvcTlsCheck.check()", "testcase": false, "constructor": false, "invocations": ["getCurrentConfig", "getInstance", "getOwnTlsCertificate", "getServerUrl", "isPresent", "setServerTlsValid", "testTlsValidity", "get", "warn", "getServerUrl", "values", "getServiceProvider", "getTerminalPermission", "getCVCRefID", "getEpaConnectorConfiguration", "put", "getProviderCvcChecks", "getEntityID", "getFullCvc", "setCvcPresent", "setCvcValidity", "testCvcExpired", "setCvcUrlMatch", "testCvcUrlMatch", "getServerUrl", "setCvcTlsMatch", "testCvcTlsMatch", "put", "getProviderCvcChecks", "getEntityID"]}, "repository": {"repo_id": 133799133, "url": "https://github.com/Governikus/eidas-middleware", "language": "Java", "is_fork": false, "fork_count": 11, "stargazer_count": 15, "size": 2286, "license": "licensed"}}