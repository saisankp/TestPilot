{"test_class": {"identifier": "DataValueCheckTest", "superclass": "extends BaseValidationTest", "interfaces": "", "fields": [{"original_string": "private DataValueCheck rule;", "modifier": "private", "type": "DataValueCheck", "declarator": "rule", "var_name": "rule"}, {"original_string": "private ProgramStage programStageA;", "modifier": "private", "type": "ProgramStage", "declarator": "programStageA", "var_name": "programStageA"}], "file": "dhis-2/dhis-services/dhis-service-dxf2/src/test/java/org/hisp/dhis/dxf2/events/importer/shared/validation/DataValueCheckTest.java"}, "test_case": {"identifier": "verifyValidationFailOnJsonSerializationError", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void verifyValidationFailOnJsonSerializationError()\n        throws JsonProcessingException\n    {\n        ObjectMapper localObjectMapper = mock( ObjectMapper.class );\n\n        when( serviceDelegator.getJsonMapper() ).thenReturn( localObjectMapper );\n        when( localObjectMapper.writeValueAsString( Mockito.any() ) )\n            .thenThrow( new JsonProcessingException( \"Error\" )\n            {\n            } );\n\n        event.setProgramStage( \"prgstg1\" );\n        DataElement de1 = addToDataElementMap( createDataElement( 'A' ) );\n\n        final Program programA = createProgram( 'A' );\n        final ProgramStage programStageA = createProgramStage( 'A', programA );\n        programStageA.setValidationStrategy( ValidationStrategy.ON_UPDATE_AND_INSERT );\n\n        programStageA.setProgramStageDataElements( Sets.newHashSet(\n            createProgramStageDataElement( programStageA, de1, 1, true ) ) );\n\n        when( workContext.getProgramStage( IdScheme.UID, \"prgstg1\" ) ).thenReturn( programStageA );\n\n        addToDataValueMap( event.getUid(),\n            createEventDataValue( de1.getUid(), \"1\" ) );\n\n        DataValue dv1 = createDataValue( de1.getUid(), \"1\" );\n\n        event.setDataValues( Sets.newHashSet( dv1 ) );\n        final ImportSummary summary = rule.check( new ImmutableEvent( event ), this.workContext );\n\n        assertHasError( summary, event, null );\n        assertThat( summary.getConflicts(), hasSize( 1 ) );\n        assertThat( summary.getConflicts().iterator().next().getValue(), is( \"Invalid data value found.\" ) );\n        assertThat( summary.getConflicts().iterator().next().getObject(), is( de1.getUid() ) );\n    }", "signature": "void verifyValidationFailOnJsonSerializationError()", "full_signature": "@Test public void verifyValidationFailOnJsonSerializationError()", "class_method_signature": "DataValueCheckTest.verifyValidationFailOnJsonSerializationError()", "testcase": true, "constructor": false, "invocations": ["mock", "thenReturn", "when", "getJsonMapper", "thenThrow", "when", "writeValueAsString", "any", "setProgramStage", "addToDataElementMap", "createDataElement", "createProgram", "createProgramStage", "setValidationStrategy", "setProgramStageDataElements", "newHashSet", "createProgramStageDataElement", "thenReturn", "when", "getProgramStage", "addToDataValueMap", "getUid", "createEventDataValue", "getUid", "createDataValue", "getUid", "setDataValues", "newHashSet", "check", "assertHasError", "assertThat", "getConflicts", "hasSize", "assertThat", "getValue", "next", "iterator", "getConflicts", "is", "assertThat", "getObject", "next", "iterator", "getConflicts", "is", "getUid"]}, "focal_class": {"identifier": "DataValueCheck", "superclass": "", "interfaces": "implements Checker", "fields": [], "methods": [{"identifier": "check", "parameters": "( ImmutableEvent event, WorkContext ctx )", "modifiers": "@Override public", "return": "ImportSummary", "signature": "ImportSummary check( ImmutableEvent event, WorkContext ctx )", "full_signature": "@Override public ImportSummary check( ImmutableEvent event, WorkContext ctx )", "class_method_signature": "DataValueCheck.check( ImmutableEvent event, WorkContext ctx )", "testcase": false, "constructor": false}, {"identifier": "validateMandatoryAttributes", "parameters": "( ImportSummary importSummary, WorkContext ctx,\n        ImmutableEvent event )", "modifiers": "public", "return": "void", "signature": "void validateMandatoryAttributes( ImportSummary importSummary, WorkContext ctx,\n        ImmutableEvent event )", "full_signature": "public void validateMandatoryAttributes( ImportSummary importSummary, WorkContext ctx,\n        ImmutableEvent event )", "class_method_signature": "DataValueCheck.validateMandatoryAttributes( ImportSummary importSummary, WorkContext ctx,\n        ImmutableEvent event )", "testcase": false, "constructor": false}, {"identifier": "checkSerializeToJson", "parameters": "( ImportSummary importSummary, WorkContext ctx, DataValue dataValue )", "modifiers": "private", "return": "boolean", "signature": "boolean checkSerializeToJson( ImportSummary importSummary, WorkContext ctx, DataValue dataValue )", "full_signature": "private boolean checkSerializeToJson( ImportSummary importSummary, WorkContext ctx, DataValue dataValue )", "class_method_signature": "DataValueCheck.checkSerializeToJson( ImportSummary importSummary, WorkContext ctx, DataValue dataValue )", "testcase": false, "constructor": false}, {"identifier": "checkHasValidDataElement", "parameters": "( ImportSummary importSummary, WorkContext ctx, DataValue dataValue )", "modifiers": "private", "return": "boolean", "signature": "boolean checkHasValidDataElement( ImportSummary importSummary, WorkContext ctx, DataValue dataValue )", "full_signature": "private boolean checkHasValidDataElement( ImportSummary importSummary, WorkContext ctx, DataValue dataValue )", "class_method_signature": "DataValueCheck.checkHasValidDataElement( ImportSummary importSummary, WorkContext ctx, DataValue dataValue )", "testcase": false, "constructor": false}, {"identifier": "isValidationRequired", "parameters": "( ImmutableEvent event, WorkContext ctx )", "modifiers": "private", "return": "boolean", "signature": "boolean isValidationRequired( ImmutableEvent event, WorkContext ctx )", "full_signature": "private boolean isValidationRequired( ImmutableEvent event, WorkContext ctx )", "class_method_signature": "DataValueCheck.isValidationRequired( ImmutableEvent event, WorkContext ctx )", "testcase": false, "constructor": false}, {"identifier": "doValidationOfMandatoryAttributes", "parameters": "( User user )", "modifiers": "private", "return": "boolean", "signature": "boolean doValidationOfMandatoryAttributes( User user )", "full_signature": "private boolean doValidationOfMandatoryAttributes( User user )", "class_method_signature": "DataValueCheck.doValidationOfMandatoryAttributes( User user )", "testcase": false, "constructor": false}, {"identifier": "getValidationStrategy", "parameters": "( WorkContext ctx, ImmutableEvent event )", "modifiers": "private", "return": "ValidationStrategy", "signature": "ValidationStrategy getValidationStrategy( WorkContext ctx, ImmutableEvent event )", "full_signature": "private ValidationStrategy getValidationStrategy( WorkContext ctx, ImmutableEvent event )", "class_method_signature": "DataValueCheck.getValidationStrategy( WorkContext ctx, ImmutableEvent event )", "testcase": false, "constructor": false}], "file": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/importer/shared/validation/DataValueCheck.java"}, "focal_method": {"identifier": "check", "parameters": "( ImmutableEvent event, WorkContext ctx )", "modifiers": "@Override public", "return": "ImportSummary", "body": "@Override\n    public ImportSummary check( ImmutableEvent event, WorkContext ctx )\n    {\n        final Set<DataValue> dataValues = event.getDataValues();\n        final ImportSummary importSummary = new ImportSummary();\n        final User user = ctx.getImportOptions().getUser();\n\n        for ( DataValue dataValue : dataValues )\n        {\n            if ( !checkHasValidDataElement( importSummary, ctx, dataValue )\n                || !checkSerializeToJson( importSummary, ctx, dataValue ) )\n            {\n                importSummary.setStatus( ImportStatus.ERROR );\n                importSummary.setReference( event.getUid() );\n                importSummary.incrementIgnored();\n\n                return importSummary;\n            }\n        }\n\n        if ( importSummary.getConflicts().isEmpty() )\n        {\n            if ( doValidationOfMandatoryAttributes( user ) && isValidationRequired( event, ctx ) )\n            {\n                validateMandatoryAttributes( importSummary, ctx, event );\n            }\n        }\n\n        if ( !importSummary.getConflicts().isEmpty() )\n        {\n            importSummary.setStatus( ImportStatus.ERROR );\n            importSummary.setReference( event.getUid() );\n            importSummary.incrementIgnored();\n        }\n\n        return importSummary;\n    }", "signature": "ImportSummary check( ImmutableEvent event, WorkContext ctx )", "full_signature": "@Override public ImportSummary check( ImmutableEvent event, WorkContext ctx )", "class_method_signature": "DataValueCheck.check( ImmutableEvent event, WorkContext ctx )", "testcase": false, "constructor": false, "invocations": ["getDataValues", "getUser", "getImportOptions", "checkHasValidDataElement", "checkSerializeToJson", "setStatus", "setReference", "getUid", "incrementIgnored", "isEmpty", "getConflicts", "doValidationOfMandatoryAttributes", "isValidationRequired", "validateMandatoryAttributes", "isEmpty", "getConflicts", "setStatus", "setReference", "getUid", "incrementIgnored"]}, "repository": {"repo_id": 66940520, "url": "https://github.com/dhis2/dhis2-core", "stars": 151, "created": "8/30/2016 12:57:05 PM +00:00", "updates": "2020-01-24T18:06:36+00:00", "fork": "False", "license": "licensed"}}