{"test_class": {"identifier": "ClassificationEvaluationUtilTest", "superclass": "", "interfaces": "", "fields": [{"original_string": "@Rule\n    public ExpectedException thrown = ExpectedException.none();", "modifier": "@Rule\n    public", "type": "ExpectedException", "declarator": "thrown = ExpectedException.none()", "var_name": "thrown"}], "file": "core/src/test/java/com/alibaba/alink/operator/common/evaluation/ClassificationEvaluationUtilTest.java"}, "test_case": {"identifier": "updateAccurateBinaryMetricsSummaryTest", "parameters": "()", "modifiers": "@Test public", "return": "void", "body": "@Test\n    public void updateAccurateBinaryMetricsSummaryTest() {\n        long[] countValues = new long[] {0, 0, 3, 2};\n        Row[] rows =\n            new Row[] {\n                Row.of(\"prefix1\", \"{\\\"prefix1\\\": 0.9, \\\"prefix0\\\": 0.1}\"),\n                Row.of(\"prefix1\", \"{\\\"prefix1\\\": 0.8, \\\"prefix0\\\": 0.2}\"),\n                Row.of(\"prefix1\", \"{\\\"prefix1\\\": 0.7, \\\"prefix0\\\": 0.3}\"),\n                Row.of(\"prefix0\", \"{\\\"prefix1\\\": 0.75, \\\"prefix0\\\": 0.25}\"),\n                Row.of(\"prefix0\", \"{\\\"prefix1\\\": 0.6, \\\"prefix0\\\": 0.4}\")\n            };\n\n        Object[] labels = new Object[] {\"prefix1\", \"prefix0\"};\n        TypeInformation labelType = Types.STRING;\n        AccurateBinaryMetricsSummary summary = new AccurateBinaryMetricsSummary(labels, 0.0, 0L, 0.);\n        double[] tprFprPrecision = new double[ClassificationEvaluationUtil.RECORD_LEN];\n        List<Tuple3<Double, Boolean, Double>> list = new ArrayList<>();\n        for (Row row : rows) {\n            list.add(ClassificationEvaluationUtil.getBinaryDetailStatistics(row, labels,\n                labelType));\n        }\n        Collections.sort(list, Comparator.comparingDouble(t -> -t.f0));\n        list.forEach(t -> ClassificationEvaluationUtil.updateAccurateBinaryMetricsSummary(t, summary, countValues,\n            tprFprPrecision, true));\n\n        BinaryClassMetrics summary1 = (BinaryClassMetrics)getDetailStatistics(Arrays.asList(rows), null, true, Types.STRING).toMetrics();\n        BinaryClassMetrics summary2 = summary.toMetrics();\n        Assert.assertEquals(summary1.getTotalSamples(), summary2.getTotalSamples());\n        //Assert.assertEquals(summary1.getAuc(), summary2.getAuc());\n        Assert.assertEquals(summary1.getKs(), summary2.getKs());\n        Assert.assertEquals(summary1.getPrc(), summary2.getPrc());\n        Assert.assertEquals(summary1.getGini(), summary2.getGini());\n    }", "signature": "void updateAccurateBinaryMetricsSummaryTest()", "full_signature": "@Test public void updateAccurateBinaryMetricsSummaryTest()", "class_method_signature": "ClassificationEvaluationUtilTest.updateAccurateBinaryMetricsSummaryTest()", "testcase": true, "constructor": false, "invocations": ["of", "of", "of", "of", "of", "add", "getBinaryDetailStatistics", "sort", "comparingDouble", "forEach", "updateAccurateBinaryMetricsSummary", "toMetrics", "getDetailStatistics", "asList", "toMetrics", "assertEquals", "getTotalSamples", "getTotalSamples", "assertEquals", "getKs", "getKs", "assertEquals", "getPrc", "getPrc", "assertEquals", "getGini", "getGini"]}, "focal_class": {"identifier": "ClassificationEvaluationUtil", "superclass": "", "interfaces": "implements Serializable", "fields": [{"original_string": "static final String STATISTICS_OUTPUT = \"Statistics\";", "modifier": "static final", "type": "String", "declarator": "STATISTICS_OUTPUT = \"Statistics\"", "var_name": "STATISTICS_OUTPUT"}, {"original_string": "static final Tuple2<String, Integer> WINDOW = Tuple2.of(\"window\", 0);", "modifier": "static final", "type": "Tuple2<String, Integer>", "declarator": "WINDOW = Tuple2.of(\"window\", 0)", "var_name": "WINDOW"}, {"original_string": "static final Tuple2<String, Integer> ALL = Tuple2.of(\"all\", 1);", "modifier": "static final", "type": "Tuple2<String, Integer>", "declarator": "ALL = Tuple2.of(\"all\", 1)", "var_name": "ALL"}, {"original_string": "public static int DETAIL_BIN_NUMBER = 100000;", "modifier": "public static", "type": "int", "declarator": "DETAIL_BIN_NUMBER = 100000", "var_name": "DETAIL_BIN_NUMBER"}, {"original_string": "public static int TOTAL_TRUE = 2;", "modifier": "public static", "type": "int", "declarator": "TOTAL_TRUE = 2", "var_name": "TOTAL_TRUE"}, {"original_string": "public static int TOTAL_FALSE = 3;", "modifier": "public static", "type": "int", "declarator": "TOTAL_FALSE = 3", "var_name": "TOTAL_FALSE"}, {"original_string": "public static int CUR_TRUE = 0;", "modifier": "public static", "type": "int", "declarator": "CUR_TRUE = 0", "var_name": "CUR_TRUE"}, {"original_string": "public static int CUR_FALSE = 1;", "modifier": "public static", "type": "int", "declarator": "CUR_FALSE = 1", "var_name": "CUR_FALSE"}, {"original_string": "private static int TPR = 0;", "modifier": "private static", "type": "int", "declarator": "TPR = 0", "var_name": "TPR"}, {"original_string": "private static int FPR = 1;", "modifier": "private static", "type": "int", "declarator": "FPR = 1", "var_name": "FPR"}, {"original_string": "private static int PRECISION = 2;", "modifier": "private static", "type": "int", "declarator": "PRECISION = 2", "var_name": "PRECISION"}, {"original_string": "private static int POSITIVE_RATE = 3;", "modifier": "private static", "type": "int", "declarator": "POSITIVE_RATE = 3", "var_name": "POSITIVE_RATE"}, {"original_string": "public static int RECORD_LEN = 4;", "modifier": "public static", "type": "int", "declarator": "RECORD_LEN = 4", "var_name": "RECORD_LEN"}, {"original_string": "private static double PROBABILITY_ERROR = 0.001;", "modifier": "private static", "type": "double", "declarator": "PROBABILITY_ERROR = 0.001", "var_name": "PROBABILITY_ERROR"}, {"original_string": "public static int BINARY_LABEL_NUMBER = 2;", "modifier": "public static", "type": "int", "declarator": "BINARY_LABEL_NUMBER = 2", "var_name": "BINARY_LABEL_NUMBER"}, {"original_string": "public static Tuple3<Double, Boolean, Double> middlePoint = Tuple3.of(0.5, true, Double.NaN);", "modifier": "public static", "type": "Tuple3<Double, Boolean, Double>", "declarator": "middlePoint = Tuple3.of(0.5, true, Double.NaN)", "var_name": "middlePoint"}], "methods": [{"identifier": "getBinaryDetailStatistics", "parameters": "(Row row,\n                                                                            Object[] tuple,\n                                                                            TypeInformation labelType)", "modifiers": "public static", "return": "Tuple3<Double, Boolean, Double>", "signature": "Tuple3<Double, Boolean, Double> getBinaryDetailStatistics(Row row,\n                                                                            Object[] tuple,\n                                                                            TypeInformation labelType)", "full_signature": "public static Tuple3<Double, Boolean, Double> getBinaryDetailStatistics(Row row,\n                                                                            Object[] tuple,\n                                                                            TypeInformation labelType)", "class_method_signature": "ClassificationEvaluationUtil.getBinaryDetailStatistics(Row row,\n                                                                            Object[] tuple,\n                                                                            TypeInformation labelType)", "testcase": false, "constructor": false}, {"identifier": "judgeEvaluationType", "parameters": "(Params params)", "modifiers": "static", "return": "Type", "signature": "Type judgeEvaluationType(Params params)", "full_signature": "static Type judgeEvaluationType(Params params)", "class_method_signature": "ClassificationEvaluationUtil.judgeEvaluationType(Params params)", "testcase": false, "constructor": false}, {"identifier": "buildLabelIndexLabelArray", "parameters": "(HashSet<Object> set,\n                                                                                   boolean binary,\n                                                                                   String positiveValue,\n                                                                                   TypeInformation labelType)", "modifiers": "public static", "return": "Tuple2<Map<Object, Integer>, Object[]>", "signature": "Tuple2<Map<Object, Integer>, Object[]> buildLabelIndexLabelArray(HashSet<Object> set,\n                                                                                   boolean binary,\n                                                                                   String positiveValue,\n                                                                                   TypeInformation labelType)", "full_signature": "public static Tuple2<Map<Object, Integer>, Object[]> buildLabelIndexLabelArray(HashSet<Object> set,\n                                                                                   boolean binary,\n                                                                                   String positiveValue,\n                                                                                   TypeInformation labelType)", "class_method_signature": "ClassificationEvaluationUtil.buildLabelIndexLabelArray(HashSet<Object> set,\n                                                                                   boolean binary,\n                                                                                   String positiveValue,\n                                                                                   TypeInformation labelType)", "testcase": false, "constructor": false}, {"identifier": "frequencyAvgValue", "parameters": "(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                            ConfusionMatrix matrix)", "modifiers": "private static", "return": "double", "signature": "double frequencyAvgValue(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                            ConfusionMatrix matrix)", "full_signature": "private static double frequencyAvgValue(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                            ConfusionMatrix matrix)", "class_method_signature": "ClassificationEvaluationUtil.frequencyAvgValue(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                            ConfusionMatrix matrix)", "testcase": false, "constructor": false}, {"identifier": "macroAvgValue", "parameters": "(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                        ConfusionMatrix matrix)", "modifiers": "private static", "return": "double", "signature": "double macroAvgValue(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                        ConfusionMatrix matrix)", "full_signature": "private static double macroAvgValue(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                        ConfusionMatrix matrix)", "class_method_signature": "ClassificationEvaluationUtil.macroAvgValue(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                        ConfusionMatrix matrix)", "testcase": false, "constructor": false}, {"identifier": "microAvgValue", "parameters": "(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                        ConfusionMatrix matrix)", "modifiers": "private static", "return": "double", "signature": "double microAvgValue(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                        ConfusionMatrix matrix)", "full_signature": "private static double microAvgValue(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                        ConfusionMatrix matrix)", "class_method_signature": "ClassificationEvaluationUtil.microAvgValue(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                        ConfusionMatrix matrix)", "testcase": false, "constructor": false}, {"identifier": "getAllValues", "parameters": "(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                 ConfusionMatrix matrix)", "modifiers": "static", "return": "double[]", "signature": "double[] getAllValues(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                 ConfusionMatrix matrix)", "full_signature": "static double[] getAllValues(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                 ConfusionMatrix matrix)", "class_method_signature": "ClassificationEvaluationUtil.getAllValues(ClassificationMetricComputers.BaseClassificationMetricComputer computer,\n                                 ConfusionMatrix matrix)", "testcase": false, "constructor": false}, {"identifier": "setLoglossParams", "parameters": "(Params params, double logLoss, long total)", "modifiers": "static", "return": "void", "signature": "void setLoglossParams(Params params, double logLoss, long total)", "full_signature": "static void setLoglossParams(Params params, double logLoss, long total)", "class_method_signature": "ClassificationEvaluationUtil.setLoglossParams(Params params, double logLoss, long total)", "testcase": false, "constructor": false}, {"identifier": "setClassificationCommonParams", "parameters": "(Params params, ConfusionMatrix confusionMatrix, String[] labels)", "modifiers": "static", "return": "void", "signature": "void setClassificationCommonParams(Params params, ConfusionMatrix confusionMatrix, String[] labels)", "full_signature": "static void setClassificationCommonParams(Params params, ConfusionMatrix confusionMatrix, String[] labels)", "class_method_signature": "ClassificationEvaluationUtil.setClassificationCommonParams(Params params, ConfusionMatrix confusionMatrix, String[] labels)", "testcase": false, "constructor": false}, {"identifier": "reduceBinaryPartitionSummary", "parameters": "(List<BinaryPartitionSummary> values, int taskId)", "modifiers": "public static", "return": "Tuple2<Boolean, long[]>", "signature": "Tuple2<Boolean, long[]> reduceBinaryPartitionSummary(List<BinaryPartitionSummary> values, int taskId)", "full_signature": "public static Tuple2<Boolean, long[]> reduceBinaryPartitionSummary(List<BinaryPartitionSummary> values, int taskId)", "class_method_signature": "ClassificationEvaluationUtil.reduceBinaryPartitionSummary(List<BinaryPartitionSummary> values, int taskId)", "testcase": false, "constructor": false}, {"identifier": "isMiddlePoint", "parameters": "(Tuple3<Double, Boolean, Double> t)", "modifiers": "public static", "return": "boolean", "signature": "boolean isMiddlePoint(Tuple3<Double, Boolean, Double> t)", "full_signature": "public static boolean isMiddlePoint(Tuple3<Double, Boolean, Double> t)", "class_method_signature": "ClassificationEvaluationUtil.isMiddlePoint(Tuple3<Double, Boolean, Double> t)", "testcase": false, "constructor": false}, {"identifier": "updateBinaryPartitionSummary", "parameters": "(BinaryPartitionSummary statistics,\n                                                    Tuple3<Double, Boolean, Double> t)", "modifiers": "public static", "return": "void", "signature": "void updateBinaryPartitionSummary(BinaryPartitionSummary statistics,\n                                                    Tuple3<Double, Boolean, Double> t)", "full_signature": "public static void updateBinaryPartitionSummary(BinaryPartitionSummary statistics,\n                                                    Tuple3<Double, Boolean, Double> t)", "class_method_signature": "ClassificationEvaluationUtil.updateBinaryPartitionSummary(BinaryPartitionSummary statistics,\n                                                    Tuple3<Double, Boolean, Double> t)", "testcase": false, "constructor": false}, {"identifier": "updateAccurateBinaryMetricsSummary", "parameters": "(Tuple3<Double, Boolean, Double> cur,\n                                                          AccurateBinaryMetricsSummary binaryMetricsSummary,\n                                                          long[] countValues,\n                                                          double[] recordValues,\n                                                          boolean first)", "modifiers": "public static", "return": "void", "signature": "void updateAccurateBinaryMetricsSummary(Tuple3<Double, Boolean, Double> cur,\n                                                          AccurateBinaryMetricsSummary binaryMetricsSummary,\n                                                          long[] countValues,\n                                                          double[] recordValues,\n                                                          boolean first)", "full_signature": "public static void updateAccurateBinaryMetricsSummary(Tuple3<Double, Boolean, Double> cur,\n                                                          AccurateBinaryMetricsSummary binaryMetricsSummary,\n                                                          long[] countValues,\n                                                          double[] recordValues,\n                                                          boolean first)", "class_method_signature": "ClassificationEvaluationUtil.updateAccurateBinaryMetricsSummary(Tuple3<Double, Boolean, Double> cur,\n                                                          AccurateBinaryMetricsSummary binaryMetricsSummary,\n                                                          long[] countValues,\n                                                          double[] recordValues,\n                                                          boolean first)", "testcase": false, "constructor": false}], "file": "core/src/main/java/com/alibaba/alink/operator/common/evaluation/ClassificationEvaluationUtil.java"}, "focal_method": {"identifier": "updateAccurateBinaryMetricsSummary", "parameters": "(Tuple3<Double, Boolean, Double> cur,\n                                                          AccurateBinaryMetricsSummary binaryMetricsSummary,\n                                                          long[] countValues,\n                                                          double[] recordValues,\n                                                          boolean first)", "modifiers": "public static", "return": "void", "body": "public static void updateAccurateBinaryMetricsSummary(Tuple3<Double, Boolean, Double> cur,\n                                                          AccurateBinaryMetricsSummary binaryMetricsSummary,\n                                                          long[] countValues,\n                                                          double[] recordValues,\n                                                          boolean first) {\n        if(binaryMetricsSummary.total == 0) {\n            recordValues[TPR] = countValues[TOTAL_TRUE] == 0 ? 1.0 : 1.0 * countValues[CUR_TRUE] / countValues[TOTAL_TRUE];\n            recordValues[FPR] = countValues[TOTAL_FALSE] == 0 ? 1.0 : 1.0 * countValues[CUR_FALSE] / countValues[TOTAL_FALSE];\n            recordValues[PRECISION] = countValues[CUR_TRUE] + countValues[CUR_FALSE] == 0 ? 1.0\n                : 1.0 * countValues[CUR_TRUE] / (countValues[CUR_TRUE] + countValues[CUR_FALSE]);\n            recordValues[POSITIVE_RATE] = 1.0 * (countValues[CUR_TRUE] + countValues[CUR_FALSE]) / (countValues[TOTAL_TRUE] + countValues[TOTAL_FALSE]);\n        }\n\n        if(!isMiddlePoint(cur)) {\n            binaryMetricsSummary.total++;\n            binaryMetricsSummary.logLoss += cur.f2;\n            if (cur.f1) {\n                countValues[CUR_TRUE]++;\n            } else {\n                countValues[CUR_FALSE]++;\n            }\n        }\n\n        double threshold = cur.f0;\n        double tpr = countValues[TOTAL_TRUE] == 0 ? 1.0 : 1.0 * countValues[CUR_TRUE] / countValues[TOTAL_TRUE];\n        double fpr = countValues[TOTAL_FALSE] == 0 ? 1.0 : 1.0 * countValues[CUR_FALSE] / countValues[TOTAL_FALSE];\n        double precision = countValues[CUR_TRUE] + countValues[CUR_FALSE] == 0 ? 1.0\n            : 1.0 * countValues[CUR_TRUE] / (countValues[CUR_TRUE] + countValues[CUR_FALSE]);\n        double positiveRate = 1.0 * (countValues[CUR_TRUE] + countValues[CUR_FALSE]) / (countValues[TOTAL_TRUE] + countValues[TOTAL_FALSE]);\n\n        if(binaryMetricsSummary.total == 1 && first){\n            recordValues[PRECISION] = precision;\n            ConfusionMatrix confusionMatrix = new ConfusionMatrix(\n                new long[][] {{0, 0}, {countValues[TOTAL_TRUE], countValues[TOTAL_FALSE]}});\n            binaryMetricsSummary.metricsInfoList.add(Tuple2.of(1.0, confusionMatrix));\n        }\n\n        //binaryMetricsSummary.auc += ((fpr - recordValues[FPR]) * (tpr + recordValues[TPR]) / 2);\n        binaryMetricsSummary.gini += ((positiveRate - recordValues[POSITIVE_RATE]) * (tpr + recordValues[TPR]) / 2);\n        binaryMetricsSummary.prc += ((tpr - recordValues[TPR]) * (precision + recordValues[PRECISION]) / 2);\n        binaryMetricsSummary.ks = Math.max(Math.abs(fpr - tpr), binaryMetricsSummary.ks);\n\n        recordValues[TPR] = tpr;\n        recordValues[FPR] = fpr;\n        recordValues[PRECISION] = precision;\n        recordValues[POSITIVE_RATE] = positiveRate;\n\n        ConfusionMatrix confusionMatrix = new ConfusionMatrix(new long[][] {{countValues[CUR_TRUE], countValues[CUR_FALSE]},\n            {countValues[TOTAL_TRUE] - countValues[CUR_TRUE], countValues[TOTAL_FALSE] - countValues[CUR_FALSE]}});\n\n        //keep the middlePoint(p = 0.5), keep the first point(p = 1.0), then compare the threshold\n        if(binaryMetricsSummary.metricsInfoList.isEmpty() || (binaryMetricsSummary.total == 1 && first) || isMiddlePoint(cur) ||\n            Math.abs(threshold - binaryMetricsSummary.metricsInfoList.get(binaryMetricsSummary.metricsInfoList.size() - 1).f0)\n                >= PROBABILITY_ERROR) {\n            binaryMetricsSummary.metricsInfoList.add(Tuple2.of(threshold, confusionMatrix));\n        }else{\n            Tuple2<Double, ConfusionMatrix> metricsInfo = binaryMetricsSummary.metricsInfoList\n                .get(binaryMetricsSummary.metricsInfoList.size() - 1);\n            metricsInfo.f1 = confusionMatrix;\n        }\n    }", "signature": "void updateAccurateBinaryMetricsSummary(Tuple3<Double, Boolean, Double> cur,\n                                                          AccurateBinaryMetricsSummary binaryMetricsSummary,\n                                                          long[] countValues,\n                                                          double[] recordValues,\n                                                          boolean first)", "full_signature": "public static void updateAccurateBinaryMetricsSummary(Tuple3<Double, Boolean, Double> cur,\n                                                          AccurateBinaryMetricsSummary binaryMetricsSummary,\n                                                          long[] countValues,\n                                                          double[] recordValues,\n                                                          boolean first)", "class_method_signature": "ClassificationEvaluationUtil.updateAccurateBinaryMetricsSummary(Tuple3<Double, Boolean, Double> cur,\n                                                          AccurateBinaryMetricsSummary binaryMetricsSummary,\n                                                          long[] countValues,\n                                                          double[] recordValues,\n                                                          boolean first)", "testcase": false, "constructor": false, "invocations": ["isMiddlePoint", "add", "of", "max", "abs", "isEmpty", "isMiddlePoint", "abs", "get", "size", "add", "of", "get", "size"]}, "repository": {"repo_id": 150938406, "url": "https://github.com/alibaba/Alink", "stars": 1923, "created": "9/30/2018 6:36:11 AM +00:00", "updates": "2020-01-27T10:24:34+00:00", "fork": "False", "license": "licensed"}}